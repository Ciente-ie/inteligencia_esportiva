<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento Integrado de Atletas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .details-section {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .details-section.open {
            max-height: 1000px; /* Adjust as needed */
        }
        .tab-btn {
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        /* Custom styles for load indicators */
        .carga-leve { border-color: #3b82f6; } /* Azul */
        .carga-moderada { border-color: #f59e0b; } /* Amarelo */
        .carga-alta { border-color: #f97316; } /* Laranja */
        .carga-maxima { border-color: #ef4444; } /* Vermelho */

        /* Custom styling for multi-select */
        select[multiple] {
            height: 100px;
            padding: 8px;
        }
         select[multiple] option {
            padding: 4px;
            border-radius: 4px;
        }
         select[multiple] option:checked {
            background-color: #3b82f6;
            color: white;
        }
        #globalLoader {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
        }

    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen">

    <div id="globalLoader" class="fixed inset-0 z-50 flex flex-col items-center justify-center">
        <div class="loader" style="width: 50px; height: 50px;"></div>
        <p id="loaderText" class="mt-4 text-gray-600 font-semibold">Conectando...</p>
    </div>


    <div class="container mx-auto p-4 md:p-8 max-w-7xl flex-grow hidden" id="mainContent">
        <header class="text-center mb-6">
            <div class="flex justify-center items-center gap-6">
                <div id="teamLogoContainer" class="hidden">
                    <img id="teamLogo" src="" alt="Logo da Equipe" class="h-16 w-16 object-contain rounded-full bg-white shadow-md border border-gray-200">
                </div>
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Monitoramento Integrado de Atletas</h1>
                    <p class="text-gray-600 mt-2 text-lg">Analise a prontidão, controle a carga, planeje os treinos e monitore lesões da sua equipe.</p>
                </div>
                 <div class="flex items-center gap-x-4">
                     <div id="authStatusContainer" class="bg-gray-100 p-2 rounded-lg text-sm">
                        <span id="authStatus"></span>
                    </div>
                </div>
            </div>
        </header>

        <div class="mb-6 max-w-sm mx-auto">
             <label for="teamFilterSelect" class="block text-sm font-medium text-gray-700 mb-1 text-center">Selecione a Equipe</label>
             <select id="teamFilterSelect" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <option value="all">Todas as Equipes</option>
             </select>
        </div>


        <div class="mb-8">
            <div class="flex border-b border-gray-200 flex-wrap justify-center">
                <button id="tabDashboardBtn" class="tab-btn active text-lg font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                    Dashboard Geral
                </button>
                <button id="tabProntidaoBtn" class="tab-btn text-lg font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                    Análise de Prontidão
                </button>
                <button id="tabCargaBtn" class="tab-btn text-lg font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                    Controle de Carga
                </button>
                <button id="tabPlanejamentoBtn" class="tab-btn text-lg font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                    Planejamento
                </button>
                <button id="tabLesoesBtn" class="tab-btn text-lg font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                    Lesões
                </button>
                 <button id="tabConfigBtn" class="tab-btn text-lg font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                    Configurações
                </button>
            </div>
        </div>

        <div id="dashboardContent">
            <div class="space-y-10" id="pdf-content-dashboard">
                <div id="dashboardLesoes" class="bg-white p-6 rounded-2xl shadow-md border border-gray-200"></div>
                <div id="dashboardProntidao" class="bg-white p-6 rounded-2xl shadow-md border border-gray-200"></div>
                <div id="dashboardCarga" class="bg-white p-6 rounded-2xl shadow-md border border-gray-200"></div>
                <div id="dashboardPlanejamento" class="bg-white p-6 rounded-2xl shadow-md border border-gray-200"></div>
            </div>
             <div class="text-center mt-8">
                <button id="exportPdfBtnDashboard" class="btn bg-red-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-red-700 transition flex items-center mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path></svg>
                    Exportar Dashboard como PDF
                </button>
            </div>
        </div>

        <div id="prontidaoContent" class="hidden">
             <div class="bg-white p-6 md:p-8 rounded-2xl shadow-md border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-3">1. Prepare seu arquivo de Prontidão</h2>
                        <p class="text-gray-600 mb-4">O arquivo CSV deve ter as colunas abaixo, incluindo o `equipe_id` e `semana_id`.</p>
                        <div class="bg-gray-100 p-4 rounded-lg text-sm text-gray-700 font-mono border">
                            <p><strong class="text-blue-600">equipe_id</strong>,atleta_id,data,<strong class="text-blue-600">semana_id</strong>,qualidade_sono,niveis_stress,fadiga_geral,dor_muscular,hooper_score,salto_horizontal_cm,vfc_rmssd</p>
                        </div>
                         <ul class="mt-4 space-y-2 text-gray-600 text-sm list-disc list-inside">
                             <li>O `semana_id` deve ser consistente (ex: "Sem25", "S26").</li>
                             <li>A análise comparará o dado mais recente de um atleta na semana selecionada com todos os seus dados anteriores.</li>
                        </ul>
                    </div>

                    <div class="mt-6 md:mt-0">
                        <h2 class="text-xl font-semibold text-gray-800 mb-3">2. Importe o arquivo e analise</h2>
                        <div class="flex flex-col items-center justify-center w-full">
                             <label for="csvFileInput" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-10 h-10 mb-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                    <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Clique para carregar</span> ou arraste</p>
                                    <p class="text-xs text-gray-500">Arquivo de Prontidão (.CSV)</p>
                                </div>
                                <input id="csvFileInput" type="file" class="hidden" accept=".csv" />
                            </label>
                            <p id="fileName" class="mt-2 text-sm text-gray-500"></p>
                        </div>
                        <button id="processBtn" class="btn mt-4 w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center justify-center text-lg" disabled>
                            <span id="btnText">Processar e Salvar Prontidão</span>
                            <div id="btnLoader" class="loader hidden ml-3"></div>
                        </button>
                    </div>
                </div>
            </div>
            <div id="resultsSection" class="mt-10 hidden">
                <div id="pdf-content-prontidao">
                    <div id="filterContainerProntidao" class="mb-6"></div>
                    <div id="teamDashboard" class="mb-8"></div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Resultados Individuais de Prontidão</h2>
                         <div class="flex gap-x-2">
                             <button id="clearProntidaoDataBtn" class="btn bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 transition flex items-center text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                                Limpar Dados de Prontidão
                            </button>
                            <button id="exportPdfBtnProntidao" class="btn bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                                Exportar PDF
                            </button>
                         </div>
                    </div>
                    <div id="resultsContainer" class="bg-white rounded-lg shadow-md border overflow-hidden"></div>
                    <div id="legendsProntidao" class="mt-6 text-xs text-gray-500 grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                </div>
            </div>
            <div id="placeholderSectionProntidao" class="mt-10 text-center py-16 px-6 bg-white rounded-lg shadow-md border">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <h3 class="mt-4 text-xl font-semibold text-gray-800">Aguardando dados de Prontidão</h3>
                <p class="mt-1 text-gray-500">Selecione uma equipe ou importe um novo arquivo para começar.</p>
            </div>
        </div>

        <div id="cargaContent" class="hidden">
           <div class="bg-white p-6 md:p-8 rounded-2xl shadow-md border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-3">1. Prepare seu arquivo de Carga</h2>
                        <p class="text-gray-600 mb-4">O arquivo CSV deve ter as colunas abaixo, incluindo o `equipe_id` e `microciclo_id`.</p>
                        <div class="bg-gray-100 p-4 rounded-lg text-sm text-gray-700 font-mono border">
                            <p><strong class="text-blue-600">equipe_id</strong>,atleta_id,data,<strong class="text-blue-600">microciclo_id</strong>,pse_sessao,duracao_sessao_min</p>
                        </div>
                        <ul class="mt-4 space-y-2 text-gray-600 text-sm list-disc list-inside">
                            <li>O `microciclo_id` deve ser consistente (ex: "Sem25", "S26").</li>
                            <li>Para o cálculo do ACWR, forneça dados de pelo menos <strong>4 microciclos</strong> anteriores.</li>
                        </ul>
                    </div>

                    <div class="mt-6 md:mt-0">
                        <h2 class="text-xl font-semibold text-gray-800 mb-3">2. Importe o arquivo e analise</h2>
                         <div class="flex flex-col items-center justify-center w-full">
                             <label for="csvFileInputCarga" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-10 h-10 mb-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                    <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Clique para carregar</span> ou arraste</p>
                                    <p class="text-xs text-gray-500">Arquivo de Carga (.CSV)</p>
                                </div>
                                <input id="csvFileInputCarga" type="file" class="hidden" accept=".csv" />
                            </label>
                            <p id="fileNameCarga" class="mt-2 text-sm text-gray-500"></p>
                        </div>
                        <button id="processBtnCarga" class="btn mt-4 w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center justify-center text-lg" disabled>
                            <span id="btnTextCarga">Processar e Salvar Carga</span>
                            <div id="btnLoaderCarga" class="loader hidden ml-3"></div>
                        </button>
                    </div>
                </div>
            </div>
            <div id="resultsSectionCarga" class="mt-10 hidden">
                 <div id="pdf-content-carga">
                    <div id="filterContainer" class="mb-6"></div>
                    <div id="teamDashboardCarga" class="mb-8"></div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Resultados Individuais de Carga</h2>
                         <div class="flex gap-x-2">
                            <button id="clearCargaDataBtn" class="btn bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 transition flex items-center text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                                Limpar Dados de Carga
                            </button>
                            <button id="exportPdfBtnCarga" class="btn bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                                Exportar PDF
                            </button>
                         </div>
                    </div>
                    <div id="resultsContainerCarga" class="bg-white rounded-lg shadow-md border overflow-hidden"></div>
                    <div id="legendsCarga" class="mt-6 text-xs text-gray-500 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                </div>
            </div>
             <div id="placeholderSectionCarga" class="mt-10 text-center py-16 px-6 bg-white rounded-lg shadow-md border">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <h3 class="mt-4 text-xl font-semibold text-gray-800">Aguardando dados de Carga</h3>
                <p class="mt-1 text-gray-500">Selecione uma equipe ou importe um novo arquivo para começar.</p>
            </div>
        </div>

        <div id="planejamentoContent" class="hidden">
            <div id="filterContainerPlanejamento" class="mb-6">
                 </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-8">
                    <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Cadastrar Treino Físico</h3>
                        <form id="formTreinoFisico" class="space-y-4">
                            <div>
                                <label for="equipeIdFisico" class="block text-sm font-medium text-gray-700 mb-1">ID da Equipe</label>
                                <input type="text" id="equipeIdFisico" class="w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                            </div>
                            <div>
                                <label for="dataTreinoFisico" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                                <input type="date" id="dataTreinoFisico" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                             <div>
                                <label for="semanaIdFisico" class="block text-sm font-medium text-gray-700 mb-1">ID da Semana (ex: Sem25)</label>
                                <input type="text" id="semanaIdFisico" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="objPrincipalFisico" class="block text-sm font-medium text-gray-700 mb-1">Objetivo Principal</label>
                                <select id="objPrincipalFisico" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option>Neuromuscular</option>
                                    <option>Funcional</option>
                                </select>
                            </div>
                             <div>
                                <label for="objSecundarioFisico" class="block text-sm font-medium text-gray-700 mb-1">Objetivo Secundário (segure Ctrl/Cmd para selecionar vários)</label>
                                <select id="objSecundarioFisico" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" multiple>
                                    <option>Força Geral</option><option>Força Máxima</option><option>Força Explosiva</option><option>Força Especial</option><option>Velocidade</option><option>Agilidade</option><option>Resistência Aeróbia</option><option>Resistência Anaeróbia</option><option>Mobilidade</option><option>Flexibilidade</option><option>Físico-Técnico</option><option>Recreativo</option><option>Jogo Treino</option><option>Jogo Oficial</option>
                                </select>
                            </div>
                            <div>
                                <label for="localTreinoFisico" class="block text-sm font-medium text-gray-700 mb-1">Local</label>
                                <select id="localTreinoFisico" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option>Campo</option>
                                    <option>Academia</option>
                                </select>
                            </div>
                            <div>
                                <label for="cargaTreinoFisico" class="block text-sm font-medium text-gray-700 mb-1">Carga</label>
                                <select id="cargaTreinoFisico" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="leve">Leve (0-40%)</option>
                                    <option value="moderada">Moderada (40-70%)</option>
                                    <option value="alta">Alta (70-90%)</option>
                                    <option value="maxima">Máxima (90-100%)</option>
                                </select>
                            </div>
                            <button type="submit" id="submitTreinoFisico" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300" disabled>Adicionar Treino Físico</button>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Cadastrar Treino de Campo</h3>
                        <form id="formTreinoCampo" class="space-y-4">
                            <div>
                                <label for="equipeIdCampo" class="block text-sm font-medium text-gray-700 mb-1">ID da Equipe</label>
                                <input type="text" id="equipeIdCampo" class="w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                            </div>
                           <div>
                                <label for="dataTreinoCampo" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                                <input type="date" id="dataTreinoCampo" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                             <div>
                                <label for="semanaIdCampo" class="block text-sm font-medium text-gray-700 mb-1">ID da Semana (ex: Sem25)</label>
                                <input type="text" id="semanaIdCampo" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="objPrincipalCampo" class="block text-sm font-medium text-gray-700 mb-1">Objetivo Principal</label>
                                <select id="objPrincipalCampo" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option>Técnico</option>
                                    <option>Tático</option>
                                    <option>Jogadas Ensaiadas</option>
                                    <option>Recreativo</option>
                                    <option>Jogo Treino</option>
                                    <option>Jogo Oficial</option>
                                </select>
                            </div>
                             <div>
                                <label for="objSecundarioCampo" class="block text-sm font-medium text-gray-700 mb-1">Objetivo Secundário (segure Ctrl/Cmd para selecionar vários)</label>
                                <select id="objSecundarioCampo" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" multiple>
                                    <option>Fundamentos</option><option>Cruzamentos</option><option>Finalização</option><option>Posse de Bola</option><option>Posicionamento</option><option>Pressão</option><option>Apoio</option><option>Sistema Defensivo</option><option>Sistema Ofensivo</option><option>Jogo</option>
                                </select>
                            </div>
                             <div>
                                <label for="campoTreinoCampo" class="block text-sm font-medium text-gray-700 mb-1">Campo</label>
                                <select id="campoTreinoCampo" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option>Campo Inteiro</option>
                                    <option>Meio-campo</option>
                                    <option>Espaços Reduzidos</option>
                                </select>
                            </div>
                            <div>
                                <label for="cargaTreinoCampo" class="block text-sm font-medium text-gray-700 mb-1">Carga</label>
                                <select id="cargaTreinoCampo" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="leve">Leve (0-40%)</option>
                                    <option value="moderada">Moderada (40-70%)</option>
                                    <option value="alta">Alta (70-90%)</option>
                                    <option value="maxima">Máxima (90-100%)</option>
                                </select>
                            </div>
                             <button type="submit" id="submitTreinoCampo" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300" disabled>Adicionar Treino de Campo</button>
                        </form>
                    </div>
                </div>

                <div class="lg:col-span-2" id="pdf-content-planejamento">
                    </div>
            </div>
        </div>
        
        <div id="lesoesContent" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Registrar Lesão</h3>
                        <form id="formLesao" class="space-y-4">
                            <div>
                                <label for="equipeIdLesao" class="block text-sm font-medium text-gray-700 mb-1">ID da Equipe</label>
                                <input type="text" id="equipeIdLesao" class="w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                            </div>
                            <div>
                                <label for="atletaLesao" class="block text-sm font-medium text-gray-700 mb-1">Atleta</label>
                                <input list="atleta-list-options" type="text" id="atletaLesao" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                                <datalist id="atleta-list-options"></datalist>
                            </div>
                            <div>
                                <label for="lesao" class="block text-sm font-medium text-gray-700 mb-1">Lesão</label>
                                <input type="text" id="lesao" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                             <div>
                                <label for="tratamento" class="block text-sm font-medium text-gray-700 mb-1">Tratamento</label>
                                <textarea id="tratamento" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <div>
                                <label for="statusLesao" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select id="statusLesao" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="nao-liberado">Não Liberado para Treinar</option>
                                    <option value="restricoes">Liberado com Restrições</option>
                                    <option value="liberado">Liberado</option>
                                </select>
                            </div>
                            <button type="submit" id="submitLesao" class="w-full bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-orange-700 transition duration-300" disabled>Registrar Lesão</button>
                        </form>
                    </div>
                </div>
                <div class="lg:col-span-2">
                     <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Atletas Lesionados ou em Transição</h3>
                        <div id="lesoesList" class="space-y-3">
                           </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="configContent" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Cadastrar Nova Equipe</h3>
                    <form id="formNovaEquipe" class="space-y-4">
                        <div>
                            <label for="novaEquipeId" class="block text-sm font-medium text-gray-700 mb-1">ID da Equipe (Nome único)</label>
                            <input type="text" id="novaEquipeId" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                        </div>
                        <div>
                            <label for="novaEquipeLogoUrl" class="block text-sm font-medium text-gray-700 mb-1">URL do Logo</label>
                            <input type="url" id="novaEquipeLogoUrl" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="https://example.com/logo.png">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700">Salvar Nova Equipe</button>
                    </form>
                </div>
                 <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Equipes Cadastradas</h3>
                    <div id="equipesListContainer" class="space-y-4">
                        <p class="text-gray-500">Nenhuma equipe cadastrada ainda.</p>
                    </div>
                 </div>
            </div>
        </div>


    </div>

    <footer class="text-center py-4 text-xs text-gray-400">
        Powered by Ciente - Inteligência Esportiva
    </footer>

    <div id="toast" class="fixed bottom-5 right-5 bg-red-500 text-white py-3 px-6 rounded-lg shadow-xl opacity-0 transition-all duration-300 transform translate-y-10"></div>
    
    <div id="confirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
      <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
            <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <h3 id="modalTitle" class="text-lg leading-6 font-medium text-gray-900 mt-2">Remover Treino</h3>
          <div class="mt-2 px-7 py-3">
            <p id="modalText" class="text-sm text-gray-500"></p>
          </div>
          <div class="items-center px-4 py-3">
            <button id="cancelButton" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md w-full sm:w-auto hover:bg-gray-300">Cancelar</button>
            <button id="confirmButton" class="px-4 py-2 bg-red-500 text-white rounded-md w-full sm:w-auto sm:ml-3 hover:bg-red-600">Confirmar</button>
          </div>
        </div>
      </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp, writeBatch, getDocs, where, setDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCSxaH-QFQbhrCttS-J8KmVN1MXmjXqY1s",
            authDomain: "meu-scout-pro.firebaseapp.com",
            projectId: "meu-scout-pro",
            storageBucket: "meu-scout-pro.appspot.com",
            messagingSenderId: "303977649743",
            appId: "1:303977649743:web:4e81e55c7180390ec97c3a"
        };

        let db, auth;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            showToast("Erro na configuração do Firebase.");
        }

        const treinosFisicosCollection = collection(db, 'treinosFisicos');
        const treinosCampoCollection = collection(db, 'treinosCampo');
        const prontidaoCollection = collection(db, 'prontidaoData');
        const cargaCollection = collection(db, 'cargaData');
        const lesoesCollection = collection(db, 'lesoes');
        const equipesCollection = collection(db, 'equipes');

        const METRIC_NAMES = {
            qualidade_sono: 'Qualidade do Sono', niveis_stress: 'Níveis de Stress', fadiga_geral: 'Fadiga Geral', dor_muscular: 'Dor Muscular',
            hooper_score: 'Pontuação Hooper', salto_horizontal_cm: 'Salto Horizontal', vfc_rmssd: 'VFC (RMSSD)'
        };
        const CARGA_PERCENTUAL = { leve: 40, moderada: 70, alta: 90, maxima: 100 };
        
        let activeCharts = {};
        let fullProntidaoData = [], fullCargaData = [], lesoesData = [], treinosFisicos = [], treinosCampo = [];
        let equipesData = {};
        let athleteMicrocycleData = {};
        let currentUser = null;
        let latestProntidaoData = null, latestCargaData = null;
        let selectedPlanningWeeks = [getWeekId(new Date())];
        let isInitialLoadComplete = false;
        let toastTimeout = null; 
        let selectedTeam = 'all'; 

        const globalLoader = document.getElementById('globalLoader');
        const loaderText = document.getElementById('loaderText');
        const mainContent = document.getElementById('mainContent');
        const authStatus = document.getElementById('authStatus');
        const teamFilterSelect = document.getElementById('teamFilterSelect'); 
        const teamLogoContainer = document.getElementById('teamLogoContainer');
        const teamLogo = document.getElementById('teamLogo');
        
        const tabDashboardBtn = document.getElementById('tabDashboardBtn');
        const tabProntidaoBtn = document.getElementById('tabProntidaoBtn');
        const tabCargaBtn = document.getElementById('tabCargaBtn');
        const tabPlanejamentoBtn = document.getElementById('tabPlanejamentoBtn');
        const tabLesoesBtn = document.getElementById('tabLesoesBtn');
        const tabConfigBtn = document.getElementById('tabConfigBtn');
        
        const dashboardContent = document.getElementById('dashboardContent');
        const prontidaoContent = document.getElementById('prontidaoContent');
        const cargaContent = document.getElementById('cargaContent');
        const planejamentoContent = document.getElementById('planejamentoContent');
        const lesoesContent = document.getElementById('lesoesContent');
        const configContent = document.getElementById('configContent');

        const toast = document.getElementById('toast');
        const confirmModal = document.getElementById('confirmModal');
        const csvFileInput = document.getElementById('csvFileInput');
        const fileNameEl = document.getElementById('fileName');
        const processBtn = document.getElementById('processBtn');
        const btnText = document.getElementById('btnText');
        const btnLoader = document.getElementById('btnLoader');
        const resultsSection = document.getElementById('resultsSection');
        const placeholderSectionProntidao = document.getElementById('placeholderSectionProntidao');
        const filterContainerProntidao = document.getElementById('filterContainerProntidao');
        const teamDashboard = document.getElementById('teamDashboard');
        const resultsContainer = document.getElementById('resultsContainer');
        const exportPdfBtnProntidao = document.getElementById('exportPdfBtnProntidao');
        const legendsProntidao = document.getElementById('legendsProntidao');
        const clearProntidaoDataBtn = document.getElementById('clearProntidaoDataBtn');
        const csvFileInputCarga = document.getElementById('csvFileInputCarga');
        const fileNameCargaEl = document.getElementById('fileNameCarga');
        const processBtnCarga = document.getElementById('processBtnCarga');
        const btnTextCarga = document.getElementById('btnTextCarga');
        const btnLoaderCarga = document.getElementById('btnLoaderCarga');
        const resultsSectionCarga = document.getElementById('resultsSectionCarga');
        const placeholderSectionCarga = document.getElementById('placeholderSectionCarga');
        const filterContainer = document.getElementById('filterContainer');
        const teamDashboardCarga = document.getElementById('teamDashboardCarga');
        const resultsContainerCarga = document.getElementById('resultsContainerCarga');
        const exportPdfBtnCarga = document.getElementById('exportPdfBtnCarga');
        const legendsCarga = document.getElementById('legendsCarga');
        const clearCargaDataBtn = document.getElementById('clearCargaDataBtn');
        const formTreinoFisico = document.getElementById('formTreinoFisico');
        const formTreinoCampo = document.getElementById('formTreinoCampo');
        const submitTreinoFisicoBtn = document.getElementById('submitTreinoFisico');
        const submitTreinoCampoBtn = document.getElementById('submitTreinoCampo');
        const filterContainerPlanejamento = document.getElementById('filterContainerPlanejamento');
        const pdfContentPlanejamento = document.getElementById('pdf-content-planejamento');
        const equipeIdFisicoInput = document.getElementById('equipeIdFisico');
        const equipeIdCampoInput = document.getElementById('equipeIdCampo');
        const formLesao = document.getElementById('formLesao');
        const submitLesaoBtn = document.getElementById('submitLesao');
        const lesoesList = document.getElementById('lesoesList');
        const dashboardLesoes = document.getElementById('dashboardLesoes');
        const equipeIdLesaoInput = document.getElementById('equipeIdLesao');
        const dashboardProntidao = document.getElementById('dashboardProntidao');
        const dashboardCarga = document.getElementById('dashboardCarga');
        const dashboardPlanejamento = document.getElementById('dashboardPlanejamento');
        const exportPdfBtnDashboard = document.getElementById('exportPdfBtnDashboard');
        const formNovaEquipe = document.getElementById('formNovaEquipe');
        const equipesListContainer = document.getElementById('equipesListContainer');
        
        Chart.register(ChartDataLabels);
        const readinessZonePlugin = {
            id: 'readinessZonePlugin',
            beforeDraw: (chart) => {
                const { ctx, chartArea: { top, bottom, left, right }, scales: { y } } = chart;
                if (chart.config.type !== 'line' || !y || !y.getPixelForValue) return;
                const greenZone = y.getPixelForValue(-0.5);
                const yellowZone = y.getPixelForValue(-1.5);
                ctx.save();
                ctx.fillStyle = 'rgba(34, 197, 94, 0.1)';
                ctx.fillRect(left, top, right - left, greenZone - top);
                ctx.fillStyle = 'rgba(245, 158, 11, 0.1)';
                ctx.fillRect(left, greenZone, right - left, yellowZone - greenZone);
                ctx.fillStyle = 'rgba(239, 68, 68, 0.1)';
                ctx.fillRect(left, yellowZone, right - left, bottom - yellowZone);
                ctx.restore();
            }
        };
        Chart.register(readinessZonePlugin);
        Chart.defaults.set('plugins.datalabels', {
            color: '#333', font: { weight: 'bold' },
            formatter: (value, context) => value ? (context.dataset.label.includes('%') ? `${value}%` : Math.round(value * 100) / 100) : null
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authStatus.textContent = 'Conectado';
                authStatus.classList.add('text-green-600', 'font-semibold');
                authStatus.classList.remove('text-red-600');
                if (!isInitialLoadComplete) { loadInitialData(); }
            } else {
                currentUser = null;
                authStatus.textContent = 'Offline';
                authStatus.classList.add('text-red-600', 'font-semibold');
                authStatus.classList.remove('text-green-600');
                loaderText.textContent = "Você está desconectado. Recarregue a página.";
                showToast("Você está desconectado. Os dados não serão salvos ou carregados.");
            }
        });

        signInAnonymously(auth).catch((error) => {
            console.error("Anonymous sign-in failed", error);
            loaderText.textContent = "Falha na autenticação.";
            showToast("Falha na autenticação. Os dados não serão salvos.");
        });

        async function loadInitialData() {
            isInitialLoadComplete = true; 
            loaderText.textContent = 'Carregando dados...';
            try {
                const [prontidaoSnap, cargaSnap, fisicoSnap, campoSnap, lesoesSnap, equipesSnap] = await Promise.all([
                    getDocs(query(prontidaoCollection, orderBy("data", "desc"))),
                    getDocs(query(cargaCollection, orderBy("data", "desc"))),
                    getDocs(query(treinosFisicosCollection, orderBy("date", "asc"))),
                    getDocs(query(treinosCampoCollection, orderBy("date", "asc"))),
                    getDocs(query(lesoesCollection, orderBy("createdAt", "desc"))),
                    getDocs(query(equipesCollection)),
                ]);

                fullProntidaoData = prontidaoSnap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                fullCargaData = cargaSnap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                treinosFisicos = fisicoSnap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                treinosCampo = campoSnap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                lesoesData = lesoesSnap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                equipesSnap.forEach(doc => { equipesData[doc.id] = doc.data(); });
                
                populateTeamFilter(); 
                handleTeamChange();
                renderAllTabs();

                globalLoader.classList.add('hidden');
                mainContent.classList.remove('hidden');

                setupLiveListeners();
            } catch (error) {
                console.error("Error loading initial data:", error);
                loaderText.textContent = "Erro ao carregar os dados.";
                showToast("Erro crítico ao carregar os dados iniciais.");
            }
        }
        
        function setupLiveListeners() {
            onSnapshot(query(treinosFisicosCollection, orderBy("date", "asc")), (snapshot) => {
                treinosFisicos = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                renderPlanningView(); updateDashboardView();
            });
            onSnapshot(query(treinosCampoCollection, orderBy("date", "asc")), (snapshot) => {
                treinosCampo = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                renderPlanningView(); updateDashboardView();
            });
            onSnapshot(query(prontidaoCollection, orderBy("data", "desc")), (snapshot) => {
                fullProntidaoData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                populateTeamFilter(); populateAthleteDatalist(); renderProntidaoTab(); 
            });
            onSnapshot(query(cargaCollection, orderBy("data", "desc")), (snapshot) => {
                fullCargaData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                populateTeamFilter(); populateAthleteDatalist(); renderCargaTab(); 
            });
            onSnapshot(query(lesoesCollection, orderBy("createdAt", "desc")), (snapshot) => {
                lesoesData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                renderLesoesTab(); updateDashboardView();
            });
            onSnapshot(query(equipesCollection), (snapshot) => {
                equipesData = {};
                snapshot.forEach(doc => { equipesData[doc.id] = doc.data(); });
                populateTeamFilter(); handleTeamChange(); renderConfigTab();
            });
        }

        teamFilterSelect.addEventListener('change', (e) => {
            selectedTeam = e.target.value;
            handleTeamChange();
            renderAllTabs();
        });

        function handleTeamChange() {
            const isTeamSelected = selectedTeam !== 'all';
            
            if (isTeamSelected) {
                equipeIdLesaoInput.value = selectedTeam;
                equipeIdFisicoInput.value = selectedTeam;
                equipeIdCampoInput.value = selectedTeam;
                submitLesaoBtn.disabled = !currentUser;
                submitTreinoFisicoBtn.disabled = !currentUser;
                submitTreinoCampoBtn.disabled = !currentUser;

                if (equipesData[selectedTeam]?.logoUrl) {
                    teamLogo.src = equipesData[selectedTeam].logoUrl;
                    teamLogoContainer.classList.remove('hidden');
                } else {
                    teamLogoContainer.classList.add('hidden');
                }
            } else {
                equipeIdLesaoInput.value = 'Selecione uma equipe';
                equipeIdFisicoInput.value = 'Selecione uma equipe';
                equipeIdCampoInput.value = 'Selecione uma equipe';
                submitLesaoBtn.disabled = true;
                submitTreinoFisicoBtn.disabled = true;
                submitTreinoCampoBtn.disabled = true;
                teamLogoContainer.classList.add('hidden');
            }
        }

        tabDashboardBtn.addEventListener('click', () => switchTab('dashboard'));
        tabProntidaoBtn.addEventListener('click', () => switchTab('prontidao'));
        tabCargaBtn.addEventListener('click', () => switchTab('carga'));
        tabPlanejamentoBtn.addEventListener('click', () => switchTab('planejamento'));
        tabLesoesBtn.addEventListener('click', () => switchTab('lesoes'));
        tabConfigBtn.addEventListener('click', () => switchTab('config'));
        
        csvFileInput.addEventListener('change', () => handleFileSelect(csvFileInput, fileNameEl, processBtn));
        processBtn.addEventListener('click', handleFileProcessing);
        exportPdfBtnProntidao.addEventListener('click', () => exportToPDF('prontidao'));
        resultsContainer.addEventListener('click', (e) => toggleDetails(e, 'prontidao'));
        filterContainerProntidao.addEventListener('change', () => renderProntidaoTab());
        clearProntidaoDataBtn.addEventListener('click', clearProntidaoData);

        csvFileInputCarga.addEventListener('change', () => handleFileSelect(csvFileInputCarga, fileNameCargaEl, processBtnCarga));
        processBtnCarga.addEventListener('click', handleFileProcessingCarga);
        exportPdfBtnCarga.addEventListener('click', () => exportToPDF('carga'));
        resultsContainerCarga.addEventListener('click', (e) => toggleDetails(e, 'carga'));
        filterContainer.addEventListener('change', (e) => { if (e.target.classList.contains('microciclo-checkbox')) { renderCargaTab(); } });
        clearCargaDataBtn.addEventListener('click', clearCargaData);
        
        formTreinoFisico.addEventListener('submit', handleFormFisicoSubmit);
        formTreinoCampo.addEventListener('submit', handleFormCampoSubmit);
        formLesao.addEventListener('submit', handleFormLesaoSubmit);
        formNovaEquipe.addEventListener('submit', handleNovaEquipeSubmit);
        
        document.getElementById('dataTreinoFisico').addEventListener('change', (e) => {
            const date = e.target.valueAsDate; if (date) { const utcDate = new Date(date.getTime() + (date.getTimezoneOffset() * 60000)); document.getElementById('semanaIdFisico').value = getWeekId(utcDate) || ''; }
        });
        document.getElementById('dataTreinoCampo').addEventListener('change', (e) => {
            const date = e.target.valueAsDate; if (date) { const utcDate = new Date(date.getTime() + (date.getTimezoneOffset() * 60000)); document.getElementById('semanaIdCampo').value = getWeekId(utcDate) || ''; }
        });

        filterContainerPlanejamento.addEventListener('change', (e) => {
             if (e.target.classList.contains('planning-week-checkbox')) {
                const selectedCheckboxes = document.querySelectorAll('.planning-week-checkbox:checked');
                selectedPlanningWeeks = Array.from(selectedCheckboxes).map(cb => cb.value);
                renderPlanningView(); updateDashboardView();
            }
        });
        exportPdfBtnDashboard.addEventListener('click', () => exportToPDF('dashboard'));
        
        document.getElementById('dataTreinoFisico').valueAsDate = new Date(); document.getElementById('dataTreinoFisico').dispatchEvent(new Event('change'));
        document.getElementById('dataTreinoCampo').valueAsDate = new Date(); document.getElementById('dataTreinoCampo').dispatchEvent(new Event('change'));

        function renderAllTabs() {
            populateAthleteDatalist();
            renderProntidaoTab();
            renderCargaTab();
            renderPlanningView();
            renderLesoesTab();
            renderConfigTab();
            updateDashboardView();
        }

        function switchTab(tab) {
            const contents = { dashboard: dashboardContent, prontidao: prontidaoContent, carga: cargaContent, planejamento: planejamentoContent, lesoes: lesoesContent, config: configContent };
            const buttons = { dashboard: tabDashboardBtn, prontidao: tabProntidaoBtn, carga: tabCargaBtn, planejamento: tabPlanejamentoBtn, lesoes: tabLesoesBtn, config: tabConfigBtn };
            Object.entries(contents).forEach(([key, el]) => el.classList.toggle('hidden', key !== tab));
            Object.entries(buttons).forEach(([key, el]) => el.classList.toggle('active', key === tab));
        }

        // --- ABA DE CONFIGURAÇÕES ---
        function renderConfigTab() {
            if (Object.keys(equipesData).length === 0) {
                equipesListContainer.innerHTML = `<p class="text-gray-500">Nenhuma equipe cadastrada ainda.</p>`;
                return;
            }

            equipesListContainer.innerHTML = Object.entries(equipesData).sort(([a], [b]) => a.localeCompare(b)).map(([equipeId, data]) => `
                <div class="p-4 border rounded-lg">
                    <div class="flex items-center gap-4 mb-3">
                        <img src="${data.logoUrl || 'https://via.placeholder.com/64'}" alt="Logo" class="h-16 w-16 object-contain rounded-full bg-gray-100 border">
                        <h4 class="text-lg font-bold text-gray-800 flex-grow">${equipeId}</h4>
                    </div>
                    <form class="update-equipe-form space-y-2" data-id="${equipeId}">
                        <input type="url" value="${data.logoUrl || ''}" class="w-full p-2 border border-gray-300 rounded-md" placeholder="https://example.com/logo.png">
                        <button type="submit" class="w-full text-sm bg-green-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-green-700">Atualizar</button>
                    </form>
                </div>
            `).join('');

            document.querySelectorAll('.update-equipe-form').forEach(form => form.addEventListener('submit', handleUpdateEquipe));
        }
        
        async function handleNovaEquipeSubmit(e) {
            e.preventDefault();
            const equipeId = document.getElementById('novaEquipeId').value.trim();
            const logoUrl = document.getElementById('novaEquipeLogoUrl').value.trim();
            if (!equipeId) { showToast("O ID da equipe é obrigatório."); return; }
            
            try {
                await setDoc(doc(db, "equipes", equipeId), { logoUrl });
                showToast(`Equipe '${equipeId}' salva com sucesso!`, 'success');
                formNovaEquipe.reset();
            } catch (error) {
                console.error("Erro ao salvar nova equipe:", error);
                showToast("Erro ao salvar a equipe.");
            }
        }

        async function handleUpdateEquipe(e) {
            e.preventDefault();
            const equipeId = e.target.dataset.id;
            const logoUrl = e.target.querySelector('input[type="url"]').value.trim();
            try {
                await setDoc(doc(db, "equipes", equipeId), { logoUrl });
                showToast(`Equipe '${equipeId}' atualizada!`, 'success');
            } catch (error) {
                console.error("Erro ao atualizar equipe:", error);
                showToast("Erro ao atualizar a equipe.");
            }
        }
        
        // --- LÓGICAS DE DADOS (PRONTIDÃO, CARGA, ETC.) ---
        function renderProntidaoTab() {
            const dataForTeam = selectedTeam === 'all' ? fullProntidaoData : fullProntidaoData.filter(d => d.equipe_id === selectedTeam);
            if (dataForTeam.length === 0) {
                placeholderSectionProntidao.classList.remove('hidden');
                resultsSection.classList.add('hidden');
                latestProntidaoData = null; filterContainerProntidao.innerHTML = ''; updateDashboardView(); return;
            }
            renderFilterProntidao(dataForTeam); 
            placeholderSectionProntidao.classList.add('hidden'); resultsSection.classList.remove('hidden');
            
            const selectedCheckboxes = document.querySelectorAll('.week-checkbox:checked');
            let selectedWeeks = Array.from(selectedCheckboxes).map(cb => cb.value);
            if (selectedWeeks.length === 0 && document.querySelectorAll('.week-checkbox').length > 0) {
                 const lastWeekEl = document.querySelector('.week-checkbox:last-of-type');
                 if(lastWeekEl) { lastWeekEl.checked = true; selectedWeeks = [lastWeekEl.value]; }
            }
            selectedWeeks = sortWeeks(selectedWeeks);
            const filteredDataForWeeks = dataForTeam.filter(d => selectedWeeks.includes(d.semana_id));
            if (filteredDataForWeeks.length > 0) {
                displayFilteredProntidaoData(filteredDataForWeeks, selectedWeeks);
            } else {
                teamDashboard.innerHTML = '<p class="text-center text-gray-500">Nenhum dado de prontidão para a(s) semana(s) selecionada(s) nesta equipe.</p>';
                resultsContainer.innerHTML = ''; latestProntidaoData = null;
            }
            updateDashboardView();
        }

        function analyzeProntidaoData(data, selectedWeeks) {
            const athletesData = data.reduce((acc, row) => {
                if (!acc[row.atleta_id]) acc[row.atleta_id] = [];
                acc[row.atleta_id].push(row);
                return acc;
            }, {});
            let latestDateOverall = null;

            const individualResults = Object.keys(athletesData).map(athleteId => {
                const entriesInSelection = athletesData[athleteId];
                if (entriesInSelection.length === 0) return null;
                const latestEntry = entriesInSelection.sort((a, b) => new Date(`${b.data}T00:00:00`) - new Date(`${a.data}T00:00:00`))[0];
                const latestDateInSelection = new Date(`${latestEntry.data}T00:00:00`);
                if (!latestDateOverall || latestDateInSelection > latestDateOverall) { latestDateOverall = latestDateInSelection; }
                const allHistoricalEntriesForAthlete = fullProntidaoData.filter(d => d.atleta_id === athleteId && new Date(`${d.data}T00:00:00`) < latestDateInSelection);
                const result = calculateAthleteReadiness(athleteId, latestEntry, allHistoricalEntriesForAthlete, latestEntry.data);
                const dailyHistoryData = { hooper: [], salto: [] };
                entriesInSelection.sort((a, b) => new Date(`${a.data}T00:00:00`) - new Date(`${b.data}T00:00:00`)).forEach(entry => {
                    if (entry.hooper_score != null) { dailyHistoryData.hooper.push({ date: entry.data, value: entry.hooper_score }); }
                    if (entry.salto_horizontal_cm != null) { dailyHistoryData.salto.push({ date: entry.data, value: entry.salto_horizontal_cm }); }
                });
                if (result) { result.dailyHistory = dailyHistoryData; }
                return result;
            }).filter(Boolean).sort((a, b) => (a.index ?? Infinity) - (b.index ?? Infinity));
            
            const uniqueWeeksSorted = sortWeeks([...new Set(data.map(d => d.semana_id))]);
            const evolutionData = uniqueWeeksSorted.map(weekId => {
                const dataForThisWeek = data.filter(d => d.semana_id === weekId);
                const athletesInWeek = [...new Set(dataForThisWeek.map(d => d.atleta_id))];
                const resultsForThisWeek = athletesInWeek.map(athleteId => {
                    const entriesInWeek = dataForThisWeek.filter(d => d.atleta_id === athleteId);
                    if (entriesInWeek.length === 0) return null;
                    const latestEntryInWeek = entriesInWeek.sort((a,b) => new Date(`${b.data}T00:00:00`) - new Date(`${a.data}T00:00:00`))[0];
                    const historicalEntries = fullProntidaoData.filter(d => d.atleta_id === athleteId && new Date(`${d.data}T00:00:00`) < new Date(`${latestEntryInWeek.data}T00:00:00`));
                    return calculateAthleteReadiness(athleteId, latestEntryInWeek, historicalEntries, latestEntryInWeek.data);
                }).filter(Boolean);
                const readyAthletesThisWeek = resultsForThisWeek.filter(r => r.status === 'ready');
                return {
                    weekId, averageIndex: getStats(readyAthletesThisWeek.map(r => parseFloat(r.index))).mean,
                    averageHooper: getStats(readyAthletesThisWeek.map(r => r.hooperScore.latest)).mean,
                    averageSaltoDiff: getStats(readyAthletesThisWeek.map(r => r.saltoPercentDiff)).mean,
                };
            });

            const readyAthletesOverall = individualResults.filter(r => r.status === 'ready');
            const teamStats = {
                averageIndex: getStats(readyAthletesOverall.map(r => parseFloat(r.index))).mean,
                averageHooper: getStats(readyAthletesOverall.map(r => r.hooperScore.latest)).mean,
                averageSaltoDiff: getStats(readyAthletesOverall.map(r => r.saltoPercentDiff)).mean,
                zoneCounts: individualResults.reduce((acc, r) => { acc[r.zone || 'collecting'] = (acc[r.zone || 'collecting'] || 0) + 1; return acc; }, { green: 0, yellow: 0, red: 0, collecting: 0 }),
                evolutionData
            };
            
            let dailyStats = null;
            if (selectedWeeks.length === 1) {
                dailyStats = analyzeDailyProntidao(data.filter(d => d.semana_id === selectedWeeks[0]));
            }
            
            const latestDate = latestDateOverall ? latestDateOverall.toISOString().split('T')[0] : null;
            return { individualResults, teamStats, latestDate, dailyStats };
        }

        function createProntidaoResultRow(result) {
            if (!result || !result.latestDate) return '';
            if (result.status === 'collecting') return `<div class="flex items-center p-4 border-b"><div class="w-1/3 font-bold text-gray-800">${result.athleteId}</div><div class="w-2/3 text-gray-500 text-sm">${result.message}</div></div>`;
            
            let zoneClass, recommendation, statusText;
            if (result.zone === 'green') { zoneClass = 'text-green-600'; statusText = 'Zona Ótima'; recommendation = "Atleta em bom estado. Treinar conforme o plano."; }
            else if (result.zone === 'yellow') { zoneClass = 'text-yellow-600'; statusText = 'Zona de Atenção'; recommendation = "Sinais de alerta. A carga deve ser ajustada."; }
            else { zoneClass = 'text-red-600'; statusText = 'Zona Crítica'; recommendation = "Risco Elevado. Priorizar recuperação ativa."; }

            const hooperScoreValue = result.hooperScore.latest != null ? result.hooperScore.latest.toFixed(1) : '--';
            const hooperClass = getHooperClassification(result.hooperScore.latest);
            // **AJUSTE VISUAL RECUPERAÇÃO**
            const saltoDisplay = result.saltoPercentDiff != null ? `${result.saltoPercentDiff > 0 ? '+' : ''}${result.saltoPercentDiff.toFixed(1)}%` : '--';
            const saltoClass = result.saltoPercentDiff == null ? 'text-gray-500' : (result.saltoPercentDiff >= 0 ? 'text-green-600' : 'text-red-600');
            
            const detailsHtml = Object.entries(result.metricsDetail).map(([key, data]) => {
                if (!METRIC_NAMES[key] || data.latest == null) return '';
                const latestValue = !isNaN(data.latest) ? data.latest.toFixed(1) : 'N/A';
                const meanValue = !isNaN(data.mean) ? data.mean.toFixed(1) : 'N/A';
                return `<li class="flex justify-between items-center text-sm py-1 border-b"><span class="text-gray-600">${METRIC_NAMES[key]}</span><span class="font-semibold text-gray-800">${latestValue} <span class="text-xs text-gray-500 font-normal">(Média Hist.: ${meanValue})</span></span></li>`;
            }).join('');
            
            const uniqueId = `${result.athleteId}-${result.latestDate.replace(/[^a-zA-Z0-9]/g, "")}`;
            const dailyChartsHtml = (result.dailyHistory && (result.dailyHistory.hooper.length > 0 || result.dailyHistory.salto.length > 0)) ? `
                <div class="mt-4 pt-4 border-t col-span-full grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><h5 class="font-semibold text-xs text-center text-gray-600 mb-1">Hooper Diário (na seleção)</h5><div class="h-40"><canvas id="history-daily-hooper-${uniqueId}"></canvas></div></div>
                    <div><h5 class="font-semibold text-xs text-center text-gray-600 mb-1">Salto Diário (na seleção)</h5><div class="h-40"><canvas id="history-daily-salto-${uniqueId}"></canvas></div></div>
                </div>` : '';

            return `<div class="border-b last:border-b-0">
                <div class="flex items-center p-4">
                    <div class="w-1/3 font-bold text-gray-800">${result.athleteId}<span class="ml-2 text-xs font-normal text-gray-500">${new Date(result.latestDate + 'T00:00:00').toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'})}</span></div>
                    <div class="w-1/6 text-center font-semibold text-2xl ${zoneClass}">${result.index}</div>
                    <div class="w-1/6 text-center"><span class="px-3 py-1 text-xs font-semibold rounded-full ${zoneClass.replace('text-', 'bg-').replace('-600', '-100')}">${statusText}</span></div>
                    <div class="w-1/6 text-center"><span class="font-bold text-lg ${hooperClass.class}">${hooperScoreValue}</span></div>
                    <div class="w-1/6 text-center font-semibold ${saltoClass}">${saltoDisplay}</div>
                    <div class="w-12 text-center">
                        <button class="toggle-details-btn p-1 rounded-full hover:bg-gray-200" data-target="details-prontidao-${uniqueId}" data-daily-history='${result.dailyHistory ? JSON.stringify(result.dailyHistory) : ''}'>
                            <svg class="arrow-icon w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
                <div class="details-section bg-gray-50" id="details-prontidao-${uniqueId}"><div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4"><div><h4 class="font-semibold text-sm mb-2">Detalhes (Valor atual vs. Média Histórica):</h4><ul class="space-y-1">${detailsHtml}</ul></div><div class="bg-blue-50 border p-3 rounded-lg self-start"><h4 class="font-semibold text-sm mb-1">Sugestão:</h4><p class="text-sm">${recommendation}</p></div>${dailyChartsHtml}</div></div>
            </div>`;
        }

        function renderPlanningView() {
            renderPlanningFilter();

            const dataForTeamFisico = selectedTeam === 'all' ? treinosFisicos : treinosFisicos.filter(d => d.equipe_id === selectedTeam);
            const dataForTeamCampo = selectedTeam === 'all' ? treinosCampo : treinosCampo.filter(d => d.equipe_id === selectedTeam);

            const fisicoSemana = dataForTeamFisico.filter(t => selectedPlanningWeeks.includes(t.semana_id));
            const campoSemana = dataForTeamCampo.filter(t => selectedPlanningWeeks.includes(t.semana_id));

            pdfContentPlanejamento.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                         <h3 class="text-2xl font-bold text-gray-900">Treinos Físicos</h3>
                         <div id="timelineFisico" class="p-2 bg-gray-50 rounded-lg min-h-[10rem]"></div>
                         <div class="mt-6 bg-white p-4 rounded-lg shadow-sm border h-64"><canvas id="chartCargaFisico"></canvas></div>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-2xl font-bold text-gray-900">Treinos de Campo</h3>
                        <div id="timelineCampo" class="p-2 bg-gray-50 rounded-lg min-h-[10rem]"></div>
                        <div class="mt-6 bg-white p-4 rounded-lg shadow-sm border h-64"><canvas id="chartCargaCampo"></canvas></div>
                    </div>
                </div>
                <div class="text-center mt-8">
                    <button id="exportPdfBtnPlanejamento" class="btn bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition flex items-center mx-auto">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                        Exportar Planejamento
                    </button>
                </div>
            `;
            
            document.getElementById('exportPdfBtnPlanejamento').addEventListener('click', () => exportToPDF('planejamento'));

            renderTimeline(document.getElementById('timelineFisico'), fisicoSemana, `Nenhum treino físico cadastrado para ${selectedTeam === 'all' ? 'as equipes' : 'esta equipe'} nesta seleção.`);
            renderTimeline(document.getElementById('timelineCampo'), campoSemana, `Nenhum treino de campo cadastrado para ${selectedTeam === 'all' ? 'as equipes' : 'esta equipe'} nesta seleção.`);
            renderDailyLoadChart('chartCargaFisico', fisicoSemana);
            renderDailyLoadChart('chartCargaCampo', campoSemana);
        }

        async function handleFormFisicoSubmit(e) {
            e.preventDefault();
            const equipeId = equipeIdFisicoInput.value;
            if(!equipeId || equipeId === 'Selecione uma equipe') { showToast("Selecione uma equipe para cadastrar o treino."); return; }
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;

            const treino = {
                equipe_id: equipeId, type: 'fisico', date: document.getElementById('dataTreinoFisico').value, semana_id: document.getElementById('semanaIdFisico').value,
                objPrincipal: document.getElementById('objPrincipalFisico').value, objSecundario: getSelectedOptions(document.getElementById('objSecundarioFisico')),
                local: document.getElementById('localTreinoFisico').value, carga: document.getElementById('cargaTreinoFisico').value,
                cargaText: document.getElementById('cargaTreinoFisico').options[document.getElementById('cargaTreinoFisico').selectedIndex].text,
                createdAt: serverTimestamp()
            };
            try {
                await addDoc(treinosFisicosCollection, treino);
                showToast('Treino Físico adicionado!', 'success');
                formTreinoFisico.reset();
                equipeIdFisicoInput.value = equipeId;
                document.getElementById('dataTreinoFisico').valueAsDate = new Date(); document.getElementById('dataTreinoFisico').dispatchEvent(new Event('change'));
            } catch (error) { showToast("Erro ao salvar o treino físico."); } finally { btn.disabled = false; }
        }

        async function handleFormCampoSubmit(e) {
            e.preventDefault();
            const equipeId = equipeIdCampoInput.value;
            if(!equipeId || equipeId === 'Selecione uma equipe') { showToast("Selecione uma equipe para cadastrar o treino."); return; }
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            const treino = {
                equipe_id: equipeId, type: 'campo', date: document.getElementById('dataTreinoCampo').value, semana_id: document.getElementById('semanaIdCampo').value,
                objPrincipal: document.getElementById('objPrincipalCampo').value, objSecundario: getSelectedOptions(document.getElementById('objSecundarioCampo')),
                campo: document.getElementById('campoTreinoCampo').value, carga: document.getElementById('cargaTreinoCampo').value,
                cargaText: document.getElementById('cargaTreinoCampo').options[document.getElementById('cargaTreinoCampo').selectedIndex].text,
                createdAt: serverTimestamp()
            };
            try {
                await addDoc(treinosCampoCollection, treino);
                showToast('Treino de Campo adicionado!', 'success');
                formTreinoCampo.reset();
                equipeIdCampoInput.value = equipeId;
                document.getElementById('dataTreinoCampo').valueAsDate = new Date(); document.getElementById('dataTreinoCampo').dispatchEvent(new Event('change'));
            } catch (error) { showToast("Erro ao salvar o treino de campo."); } finally { btn.disabled = false; }
        }

        // As demais funções (calculateAthleteReadiness, renderização de gráficos, helpers, etc.) permanecem majoritariamente as mesmas.
        // A lógica de filtragem por equipe é aplicada antes de chamar essas funções, garantindo que elas operem no conjunto de dados correto.
        // A função calculateAthleteReadiness foi levemente ajustada para ser mais robusta quando não há dados históricos.
        
        // --- FUNÇÕES HELPER E DE RENDERIZAÇÃO RESTANTES ---
        // (O restante do seu código JS original com as modificações já mostradas nas respostas anteriores)
        // ... (inclui: calculateAthleteReadiness, renderFilterProntidao, renderTeamDashboard*, createLoadResultRow, etc.)
        // A função createProntidaoResultRow foi a única outra função significativamente alterada nesta seção para o ajuste visual.
        // O restante do código JS pode ser colado aqui.

        // Exemplo da função calculateAthleteReadiness ajustada:
        function calculateAthleteReadiness(athleteId, latestEntry, historicalEntries, displayDate) {
            const getZScore = (key, value) => {
                let dataPoints = historicalEntries.map(e => e[key]).filter(v => v != null && !isNaN(v) && v > 0);
                if (dataPoints.length < 2) { 
                    const allAthletePoints = fullProntidaoData.filter(d => d.atleta_id === athleteId && d.data !== displayDate && d[key] != null && !isNaN(d[key]) && d[key] > 0).map(e => e[key]);
                    if (allAthletePoints.length < 2) return 0; // Retorna 0 (neutro) se não houver histórico suficiente em lugar nenhum
                    dataPoints = allAthletePoints;
                }
                if (value == null) return 0;
                const { mean, stdDev } = getStats(dataPoints);
                return stdDev === 0 ? 0 : (value - mean) / stdDev;
            };
            const cap = (val) => Math.max(-2.5, Math.min(2.5, val));
            const saltoValue = latestEntry['salto_horizontal_cm'];
            const vfcValue = latestEntry['vfc_rmssd'];
            const performanceScores = [
                (saltoValue != null && saltoValue > 0) ? getZScore('salto_horizontal_cm', saltoValue) : null,
                (vfcValue != null && vfcValue > 0) ? getZScore('vfc_rmssd', vfcValue) : null
            ].filter(s => s != null);
            const performancePillar = performanceScores.length > 0 ? cap(getStats(performanceScores).mean) : 0;
            let hooperAdjustment = 0;
            if (latestEntry.hooper_score != null) {
                if (latestEntry.hooper_score <= 9) hooperAdjustment = 0.25;
                else if (latestEntry.hooper_score <= 17) hooperAdjustment = -0.25;
                else hooperAdjustment = -0.50;
            }
            const readinessIndex = performancePillar + hooperAdjustment;
            let zone;
            if (readinessIndex < -1.5) zone = 'red';
            else if (readinessIndex < -0.5) zone = 'yellow';
            else zone = 'green';
            const metricsDetail = Object.keys(METRIC_NAMES).reduce((acc, key) => {
                 let dataPoints = historicalEntries.map(e => e[key]).filter(v => v != null && !isNaN(v));
                 let mean = getStats(dataPoints).mean;
                 if (dataPoints.length === 0) {
                     const allOtherEntries = fullProntidaoData.filter(d => d.atleta_id === athleteId && d.data !== displayDate).map(e => e[key]).filter(v => v != null && !isNaN(v));
                     mean = getStats(allOtherEntries).mean;
                 }
                acc[key] = { latest: latestEntry[key], mean: mean };
                return acc;
            }, {});
            const saltoMeanHistorical = metricsDetail.salto_horizontal_cm?.mean || 0;
            const saltoLatest = latestEntry.salto_horizontal_cm;
            const saltoDiff = (saltoLatest && saltoMeanHistorical > 0) ? ((saltoLatest - saltoMeanHistorical) / saltoMeanHistorical) * 100 : null;
            return { 
                athleteId, status: 'ready', index: readinessIndex.toFixed(2), zone, 
                metricsDetail, hooperScore: { latest: latestEntry.hooper_score }, 
                saltoPercentDiff: saltoDiff, latestDate: displayDate 
            };
        }

        // Cole aqui o restante do seu código JavaScript que não foi explicitamente modificado nesta resposta.
        // Incluindo helpers como showToast, getStats, etc., e funções de renderização de gráficos.
    </script>
</body>
</html>
