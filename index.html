<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ciente IE - Plataforma Integrada</title>

  <!-- ‚úÖ Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ‚úÖ Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // --- Configura√ß√£o Firebase ---
    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "appintegrado-ciente.firebaseapp.com",
      projectId: "appintegrado-ciente",
      storageBucket: "appintegrado-ciente.appspot.com",
      messagingSenderId: "XXX",
      appId: "XXX"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // =====================================================
    // üß≠ TROCA DE ABAS
    // =====================================================
    function mostrarAba(aba) {
      document.querySelectorAll(".aba").forEach(div => div.classList.add("hidden"));
      document.querySelector(`#${aba}`).classList.remove("hidden");

      document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("bg-blue-600", "text-white", "shadow"));
      document.querySelector(`[data-aba='${aba}']`).classList.add("bg-blue-600", "text-white", "shadow");
    }

    // =====================================================
// üß© CARREGAR DADOS PRONTID√ÉO (com processamento completo)
// =====================================================
async function carregarProntidao() {
  try {
    const snap = await getDocs(collection(db, "prontidao"));
    const dados = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    // üîπ Normaliza os campos (igual √† aba Prontid√£o)
    dados.forEach(d => {
      d.atleta = d.nome_atleta || d.atleta_id || "Sem nome";
      d.equipe = d.equipe_id || d.equipe || "Sem equipe";
      d.posicao = d.posicao_grupo || "N√£o definida";
      d.data = d.data || "2025-01-01";
      d.sono = parseInt(d.sono || d.qualidade_sono || 0);
      d.estresse = parseInt(d.estresse || d.niveis_stress || 0);
      d.fadiga = parseInt(d.fadiga || d.fadiga_geral || 0);
      d.dor = parseInt(d.dor || d.dor_muscular || 0);
      d.salto = parseFloat(d.salto || 0);
      d.vfc = parseFloat(d.vfc || d.rmssd || 0);
      d.hooper = d.sono + d.estresse + d.fadiga + d.dor;
    });

    // üîπ Agrupa por atleta e calcula varia√ß√µes
    const atletas = {};
    dados.forEach(d => {
      if (!atletas[d.atleta]) atletas[d.atleta] = [];
      atletas[d.atleta].push(d);
    });

    const resumo = [];
    for (const atleta in atletas) {
      const registros = atletas[atleta];
      const medias = calcularMedias(registros);
      const ultimo = registros[0];
      const variacoes = calcularVariacoes(ultimo, medias);
      resumo.push({
        atleta,
        equipe: ultimo.equipe,
        posicao: ultimo.posicao,
        data: ultimo.data,
        hooper: ultimo.hooper,
        ...variacoes
      });
    }

    // üîπ Salva globalmente para o Dashboard
    window.__dadosProntidao = dados;
    window.__dadosResumo = resumo;
    console.log("‚úÖ Prontid√£o carregada com sucesso:", resumo.length, "atletas");
  } catch (e) {
    console.error("Erro ao carregar Prontid√£o:", e);
  }
}

function calcularMedias(registros) {
  const n = registros.length;
  const media = (arr, key) => arr.reduce((a, b) => a + (b[key] || 0), 0) / n;
  return {
    vfc: media(registros, "vfc"),
    salto: media(registros, "salto"),
    hooper: media(registros, "hooper")
  };
}

function calcularVariacoes(ultimo, medias) {
  const vfcPct = ((ultimo.vfc - medias.vfc) / medias.vfc) * 100 || 0;
  const saltoPct = ((ultimo.salto - medias.salto) / medias.salto) * 100 || 0;
  const hooperPct = ((ultimo.hooper - medias.hooper) / medias.hooper) * 100 || 0;

  // üîÑ Inverte o sinal do Hooper (maior Hooper = pior prontid√£o)
  const hooperInvertido = hooperPct * -1;

  // üßÆ C√°lculo final do IGP equilibrado
  const igpPct = (vfcPct + saltoPct + hooperInvertido) / 3;

  return { vfcPct, saltoPct, igpPct };
}


    // =====================================================
    // üèãÔ∏è CARREGAR DADOS CARGA
    // =====================================================
    async function carregarCarga() {
      const snap = await getDocs(collection(db, "carga"));
      const dados = snap.docs.map(doc => doc.data());

      const normalizados = dados.map(d => ({
        atleta: d.atleta_id,
        equipe: d.equipe_id,
        posicao: d.posicao_grupo,
        data: d.data,
        pse: Number(d.pse_sessao) || 0,
        tempo: Number(d.duracao_sessao_min) || 0,
        micro: d.microciclo_id || ""
      }));

      renderTabelaCarga(normalizados);
      renderCardsCarga(normalizados);
    }

    // =====================================================
    // üî¢ C√ÅLCULOS CARGA
    // =====================================================
    function renderCardsCarga(dados) {
      const semanas = agruparPorSemana(dados);
      const ult = semanas[semanas.length - 1];
      const prev = semanas.slice(-4);

      const cargaSemana = ult.reduce((s, x) => s + x.pse * x.tempo, 0);
      const media4 = prev.length ? prev.reduce((t, sem) => t + sem.reduce((s, x) => s + x.pse * x.tempo, 0), 0) / prev.length : cargaSemana;
      const acwr = media4 ? (cargaSemana / media4).toFixed(2) : 1;

      document.getElementById("cardCargaSemana").innerHTML = cargaSemana.toFixed(0);
      document.getElementById("cardMedia4").innerHTML = media4.toFixed(0);
      document.getElementById("cardACWR").innerHTML = acwr;

      const corACWR =
        acwr < 0.8 ? "text-blue-600" :
        acwr <= 1.3 ? "text-green-600" :
        acwr <= 1.5 ? "text-yellow-500" :
        "text-red-600";

      document.getElementById("cardACWR").className = "text-3xl font-bold mt-2 " + corACWR;
    }

    function agruparPorSemana(dados) {
      const porSemana = {};
      dados.forEach(d => {
        const dt = new Date(d.data + "T00:00:00");
        const diaSemana = (dt.getDay() + 6) % 7; // segunda=0
        const segunda = new Date(dt);
        segunda.setDate(dt.getDate() - diaSemana);
        const key = segunda.toISOString().split("T")[0];
        porSemana[key] = porSemana[key] || [];
        porSemana[key].push(d);
      });
      return Object.values(porSemana);
    }

    // =====================================================
    // üìã TABELA DE CARGA
    // =====================================================
    function renderTabelaCarga(dados) {
      const corpo = document.getElementById("tabelaCarga");
      corpo.innerHTML = dados.map(d => {
        const carga = d.pse * d.tempo;
        return `
          <tr class="border-b hover:bg-gray-50">
            <td class="p-2 font-semibold text-blue-700">${d.atleta}</td>
            <td class="p-2 text-center">${d.equipe}</td>
            <td class="p-2 text-center">${d.posicao}</td>
            <td class="p-2 text-center">${d.data}</td>
            <td class="p-2 text-center">${d.pse}</td>
            <td class="p-2 text-center">${d.tempo}</td>
            <td class="p-2 text-center font-bold text-gray-700">${carga}</td>
          </tr>`;
      }).join("");
    }

    // =====================================================
    // üöÄ INICIALIZA√á√ÉO
    // =====================================================
    document.addEventListener("DOMContentLoaded", async () => {
      document.querySelectorAll(".tab-btn").forEach(btn =>
        btn.addEventListener("click", () => mostrarAba(btn.dataset.aba))
      );

      // Aba padr√£o (no futuro ser√° Dashboard)
      mostrarAba("abaDashboard");

      await carregarProntidao();
      await carregarCarga();
    });
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; background: #f9fafb; color: #111827; }
    .hidden { display: none; }
    .tab-btn { transition: all 0.2s ease; }
    .tab-btn:hover { background-color: #2563eb; color: white; }
    .card-indicador { transition: transform 0.2s ease; }
    .card-indicador:hover { transform: scale(1.03); }
  </style>
</head>

<body class="p-6">
  <header class="max-w-7xl mx-auto mb-6 flex items-center justify-center space-x-3">
    <img src="https://cdn-icons-png.flaticon.com/512/3616/3616796.png" class="w-8 h-8" alt="logo">
    <h1 class="text-2xl font-bold text-blue-800">Plataforma Integrada - Ciente IE</h1>
  </header>

  <!-- üß≠ Navega√ß√£o de Abas -->
  <nav class="flex justify-center space-x-4 mb-8">
<button data-aba="abaDashboard" class="tab-btn px-5 py-2 rounded-lg bg-gray-200 text-gray-800">Dashboard</button>
      <button data-aba="abaProntidao" class="tab-btn px-5 py-2 rounded-lg bg-blue-600 text-white shadow">Prontid√£o</button>
    <button data-aba="abaCarga" class="tab-btn px-5 py-2 rounded-lg bg-gray-200 text-gray-800">Carga</button>
    <button data-aba="abaPlanejamento" class="tab-btn px-5 py-2 rounded-lg bg-gray-200 text-gray-800">
  Planejamento</button>
<button data-aba="abaMedico" class="tab-btn px-5 py-2 rounded-lg bg-gray-200 text-gray-800">
  Departamento M√©dico</button>
</nav>

    

  <!-- ================================================= -->
<!-- üß† ABA PRONTID√ÉO ‚Äì CIENTE IE -->
<!-- ================================================= -->
<section id="abaProntidao" class="aba">

  <!-- üîπ FILTROS -->
  <div class="max-w-6xl mx-auto mt-6 px-4 flex flex-col md:flex-row gap-4 justify-center">
    <div>
      <label class="block font-medium mb-1">Equipe</label>
      <select id="filtroEquipe" class="border p-2 rounded w-56 bg-white shadow-sm"></select>
    </div>
    <div>
      <label class="block font-medium mb-1">Posi√ß√£o</label>
      <select id="filtroPosicao" class="border p-2 rounded w-56 bg-white shadow-sm">
        <option value="todos">Todas</option>
      </select>
    </div>
    <div>
      <label class="block font-medium mb-1">Atleta</label>
      <select id="filtroAtleta" class="border p-2 rounded w-56 bg-white shadow-sm">
        <option value="todos">Todos</option>
      </select>
    </div>
    <div>
      <label class="block font-medium mb-1">Semana</label>
      <select id="filtroSemana" class="border p-2 rounded w-56 bg-white shadow-sm">
        <option value="todas">Todas</option>
      </select>
    </div>
  </div>

  <!-- üîπ CARDS PRINCIPAIS -->
  <div class="max-w-6xl mx-auto mt-8 px-4 grid grid-cols-1 md:grid-cols-3 gap-6">
    <div id="cardIGP" class="bg-white rounded-2xl shadow p-5 border-t-4 border-purple-500 text-center">
      <h2 class="text-lg font-semibold text-gray-700">√çndice Geral de Prontid√£o (IGP%)</h2>
      <p id="valorIGP" class="text-3xl mt-2 font-bold">--%</p>
      <p class="text-sm text-gray-500 mt-1">√öltima semana</p>
    </div>
    <div id="cardVFC" class="bg-white rounded-2xl shadow p-5 border-t-4 border-blue-500 text-center">
      <h2 class="text-lg font-semibold text-gray-700">Prontid√£o Fisiol√≥gica (VFC%)</h2>
      <p id="valorVFC" class="text-3xl mt-2 font-bold">--%</p>
      <p class="text-sm text-gray-500 mt-1">√öltima semana</p>
    </div>
    <div id="cardSalto" class="bg-white rounded-2xl shadow p-5 border-t-4 border-green-500 text-center">
      <h2 class="text-lg font-semibold text-gray-700">Prontid√£o Muscular (Salto%)</h2>
      <p id="valorSalto" class="text-3xl mt-2 font-bold">--%</p>
      <p class="text-sm text-gray-500 mt-1">√öltima semana</p>
    </div>    
  </div>

  <!-- üîπ LEGENDA -->
  <div class="text-center text-sm text-gray-600 mt-2">
    <span class="inline-block mx-3">üü¢ <strong>Acima da M√©dia</strong> (&gt; +5%)</span>
    <span class="inline-block mx-3">üîµ <strong>Est√°vel</strong> (entre -5% e +5%)</span>
    <span class="inline-block mx-3">üü° <strong>Aten√ß√£o</strong> (entre -10% e -5%)</span>
    <span class="inline-block mx-3">üî¥ <strong>Abaixo da M√©dia</strong> (&lt; -10%)</span>
  </div>

  <!-- üîπ TABELA PRINCIPAL -->
  <div class="max-w-6xl mx-auto mt-8 px-4">
    <div class="bg-white rounded-lg shadow-md overflow-x-auto border">
      <table id="tabelaAtletas" class="min-w-full text-sm text-gray-700">
        <thead class="bg-blue-100">
          <tr>
            <th class="p-2 text-left">Atleta</th>
            <th class="p-2 text-center">Equipe</th>
            <th class="p-2 text-center">Posi√ß√£o</th>
            <th class="p-2 text-center">Data</th>
            <th class="p-2 text-center">Hooper (Soma)</th>
            <th class="p-2 text-center">VFC%</th>
            <th class="p-2 text-center">Salto%</th>
            <th class="p-2 text-center">IGP%</th>
          </tr>
        </thead>
        <tbody id="corpoTabela"></tbody>
      </table>
    </div>
  </div>

  <!-- üîπ DETALHES DO ATLETA -->
  <div id="detalhesContainer" class="max-w-6xl mx-auto mt-8 px-4 space-y-8"></div>

  <!-- üîπ SCRIPT PRINCIPAL -->
    <script type="module">
    import { getFirestore, collection, getDocs, query, orderBy } 
    from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // üîπ Reaproveita o app j√° inicializado globalmente
    import { getApps, getApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    const app = getApps().length ? getApp() : null;
    if (!app) {
      console.error("‚ö†Ô∏è Firebase App n√£o encontrado. Verifique se a inicializa√ß√£o principal est√° antes desta aba.");
    }

    const db = getFirestore(app);

    async function carregarDados() {
      const q = query(collection(db, "prontidao"), orderBy("data", "desc"));
      const snapshot = await getDocs(q);
      const dados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      processarDados(dados);
    }

    function processarDados(dados) {
      dados.forEach(d => {
        d.atleta = d.nome_atleta || d.atleta_id || "Sem nome";
        d.equipe = d.equipe_id || d.equipe || "Sem equipe";
        d.posicao = d.posicao_grupo || "N√£o definida";
        d.data = d.data || "2025-01-01";
        d.sono = parseInt(d.sono || d.qualidade_sono || 0);
        d.estresse = parseInt(d.estresse || d.niveis_stress || 0);
        d.fadiga = parseInt(d.fadiga || d.fadiga_geral || 0);
        d.dor = parseInt(d.dor || d.dor_muscular || 0);
        d.salto = parseFloat(d.salto || 0);
        d.vfc = parseFloat(d.vfc || 0);
        d.hooper = d.sono + d.estresse + d.fadiga + d.dor;
      });

      const atletas = {};
      dados.forEach(d => {
        if (!atletas[d.atleta]) atletas[d.atleta] = [];
        atletas[d.atleta].push(d);
      });

      const resumo = [];
      for (const atleta in atletas) {
        const registros = atletas[atleta];
        const medias = calcularMedias(registros);
        const ultimo = registros[0];
        const variacoes = calcularVariacoes(ultimo, medias);
        resumo.push({
          atleta,
          equipe: ultimo.equipe,
          posicao: ultimo.posicao,
          data: ultimo.data,
          hooper: ultimo.hooper,
          ...variacoes
        });
      }

      preencherFiltros(dados);
      renderTabela(resumo);
      renderCards(resumo);
      window.__dadosResumo = resumo;
      window.__dadosBrutos = dados;
    }

    function calcularMedias(registros) {
      const n = registros.length;
      const media = (arr, key) => arr.reduce((a, b) => a + (b[key] || 0), 0) / n;
      return {
        vfc: media(registros, "vfc"),
        salto: media(registros, "salto"),
        hooper: media(registros, "hooper")
      };
    }

    function calcularVariacoes(ultimo, medias) {
      const vfcPct = ((ultimo.vfc - medias.vfc) / medias.vfc) * 100 || 0;
      const saltoPct = ((ultimo.salto - medias.salto) / medias.salto) * 100 || 0;
      const hooperPct = ((ultimo.hooper - medias.hooper) / medias.hooper) * 100 || 0;
      const hooperInvertido = hooperPct * -1;
const igpPct = (vfcPct + saltoPct + hooperInvertido) / 3;

      return { vfcPct, saltoPct, igpPct };
    }

    function classeCor(valor) {
      if (valor > 5) return "text-green-600 font-bold";
      if (valor >= -5 && valor <= 5) return "text-blue-600 font-bold";
      if (valor >= -10 && valor < -5) return "text-yellow-500 font-bold";
      if (valor < -10) return "text-red-600 font-bold";
      return "text-gray-600";
    }

    function preencherFiltros(dados) {
      const equipes = [...new Set(dados.map(d => d.equipe))];
      const posicoes = [...new Set(dados.map(d => d.posicao))];
      const atletas = [...new Set(dados.map(d => d.atleta))];
      document.getElementById("filtroEquipe").innerHTML =
        "<option value='todos'>Todas</option>" + equipes.map(e => `<option>${e}</option>`).join("");
      document.getElementById("filtroPosicao").innerHTML =
        "<option value='todos'>Todas</option>" + posicoes.map(p => `<option>${p}</option>`).join("");
      document.getElementById("filtroAtleta").innerHTML =
        "<option value='todos'>Todos</option>" + atletas.map(a => `<option>${a}</option>`).join("");
      ["filtroEquipe", "filtroPosicao", "filtroAtleta"].forEach(id =>
        document.getElementById(id).addEventListener("change", aplicarFiltros)
      );
    }

    function aplicarFiltros() {
      const eq = document.getElementById("filtroEquipe").value;
      const po = document.getElementById("filtroPosicao").value;
      const at = document.getElementById("filtroAtleta").value;
      let filtrados = window.__dadosResumo;
      if (eq !== "todos") filtrados = filtrados.filter(d => d.equipe === eq);
      if (po !== "todos") filtrados = filtrados.filter(d => d.posicao === po);
      if (at !== "todos") filtrados = filtrados.filter(d => d.atleta === at);
      renderTabela(filtrados);
      renderCards(filtrados);
    }

    function renderTabela(resumo) {
      resumo.sort((a, b) => b.igpPct - a.igpPct);
      const corpo = document.getElementById("corpoTabela");
      corpo.innerHTML = resumo.map(d => {
        const f = v => (v >= 0 ? "+" : "") + v.toFixed(1) + "%";
        let corHooper = "bg-green-500";
        if (d.hooper >= 11 && d.hooper <= 17) corHooper = "bg-yellow-400";
        if (d.hooper > 17) corHooper = "bg-red-500";
        return `
          <tr class="border-b hover:bg-gray-50 cursor-pointer" data-atleta="${d.atleta}">
            <td class="p-2 font-semibold text-blue-700">${d.atleta}</td>
            <td class="p-2 text-center text-gray-600">${d.equipe}</td>
            <td class="p-2 text-center text-gray-600">${d.posicao}</td>
            <td class="p-2 text-center text-gray-600">${d.data}</td>
            <td class="p-2 text-center">
              <span class="${corHooper} text-white font-bold rounded-full px-3 py-1 inline-block w-10 h-10 flex items-center justify-center mx-auto">
                ${d.hooper.toFixed(0)}
              </span>
            </td>
            <td class="p-2 text-center ${classeCor(d.vfcPct)}">${f(d.vfcPct)}</td>
            <td class="p-2 text-center ${classeCor(d.saltoPct)}">${f(d.saltoPct)}</td>
            <td class="p-2 text-center ${classeCor(d.igpPct)}">${f(d.igpPct)}</td>
          </tr>`;
      }).join("");
      corpo.querySelectorAll("tr").forEach(tr =>
        tr.addEventListener("click", () => abrirDetalhes(tr.dataset.atleta))
      );
    }

    function renderCards(resumo) {
      const avg = (arr, k) => arr.reduce((a, b) => a + (b[k] || 0), 0) / arr.length;
      const set = (id, v) => {
        const el = document.getElementById("valor" + id.replace("card", ""));
        const s = v >= 0 ? "+" : "";
        el.textContent = `${s}${v.toFixed(1)}%`;
        el.className = v > 10 ? "text-green-600 text-3xl mt-2 font-bold"
          : v < -10 ? "text-red-600 text-3xl mt-2 font-bold"
          : "text-blue-600 text-3xl mt-2 font-bold";
      };
      set("cardVFC", avg(resumo, "vfcPct"));
      set("cardSalto", avg(resumo, "saltoPct"));
      set("cardIGP", avg(resumo, "igpPct"));
    }

    function abrirDetalhes(nome) {
      const c = document.getElementById("detalhesContainer");
      c.innerHTML = "";
      const r = window.__dadosBrutos.filter(d => d.nome_atleta === nome || d.atleta_id === nome)
        .sort((a, b) => new Date(a.data) - new Date(b.data));
      if (!r.length) return;
      const u = r[r.length - 1];
      c.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <h3 class="text-xl font-semibold text-blue-700">${nome} ‚Äì ${u.equipe} (${u.posicao})</h3>
          <button onclick="fecharDetalhes()" class="bg-red-600 text-white px-3 py-1 rounded shadow hover:bg-red-700">Fechar</button>
        </div>
        <div class="bg-white p-4 rounded-lg shadow border">
          <p><strong>√öltima Data:</strong> ${u.data}</p>
          <p><strong>Sono:</strong> ${u.sono} | <strong>Estresse:</strong> ${u.estresse} | <strong>Fadiga:</strong> ${u.fadiga} | <strong>Dor:</strong> ${u.dor}</p>
          <p><strong>VFC:</strong> ${u.vfc.toFixed(1)} | <strong>Salto:</strong> ${u.salto.toFixed(1)} | <strong>Hooper:</strong> ${u.hooper.toFixed(1)}</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <div class="h-60"><canvas id="graficoVFC"></canvas></div>
          <div class="h-60"><canvas id="graficoSalto"></canvas></div>
          <div class="h-60"><canvas id="graficoIGP"></canvas></div>
        </div>`;
      gerarGraficos(nome);
      c.scrollIntoView({ behavior: "smooth" });
    }

    window.fecharDetalhes = () => {
      document.getElementById("detalhesContainer").innerHTML = "";
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    carregarDados();
  </script>

  <script>
    function gerarGraficos(nome) {
      const r = window.__dadosBrutos.filter(d => d.nome_atleta === nome || d.atleta_id === nome)
        .sort((a, b) => new Date(a.data) - new Date(b.data));
      if (!r.length) return;
      const m = {
        vfc: r.reduce((a, b) => a + (b.vfc || 0), 0) / r.length,
        salto: r.reduce((a, b) => a + (b.salto || 0), 0) / r.length,
        hooper: r.reduce((a, b) => a + (b.hooper || 0), 0) / r.length
      };
      const l = r.map(x => x.data);
      const v = r.map(x => ((x.vfc - m.vfc) / m.vfc) * 100);
      const s = r.map(x => ((x.salto - m.salto) / m.salto) * 100);
      const h = r.map(x => ((x.hooper - m.hooper) / m.hooper) * 100);
      const i = v.map((x, j) => ((x + s[j]) / 2) - h[j]);
      criarMiniGrafico("graficoVFC", l, v, "VFC (%)", "#3b82f6");
      criarMiniGrafico("graficoSalto", l, s, "Salto (%)", "#10b981");
      criarMiniGrafico("graficoIGP", l, i, "IGP (%)", "#8b5cf6");
    }

    function criarMiniGrafico(id, l, d, t, cor) {
      const ctx = document.getElementById(id).getContext("2d");
      const cores = d.map(v => v > 10 ? "#16a34a" : v < -10 ? "#dc2626" : "#3b82f6");
      new Chart(ctx, {
        type: "bar",
        data: { labels: l, datasets: [{ data: d, backgroundColor: cores, borderRadius: 5 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              min: -30, max: 30,
              title: { display: true, text: "% vs m√©dia pessoal" },
              ticks: {
                color: "#4b5563", font: { size: 11 },
                callback: v => (v > 0 ? "+" + v : v)
              },
              grid: { color: "#e5e7eb" }
            },
            x: { ticks: { color: "#4b5563", font: { size: 11 } }, grid: { display: false } }
          },
          plugins: {
            legend: { display: false },
            title: { display: true, text: t, color: "#374151", font: { size: 13, weight: "bold" } },
            tooltip: { callbacks: { label: c => (c.parsed.y >= 0 ? "+" : "") + c.parsed.y.toFixed(1) + "%" } }
          }
        }
      });
    }
  </script>
</section>

<!-- ================================================= -->
<!-- üèãÔ∏è ABA CARGA ‚Äì CIENTE IE -->
<!-- ================================================= -->
<section id="abaCarga" class="aba hidden">

  <!-- üîπ FILTROS -->
  <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div>
      <label class="block text-sm font-medium mb-1">Equipe</label>
      <select id="filtroEquipeCarga" class="border p-2 rounded w-full bg-white shadow-sm"></select>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Posi√ß√£o</label>
      <select id="filtroPosicaoCarga" class="border p-2 rounded w-full bg-white shadow-sm"></select>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Atleta</label>
      <select id="filtroAtletaCarga" class="border p-2 rounded w-full bg-white shadow-sm"></select>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Semana</label>
      <select id="filtroSemanaCarga" class="border p-2 rounded w-full bg-white shadow-sm">
        <option value="todas">Todas</option>
      </select>
    </div>
  </div>

  <!-- üîπ CARDS -->
  <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-2xl shadow p-5 border-t-4 border-blue-500 text-center">
      <h2 class="text-lg font-semibold text-gray-700">Carga Total da Semana</h2>
      <p id="cardCargaTotal" class="text-3xl font-bold mt-2">--</p>
    </div>
    <div class="bg-white rounded-2xl shadow p-5 border-t-4 border-indigo-500 text-center">
      <h2 class="text-lg font-semibold text-gray-700">M√©dia Individual da Equipe</h2>
      <p id="cardCargaMedia" class="text-3xl font-bold mt-2">--</p>
    </div>
    <div class="bg-white rounded-2xl shadow p-5 border-t-4 border-green-500 text-center">
      <h2 class="text-lg font-semibold text-gray-700">ACWR M√©dio da Equipe</h2>
      <p id="cardACWRMedia" class="text-3xl font-bold mt-2">--</p>
    </div>
  </div>

  <!-- üîπ TABELA -->
  <div class="max-w-6xl mx-auto bg-white shadow rounded-xl overflow-x-auto">
    <table class="w-full text-sm text-center">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="p-2">Atleta</th>
          <th class="p-2">Equipe</th>
          <th class="p-2">Posi√ß√£o</th>
          <th class="p-2">√öltima Data</th>
          <th class="p-2">Carga Semanal</th>
          <th class="p-2">ACWR</th>
        </tr>
      </thead>
      <tbody id="tabelaCarga" class="text-gray-700"></tbody>
    </table>
  </div>

  <!-- üîπ LEGENDA -->
  <div class="text-center text-sm text-gray-600 mt-4">
    <div class="mb-1 font-semibold text-gray-700">
      Rela√ß√£o Agudo/Cr√¥nica da Carga (ACWR)
    </div>
    <span class="inline-block mx-3">üîµ Subcarga (&lt; 0.8)</span>
    <span class="inline-block mx-3">üü¢ Ideal (0.8‚Äì1.3)</span>
    <span class="inline-block mx-3">üü° Aten√ß√£o (1.3‚Äì1.5)</span>
    <span class="inline-block mx-3">üî¥ Sobrecarga (&gt; 1.5)</span>
  </div>

  <!-- üîπ MODAL DETALHES -->
  <div id="modalDetalhesCarga" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-xl w-11/12 md:w-3/4 lg:w-1/2 p-6 relative">
      <button id="fecharModalCarga" class="absolute top-2 right-3 text-gray-500 hover:text-black text-xl font-bold">&times;</button>
      <h2 id="tituloAtletaCarga" class="text-xl font-semibold text-center mb-4"></h2>

      <!-- üîπ Lista de dados brutos -->
      <div id="dadosBrutosCarga" class="text-sm text-gray-700 mb-6 flex flex-wrap justify-center gap-2"></div>

      <!-- üîπ Gr√°fico -->
      <div class="w-full mb-4">
        <canvas id="graficoCargaDiaria"></canvas>
      </div>

      <!-- üîπ Resumo -->
      <div id="resumoCarga" class="text-center text-gray-700 font-medium"></div>
    </div>
  </div>

  <!-- ================================================= -->
  <!-- ‚öôÔ∏è SCRIPT -->
  <!-- ================================================= -->
  <script type="module">
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    const db = getFirestore();

    async function carregarCargaPainel() {
      const snap = await getDocs(collection(db, "carga"));
      const dados = snap.docs.map(doc => {
        const d = doc.data();
        return {
          nome_atleta: d.nome_atleta?.trim() || "Sem nome",
          equipe_id: d.equipe_id?.trim() || "-",
          posicao_grupo: d.posicao_grupo?.trim() || "-",
          data: d.data?.trim() || "",
          pse: Number(d.pse) || 0,
          tempo: Number(d.tempo) || 0
        };
      });
      preencherFiltrosCarga(dados);
      setTimeout(() => atualizarPainelCarga(dados), 300);
    }

    function preencherFiltrosCarga(dados) {
      const equipes = [...new Set(dados.map(d => d.equipe_id))];
      const posicoes = [...new Set(dados.map(d => d.posicao_grupo))];
      const atletas = [...new Set(dados.map(d => d.nome_atleta))];
      document.getElementById("filtroEquipeCarga").innerHTML = "<option value='todos'>Todas</option>" + equipes.map(e => `<option>${e}</option>`).join("");
      document.getElementById("filtroPosicaoCarga").innerHTML = "<option value='todos'>Todas</option>" + posicoes.map(p => `<option>${p}</option>`).join("");
      document.getElementById("filtroAtletaCarga").innerHTML = "<option value='todos'>Todos</option>" + atletas.map(a => `<option>${a}</option>`).join("");
      ["filtroEquipeCarga","filtroPosicaoCarga","filtroAtletaCarga"].forEach(id =>
        document.getElementById(id).addEventListener("change", () => atualizarPainelCarga(dados))
      );
    }

    function atualizarPainelCarga(dados) {
      const eq = filtroEquipeCarga.value, po = filtroPosicaoCarga.value, at = filtroAtletaCarga.value;
      let filtrados = dados;
      if (eq !== "todos") filtrados = filtrados.filter(d => d.equipe_id === eq);
      if (po !== "todos") filtrados = filtrados.filter(d => d.posicao_grupo === po);
      if (at !== "todos") filtrados = filtrados.filter(d => d.nome_atleta === at);
      const atletas = [...new Set(filtrados.map(d => d.nome_atleta))];
      const resumo = atletas.map(a => calcularCargaAtleta(a, filtrados));
      renderCardsCarga(resumo);
      renderTabelaCarga(resumo, dados);
    }

    function calcularCargaAtleta(nome, dados) {
      const doAtleta = dados.filter(d => d.nome_atleta === nome).sort((a,b)=>a.data.localeCompare(b.data));
      if (!doAtleta.length) return { atleta: nome, equipe: "-", posicao: "-", data: "-", carga: 0, acwr: 0 };
      const ult = doAtleta[doAtleta.length - 1];
      const semanas = agruparPorSemana(doAtleta);
      const atual = semanas[semanas.length - 1];
      const ultimos4 = semanas.slice(-4);
      const cargaSemanal = atual.reduce((s, x) => s + (x.pse * x.tempo), 0);
      const media4 = ultimos4.reduce((t, sem) => t + sem.reduce((s, x) => s + (x.pse * x.tempo), 0), 0) / ultimos4.length || cargaSemanal;
      const acwr = media4 ? cargaSemanal / media4 : 1;
      return { atleta: nome, equipe: ult.equipe_id, posicao: ult.posicao_grupo, data: ult.data, carga: cargaSemanal, acwr: acwr };
    }

    function agruparPorSemana(dados) {
      const porSemana = {};
      dados.forEach(d => {
        const dt = new Date(d.data + "T00:00:00");
        const diaSemana = (dt.getDay() + 6) % 7;
        const segunda = new Date(dt);
        segunda.setDate(dt.getDate() - diaSemana);
        const key = segunda.toISOString().split("T")[0];
        porSemana[key] = porSemana[key] || [];
        porSemana[key].push(d);
      });
      return Object.values(porSemana);
    }

    function renderCardsCarga(resumo) {
      if (!resumo.length) return;
      const cargaTotal = resumo.reduce((s, x) => s + x.carga, 0);
      const cargaMedia = cargaTotal / resumo.length;
      const acwrMedio = resumo.reduce((s, x) => s + x.acwr, 0) / resumo.length;
      cardCargaTotal.innerText = cargaTotal.toFixed(0);
      cardCargaMedia.innerText = cargaMedia.toFixed(0);
      cardACWRMedia.innerText = acwrMedio.toFixed(2);
    }

    function renderTabelaCarga(resumo, dados) {
      resumo.sort((a, b) => b.carga - a.carga);
      tabelaCarga.innerHTML = resumo.map(d => {
        const cor =
          d.acwr < 0.8 ? "text-blue-600 font-semibold" :
          d.acwr <= 1.3 ? "text-green-600 font-semibold" :
          d.acwr <= 1.5 ? "text-yellow-500 font-semibold" :
          "text-red-600 font-semibold";
        const bolinha =
          d.acwr < 0.8 ? "bg-blue-500" :
          d.acwr <= 1.3 ? "bg-green-500" :
          d.acwr <= 1.5 ? "bg-yellow-400" :
          "bg-red-500";
        return `
          <tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="abrirDetalhesCarga('${d.atleta}')">
            <td class="p-2 font-semibold text-blue-700 flex items-center justify-center gap-2">
              <span class="inline-block w-3 h-3 rounded-full ${bolinha}"></span>${d.atleta}
            </td>
            <td class="p-2">${d.equipe}</td>
            <td class="p-2">${d.posicao}</td>
            <td class="p-2">${d.data}</td>
            <td class="p-2">${d.carga.toFixed(0)}</td>
            <td class="p-2 ${cor}">${d.acwr.toFixed(2)}</td>
          </tr>`;
      }).join("");
      window.abrirDetalhesCarga = (nome) => mostrarDetalhesAtleta(nome, dados);
    }

    // ===============================
    // üîπ MODAL DETALHES (cards + gr√°fico + resumo)
    // ===============================
    let chartCarga = null;
    function mostrarDetalhesAtleta(nome, dados) {
      const atletaDados = dados.filter(d => d.nome_atleta === nome).sort((a,b)=>a.data.localeCompare(b.data));
      tituloAtletaCarga.innerText = nome;

      // üßæ Cria os cards
      const linhas = atletaDados.map(d => {
        const carga = (d.pse * d.tempo).toFixed(0);
        return `
          <div class="bg-gray-100 rounded-lg shadow-sm p-2 w-[110px] text-center">
            <p class="text-xs text-gray-500">${d.data}</p>
            <p class="text-xs">PSE: <span class="font-semibold">${d.pse}</span></p>
            <p class="text-xs">Tempo: <span class="font-semibold">${d.tempo}</span></p>
            <p class="text-xs text-blue-600 font-semibold">${carga}</p>
          </div>
        `;
      }).join("");
      dadosBrutosCarga.innerHTML = linhas;
      modalDetalhesCarga.classList.remove("hidden");

      // üìä Gr√°fico de barras
      const ctx1 = document.getElementById("graficoCargaDiaria");
      if (chartCarga) chartCarga.destroy();
      const cargas = atletaDados.map(d => d.pse * d.tempo);
      chartCarga = new Chart(ctx1, {
        type: "bar",
        data: {
          labels: atletaDados.map(d => d.data),
          datasets: [{ label: "Carga (PSE√óTempo)", data: cargas, backgroundColor: "#3b82f6" }]
        },
        options: {
          scales: { y: { min: 0, max: 1500 } },
          plugins: { legend: { display: false } }
        }
      });

      // üìà Resumo (total e m√©dia)
      const total = cargas.reduce((s, x) => s + x, 0);
      const media = total / cargas.length;
      resumoCarga.innerHTML = `
        <p><span class="font-semibold">Carga Total:</span> ${total.toFixed(0)} &nbsp;|&nbsp; 
           <span class="font-semibold">M√©dia Di√°ria:</span> ${media.toFixed(0)}</p>
      `;
    }

    document.getElementById("fecharModalCarga").addEventListener("click", ()=>modalDetalhesCarga.classList.add("hidden"));
    document.addEventListener("DOMContentLoaded", carregarCargaPainel);
  </script>

  <!-- Importa Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</section>

<!-- ================================================= -->
<!-- üóìÔ∏è ABA PLANEJAMENTO ‚Äì CIENTE IE (Parte 1/3: Estrutura HTML) -->
<!-- ================================================= -->
<section id="abaPlanejamento" class="aba hidden relative">

  <!-- üîπ BOT√ÉO FIXO DE CADASTRO -->
  <div class="sticky top-0 bg-white z-50 py-3 text-center shadow-md border-b mb-6">
    <button id="btnToggleCadastro" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg shadow">
      + Cadastrar Planejamento Semana
    </button>
  </div>

  <!-- üîπ FORMUL√ÅRIO SEMANAL (OCULTO POR PADR√ÉO) -->
  <div id="formPlanejamento" class="hidden animate-fadeIn max-w-6xl mx-auto bg-white rounded-2xl shadow p-6 mb-8">
    <h2 class="text-lg font-semibold mb-4 text-gray-700 text-center">Cadastrar Planejamento Semanal</h2>

    <!-- Campos principais -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div>
        <label class="block text-sm font-medium mb-1">Data Base (Segunda)</label>
        <input type="date" id="dataBaseSemana" class="border p-2 rounded w-full bg-gray-50 shadow-sm">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Equipe</label>
        <select id="equipePlanejamento" class="border p-2 rounded w-full bg-gray-50 shadow-sm">
          <option value="">Selecione</option>
          <option>Sub-15</option>
          <option>Sub-17</option>
          <option>Profissional</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Tipo de Treino</label>
        <select id="tipoPlanejamento" class="border p-2 rounded w-full bg-gray-50 shadow-sm">
          <option value="">Selecione</option>
          <option value="Campo">Campo</option>
          <option value="F√≠sico">F√≠sico</option>
        </select>
      </div>
    </div>

    <!-- Cabe√ßalho Semana -->
    <div class="text-center mb-4">
      <p id="infoSemana" class="text-lg font-semibold text-blue-700 bg-gray-100 rounded p-2 inline-block shadow-inner">--</p>
    </div>

    <!-- Tabela semanal -->
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-center border rounded-lg">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="p-2">Dia</th>
            <th class="p-2">Carga Planejada</th>
            <th class="p-2">Objetivos Principais</th>
            <th class="p-2">Objetivo Secund√°rio / Atividades</th>
            <th class="p-2">Observa√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaSemanaPlanejamento" class="text-gray-700"></tbody>
      </table>
    </div>

    <div class="text-center mt-6">
      <button id="btnSalvarSemana" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg shadow">
        üíæ Salvar Semana
      </button>
    </div>
  </div>

  <!-- üîπ FILTROS GLOBAIS -->
  <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div>
      <label class="block text-sm font-medium mb-1">Equipe</label>
      <select id="filtroEquipeGlobal" class="border p-2 rounded w-full bg-white shadow-sm"></select>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Semana</label>
      <select id="filtroSemanaGlobal" class="border p-2 rounded w-full bg-white shadow-sm"></select>
    </div>
  </div>

  <!-- üîπ EXIBI√á√ÉO LADO A LADO -->
  <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- üü¶ PLANEJAMENTO DE CAMPO -->
    <div class="bg-white rounded-2xl shadow p-6 overflow-auto">
      <h2 class="text-lg font-semibold text-blue-700 mb-3 text-center">‚öΩ Planejamento de Campo</h2>
      <table class="w-full text-sm text-center">
        <thead class="bg-blue-50 text-blue-800 font-semibold">
          <tr>
            <th class="p-2">Dia</th>
            <th class="p-2">Equipe</th>
            <th class="p-2">Objetivos</th>
            <th class="p-2">Carga</th>
            <th class="p-2">Atividades</th>
          </tr>
        </thead>
        <tbody id="tabelaCampo"></tbody>
      </table>
    </div>

    <!-- üü© PLANEJAMENTO F√çSICO -->
    <div class="bg-white rounded-2xl shadow p-6 overflow-auto">
      <h2 class="text-lg font-semibold text-green-700 mb-3 text-center">üèãÔ∏è Planejamento F√≠sico</h2>
      <table class="w-full text-sm text-center">
        <thead class="bg-green-50 text-green-800 font-semibold">
          <tr>
            <th class="p-2">Dia</th>
            <th class="p-2">Equipe</th>
            <th class="p-2">Objetivos</th>
            <th class="p-2">Carga</th>
            <th class="p-2">Atividades</th>
          </tr>
        </thead>
        <tbody id="tabelaFisico"></tbody>
      </table>
    </div>
  </div>

  <!-- üîπ GR√ÅFICO DE CARGAS -->
  <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6 mb-12">
    <h2 class="text-lg font-semibold text-gray-700 mb-4 text-center">üìä Cargas Semanais (Campo x F√≠sico)</h2>
    <canvas id="graficoCargas" height="120"></canvas>
  </div>
<!-- ================================================= -->
<!-- ‚öôÔ∏è SCRIPT ‚Äì Firebase + Chart.js -->
<!-- ================================================= -->
<script type="module">
  import { getFirestore, collection, addDoc, getDocs, serverTimestamp } 
  from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
  const db = getFirestore();
  const colRef = collection(db, "planejamento");

  // Importa Chart.js
  const chartScript = document.createElement("script");
  chartScript.src = "https://cdn.jsdelivr.net/npm/chart.js";
  document.head.appendChild(chartScript);

  // ---------- DADOS BASE ----------
  const diasSemana = ["Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado","Domingo"];
  const objetivosFisico = [
    "For√ßa Geral","For√ßa Explosiva","For√ßa M√°xima","For√ßa Especial","Velocidade","Agilidade",
    "Resist√™ncia Aer√≥bia","Resist√™ncia Anaer√≥bia","Mobilidade","Flexibilidade",
    "F√≠sico-T√©cnico","Recreativo","Regenerativo","Jogo Treino","Descanso","Sem Atividade"
  ];
  const objetivosCampo = [
    "T√©cnico","T√°tico","Jogadas Ensaiadas","Jogo Treino","Jogo Oficial","Descanso","Sem Atividade"
  ];

  const corpoTabela = document.getElementById("tabelaSemanaPlanejamento");
  let chart; // inst√¢ncia do gr√°fico

  // ---------- FUN√á√ïES AUXILIARES ----------
  function getNumeroSemana(dataStr) {
    const date = new Date(dataStr + "T00:00:00");
    const target = new Date(date.valueOf());
    const dayNr = (date.getDay() + 6) % 7;
    target.setDate(target.getDate() - dayNr + 3);
    const firstThursday = new Date(target.getFullYear(), 0, 4);
    const diff = target - firstThursday;
    return 1 + Math.round(diff / (7 * 24 * 60 * 60 * 1000));
  }

  const mapaCargas = {
    "Descanso": 1, "Sem Atividade": 1,
    "Leve": 2, "Moderada": 3, "Alta": 4, "M√°xima": 5
  };
  const corCarga = {1:"#3B82F6",2:"#22C55E",3:"#FACC15",4:"#FB923C",5:"#EF4444"};

  // ---------- MONTAR TABELA DE CADASTRO ----------
  function montarTabela() {
    const tipo = document.getElementById("tipoPlanejamento").value;
    const lista = tipo === "F√≠sico" ? objetivosFisico : tipo === "Campo" ? objetivosCampo : [];
    corpoTabela.innerHTML = diasSemana.map(dia => `
      <tr>
        <td class="p-2 font-semibold text-blue-700">${dia}</td>
        <td class="p-2">
          <select class="carga-planejada border p-1 rounded w-full bg-gray-50">
            <option value="">Selecione</option>
            <option>Descanso</option>
            <option>Sem Atividade</option>
            <option>Leve</option>
            <option>Moderada</option>
            <option>Alta</option>
            <option>M√°xima</option>
          </select>
        </td>
        <td class="p-2">
          <select multiple class="objetivo-principal border p-1 rounded w-full bg-gray-50 h-24">
            ${lista.map(o => `<option>${o}</option>`).join("")}
          </select>
        </td>
        <td class="p-2"><input type="text" class="objetivo-secundario border p-1 rounded w-full bg-gray-50" placeholder="Atividades / Objetivos secund√°rios"></td>
        <td class="p-2"><input type="text" class="observacoes border p-1 rounded w-full bg-gray-50" placeholder="Observa√ß√µes"></td>
      </tr>
    `).join("");
  }
  document.getElementById("tipoPlanejamento").addEventListener("change", montarTabela);

  // ---------- TOGGLE FORMUL√ÅRIO ----------
  const btnToggle = document.getElementById("btnToggleCadastro");
  const form = document.getElementById("formPlanejamento");
  btnToggle.addEventListener("click", () => {
    form.classList.toggle("hidden");
    btnToggle.textContent = form.classList.contains("hidden") ? "+ Cadastrar Planejamento Semana" : "‚úñ Fechar Cadastro Semanal";
  });

  // ---------- CABE√áALHO DA SEMANA ----------
  document.getElementById("dataBaseSemana").addEventListener("change", () => {
    const data = document.getElementById("dataBaseSemana").value;
    if (!data) return;
    const dt = new Date(data + "T00:00:00");
    const segunda = new Date(dt);
    const domingo = new Date(segunda); domingo.setDate(segunda.getDate() + 6);
    const semanaTxt = `${segunda.toLocaleDateString('pt-BR')} a ${domingo.toLocaleDateString('pt-BR')} (S${getNumeroSemana(data)})`;
    document.getElementById("infoSemana").textContent = semanaTxt;
  });

  // ---------- SALVAR SEMANA ----------
  document.getElementById("btnSalvarSemana").addEventListener("click", async () => {
    const dataBase = document.getElementById("dataBaseSemana").value;
    const equipe = document.getElementById("equipePlanejamento").value;
    const tipo = document.getElementById("tipoPlanejamento").value;
    if (!dataBase || !equipe || !tipo) {
      alert("Preencha todos os campos principais antes de salvar!");
      return;
    }

    const segunda = new Date(dataBase + "T00:00:00");
    const domingo = new Date(segunda); domingo.setDate(segunda.getDate() + 6);
    const semana = `${segunda.toLocaleDateString('pt-BR')} a ${domingo.toLocaleDateString('pt-BR')}`;
    const numSemana = getNumeroSemana(dataBase);

    const linhas = corpoTabela.querySelectorAll("tr");
    for (let i = 0; i < linhas.length; i++) {
      const carga = linhas[i].querySelector(".carga-planejada").value;
      const obj = Array.from(linhas[i].querySelector(".objetivo-principal").selectedOptions).map(o => o.value);
      const objSec = linhas[i].querySelector(".objetivo-secundario").value;
      const obs = linhas[i].querySelector(".observacoes").value;
      const dataDia = new Date(segunda); dataDia.setDate(segunda.getDate() + i);

      await addDoc(colRef, {
        data: dataDia.toISOString().split("T")[0],
        dia_nome: diasSemana[i],
        semana,
        semana_numero: numSemana,
        equipe_id: equipe,
        tipo,
        carga_planejada: carga,
        carga_valor: mapaCargas[carga] || 0,
        objetivo_principal: obj,
        objetivo_secundario: objSec,
        observacoes: obs,
        criado_em: serverTimestamp()
      });
    }

    alert("Planejamento semanal salvo com sucesso!");
    carregarPlanejamentos();
  });

  // ---------- CARREGAR PLANEJAMENTOS ----------
  async function carregarPlanejamentos() {
    const snap = await getDocs(colRef);
    const dados = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    const equipes = [...new Set(dados.map(d => d.equipe_id))];
    filtroEquipeGlobal.innerHTML = "<option value='todas'>Todas</option>" + equipes.map(e => `<option>${e}</option>`).join("");

    const semanas = [...new Set(dados.map(d => `${d.semana} (S${d.semana_numero})`))];
    filtroSemanaGlobal.innerHTML = "<option value='atual'>Semana Atual</option>" + semanas.map(s => `<option>${s}</option>`).join("");

    aplicarFiltros(dados);
    filtroEquipeGlobal.onchange = () => aplicarFiltros(dados);
    filtroSemanaGlobal.onchange = () => aplicarFiltros(dados);
  }

  // ---------- APLICAR FILTROS + ATUALIZAR TABELAS E GR√ÅFICO ----------
  function aplicarFiltros(dados) {
    const eq = filtroEquipeGlobal.value;
    const sem = filtroSemanaGlobal.value;
    const hoje = new Date();
    const semanaAtual = getNumeroSemana(hoje.toISOString().split("T")[0]);

    let filtrados = dados;
    if (eq !== "todas") filtrados = filtrados.filter(d => d.equipe_id === eq);
    filtrados = sem === "atual"
      ? filtrados.filter(d => d.semana_numero === semanaAtual)
      : filtrados.filter(d => `S${d.semana_numero}` && sem.includes(`S${d.semana_numero}`));

    const campo = filtrados.filter(d => d.tipo === "Campo");
    const fisico = filtrados.filter(d => d.tipo === "F√≠sico");

    const tabelaCampo = document.getElementById("tabelaCampo");
    const tabelaFisico = document.getElementById("tabelaFisico");

    tabelaCampo.innerHTML = gerarTabelaHTML(campo, "blue");
    tabelaFisico.innerHTML = gerarTabelaHTML(fisico, "green");

    atualizarGrafico(campo, fisico);
  }

  function gerarTabelaHTML(lista, corBase) {
    if (!lista.length) return `<tr><td colspan='5' class='p-2 text-gray-400'>Nenhum treino cadastrado</td></tr>`;
    lista.sort((a,b)=>a.data.localeCompare(b.data));
    return lista.map(d => {
      const cargaVal = mapaCargas[d.carga_planejada] || 0;
      const cor = corCarga[cargaVal] || "#e5e7eb";
      const textoCor = cargaVal >= 4 ? "text-white" : "text-black";
      return `
        <tr class="border-b hover:bg-${corBase}-50">
          <td class="p-2">${d.dia_nome}</td>
          <td class="p-2">${d.equipe_id}</td>
          <td class="p-2">${Array.isArray(d.objetivo_principal)?d.objetivo_principal.join(", "):d.objetivo_principal||"-"}</td>
          <td class="p-2 ${textoCor}" style="background:${cor}">${d.carga_planejada || "-"}</td>
          <td class="p-2">${d.objetivo_secundario || "-"}</td>
        </tr>`;
    }).join("");
  }

  // ---------- GR√ÅFICO DE CARGAS ----------
function atualizarGrafico(campo, fisico) {
  if (!window.Chart) return;

  const dadosCampo = new Array(7).fill(0);
  const dadosFisico = new Array(7).fill(0);

  campo.forEach(d => {
    const i = diasSemana.indexOf(d.dia_nome);
    if (i >= 0) dadosCampo[i] = mapaCargas[d.carga_planejada] || 0;
  });
  fisico.forEach(d => {
    const i = diasSemana.indexOf(d.dia_nome);
    if (i >= 0) dadosFisico[i] = mapaCargas[d.carga_planejada] || 0;
  });

  const ctx = document.getElementById("graficoCargas").getContext("2d");

  // üîπ Atualiza t√≠tulo do gr√°fico
  document.querySelector("#graficoCargas").previousElementSibling.textContent = "üìä Carga Estimada da Semana";

  // üîπ Destroi gr√°fico anterior antes de recriar
  if (chart) chart.destroy();

  // üîπ Cria novo gr√°fico
  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: diasSemana,
      datasets: [
        {
          label: "Campo",
          data: dadosCampo,
          backgroundColor: "#3B82F6",
          borderRadius: 4,
          barPercentage: 0.45
        },
        {
          label: "F√≠sico",
          data: dadosFisico,
          backgroundColor: "#22C55E",
          borderRadius: 4,
          barPercentage: 0.45
        }
      ]
    },
    options: {
      responsive: true,
      aspectRatio: 2.5,
      plugins: {
        legend: { display: true, position: "bottom" },
        title: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function (ctx) {
              const valor = ctx.parsed.y;
              let descricao = "";
              switch (valor) {
                case 1: descricao = "Descanso / Sem Atividade"; break;
                case 2: descricao = "Leve"; break;
                case 3: descricao = "Moderada"; break;
                case 4: descricao = "Alta"; break;
                case 5: descricao = "M√°xima"; break;
                default: descricao = "Sem carga";
              }
              return `${ctx.dataset.label}: ${descricao} (${valor})`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 5,
          ticks: {
            stepSize: 1,
            font: { size: 12 }
          },
          title: {
            display: true,
            text: "N√≠vel da Carga (1‚Äì5)",
            font: { size: 13, weight: "bold" }
          },
          grid: { color: "#e5e7eb" }
        },
        x: {
          ticks: { font: { size: 12 } },
          grid: { display: false }
        }
      }
    }
  });
}


  document.addEventListener("DOMContentLoaded", carregarPlanejamentos);
</script>
<!-- ================================================= -->
<!-- üé® ESTILOS FINAIS ‚Äì CIENTE IE -->
<!-- ================================================= -->
<style>
  /* ===== ANIMA√á√ïES ===== */
  @keyframes fadeIn { from {opacity: 0; transform: translateY(-10px);} to {opacity: 1; transform: translateY(0);} }
  .animate-fadeIn { animation: fadeIn 0.4s ease-in-out; }

  /* ===== FORMATA√á√ÉO GERAL ===== */
  #abaPlanejamento {
    scroll-behavior: smooth;
  }

  select[multiple] {
    height: 6rem;
    background-color: #f9fafb;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    padding: 0.25rem;
  }
  select[multiple] option {
    padding: 0.25rem;
    border-radius: 0.25rem;
  }
  select[multiple] option:checked {
    background-color: #2563eb;
    color: white;
  }

  /* ===== BOT√ÉO FIXO ===== */
  #btnToggleCadastro {
    transition: all 0.25s ease;
  }
  #btnToggleCadastro:hover {
    transform: scale(1.03);
  }

  /* ===== TABELAS ===== */
  table {
    border-collapse: collapse;
    width: 100%;
  }
  th, td {
    border: 1px solid #e5e7eb;
  }
  th {
    font-weight: 600;
  }
  tbody tr:hover {
    background-color: #f9fafb;
  }

  /* ===== CORES DE CARGA (refer√™ncia) ===== */
  .carga-1 { background-color: #3B82F6; color: white; }
  .carga-2 { background-color: #22C55E; color: white; }
  .carga-3 { background-color: #FACC15; color: black; }
  .carga-4 { background-color: #FB923C; color: white; }
  .carga-5 { background-color: #EF4444; color: white; }

  /* ===== GR√ÅFICO ===== */
  #graficoCargas {
    width: 100%;
    height: 300px;
  }

  /* ===== RESPONSIVIDADE ===== */
  @media (max-width: 768px) {
    #formPlanejamento table {
      font-size: 0.85rem;
    }
    #btnToggleCadastro {
      width: 90%;
      font-size: 0.95rem;
    }
  }
</style>

</section>


<!-- ================================================= -->
<!-- üè• ABA DEPARTAMENTO M√âDICO ‚Äì CIENTE IE (Parte 1/3) -->
<!-- ================================================= -->
<section id="abaMedico" class="aba hidden relative">

  <!-- üîπ BOT√ÉO FIXO -->
  <div class="sticky top-0 bg-white z-50 py-3 text-center shadow-md border-b mb-6">
    <button id="btnToggleMedico" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg shadow">
      + Cadastrar Caso M√©dico
    </button>
  </div>

  <!-- üîπ FORMUL√ÅRIO (OCULTO POR PADR√ÉO) -->
  <div id="formMedico" class="hidden animate-fadeIn max-w-5xl mx-auto bg-white rounded-2xl shadow p-6 mb-8">
    <h2 class="text-lg font-semibold mb-4 text-gray-700 text-center">Cadastrar Novo Caso M√©dico</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium mb-1">Atleta</label>
        <select id="medicoAtleta" class="border p-2 rounded w-full bg-gray-50 shadow-sm"></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Equipe</label>
        <select id="medicoEquipe" class="border p-2 rounded w-full bg-gray-50 shadow-sm"></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Data do Diagn√≥stico</label>
        <input type="date" id="medicoData" class="border p-2 rounded w-full bg-gray-50 shadow-sm">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Tipo de Les√£o</label>
        <input type="text" id="medicoLesao" placeholder="Ex: Distens√£o, Tor√ß√£o, Contus√£o..." class="border p-2 rounded w-full bg-gray-50 shadow-sm">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Gravidade</label>
        <select id="medicoGravidade" class="border p-2 rounded w-full bg-gray-50 shadow-sm">
          <option value="">Selecione</option>
          <option>Leve</option>
          <option>Moderada</option>
          <option>Grave</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Status</label>
        <select id="medicoStatus" class="border p-2 rounded w-full bg-gray-50 shadow-sm">
          <option value="">Selecione</option>
          <option>Em tratamento</option>
          <option>Liberado</option>
          <option>Observa√ß√£o</option>
          <option>Transi√ß√£o</option>
        </select>
      </div>
    </div>

    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Queixa do Atleta</label>
      <textarea id="medicoQueixa" rows="2" placeholder="Descri√ß√£o da queixa relatada pelo atleta..." class="border p-2 rounded w-full bg-gray-50 shadow-sm"></textarea>
    </div>

    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Observa√ß√µes Gerais</label>
      <textarea id="medicoObs" rows="2" placeholder="Observa√ß√µes complementares, procedimentos, evolu√ß√£o..." class="border p-2 rounded w-full bg-gray-50 shadow-sm"></textarea>
    </div>

    <div class="text-center mt-6">
      <button id="btnSalvarMedico" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg shadow">
        üíæ Salvar Caso
      </button>
    </div>
  </div>

  <!-- üîπ CARDS DE STATUS -->
  <div class="max-w-6xl mx-auto grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-center">
    <div id="cardEmTratamento" class="bg-yellow-400 text-white rounded-xl shadow p-4">
      <p class="text-sm font-medium">Em tratamento</p>
      <p class="text-2xl font-bold" id="contEmTratamento">0</p>
    </div>
    <div id="cardLiberado" class="bg-green-500 text-white rounded-xl shadow p-4">
      <p class="text-sm font-medium">Liberado</p>
      <p class="text-2xl font-bold" id="contLiberado">0</p>
    </div>
    <div id="cardObservacao" class="bg-blue-500 text-white rounded-xl shadow p-4">
      <p class="text-sm font-medium">Observa√ß√£o</p>
      <p class="text-2xl font-bold" id="contObservacao">0</p>
    </div>
    <div id="cardTransicao" class="bg-orange-400 text-white rounded-xl shadow p-4">
      <p class="text-sm font-medium">Transi√ß√£o</p>
      <p class="text-2xl font-bold" id="contTransicao">0</p>
    </div>
  </div>

  <!-- üîπ FILTROS -->
  <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div>
      <label class="block text-sm font-medium mb-1">Equipe</label>
      <select id="filtroEquipeMedico" class="border p-2 rounded w-full bg-white shadow-sm"></select>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Status</label>
      <select id="filtroStatusMedico" class="border p-2 rounded w-full bg-white shadow-sm">
        <option value="todos">Todos</option>
        <option>Em tratamento</option>
        <option>Liberado</option>
        <option>Observa√ß√£o</option>
        <option>Transi√ß√£o</option>
      </select>
    </div>
  </div>

  <!-- üîπ TABELA DE CASOS -->
  <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6 mb-12 overflow-x-auto">
    <h2 class="text-lg font-semibold text-gray-700 mb-3 text-center">Casos M√©dicos Registrados</h2>
    <table class="w-full text-sm text-center border rounded-lg">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="p-2">Atleta</th>
          <th class="p-2">Equipe</th>
          <th class="p-2">Data</th>
          <th class="p-2">Tipo de Les√£o</th>
          <th class="p-2">Gravidade</th>
          <th class="p-2">Status</th>
          <th class="p-2">Dias Afastado</th>
          <th class="p-2">Observa√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaMedico" class="text-gray-700"></tbody>
    </table>
  </div>
<!-- ================================================= -->
<!-- ‚öôÔ∏è SCRIPT ‚Äì Departamento M√©dico (Parte 2/3) -->
<!-- ================================================= -->
<script type="module">
  import {
    getFirestore, collection, addDoc, getDocs, onSnapshot,
    updateDoc, doc, serverTimestamp, query, orderBy
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  const db = getFirestore();

  // --- Refer√™ncias de UI
  const btnToggleMedico = document.getElementById("btnToggleMedico");
  const formMedico = document.getElementById("formMedico");

  const selAtleta = document.getElementById("medicoAtleta");
  const selEquipe  = document.getElementById("medicoEquipe");
  const inpData    = document.getElementById("medicoData");
  const inpLesao   = document.getElementById("medicoLesao");
  const selGrav    = document.getElementById("medicoGravidade");
  const selStatus  = document.getElementById("medicoStatus");
  const txtQueixa  = document.getElementById("medicoQueixa");
  const txtObs     = document.getElementById("medicoObs");
  const btnSalvar  = document.getElementById("btnSalvarMedico");

  const tblBody    = document.getElementById("tabelaMedico");

  const cardEmTratamento = document.getElementById("contEmTratamento");
  const cardLiberado     = document.getElementById("contLiberado");
  const cardObservacao   = document.getElementById("contObservacao");
  const cardTransicao    = document.getElementById("contTransicao");

  const filtroEquipeMed  = document.getElementById("filtroEquipeMedico");
  const filtroStatusMed  = document.getElementById("filtroStatusMedico");

  // --- Cole√ß√µes
  const colCasos = collection(db, "departamento_medico");
  const colProntidao = collection(db, "prontidao");

  // --- Toggle do formul√°rio
  btnToggleMedico.addEventListener("click", () => {
    formMedico.classList.toggle("hidden");
    btnToggleMedico.textContent = formMedico.classList.contains("hidden")
      ? "+ Cadastrar Caso M√©dico"
      : "‚úñ Fechar Cadastro";
  });

  // --- Util: diferen√ßa de dias (arredonda para baixo)
  function diffDias(d1, d2) {
    const MS = 24 * 60 * 60 * 1000;
    const a = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate()).getTime();
    const b = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate()).getTime();
    return Math.max(0, Math.floor((b - a) / MS));
  }

  // --- Paleta de status (cores)
  const statusColor = {
    "Em tratamento":  { bg: "#FACC15", text: "#1f2937" }, // amarelo
    "Liberado":       { bg: "#22C55E", text: "#FFFFFF" }, // verde
    "Observa√ß√£o":     { bg: "#3B82F6", text: "#FFFFFF" }, // azul
    "Transi√ß√£o":      { bg: "#FB923C", text: "#1f2937" }  // laranja
  };

  // --- Preenche selects de Atleta e Equipe automaticamente
  async function preencherAtletasEquipes() {
    // Busca de prontidao (mais est√°vel no seu fluxo)
    const snapPr = await getDocs(colProntidao);
    const dadosPr = snapPr.docs.map(d => d.data());

    // Busca dos pr√≥prios casos (para complementar listas)
    const snapDm = await getDocs(colCasos);
    const dadosDm = snapDm.docs.map(d => d.data());

    const atletas = new Set();
    const equipes = new Set();

    [...dadosPr, ...dadosDm].forEach(d => {
      const atleta = d.nome_atleta || d.atleta || d.atleta_id;
      const equipe = d.equipe_id || d.equipe;
      if (atleta && String(atleta).trim()) atletas.add(String(atleta).trim());
      if (equipe && String(equipe).trim()) equipes.add(String(equipe).trim());
    });

    const opt = (v) => `<option>${v}</option>`;
    selAtleta.innerHTML = `<option value="">Selecione</option>${[...atletas].sort().map(opt).join("")}`;
    selEquipe.innerHTML = `<option value="">Selecione</option>${[...equipes].sort().map(opt).join("")}`;

    // Filtros de listagem (equipes)
    filtroEquipeMed.innerHTML = `<option value="todas">Todas</option>${[...equipes].sort().map(opt).join("")}`;
  }

  // --- Salvar novo caso
  btnSalvar.addEventListener("click", async () => {
    const atleta = selAtleta.value.trim();
    const equipe = selEquipe.value.trim();
    const dataDx = inpData.value;
    const lesao  = inpLesao.value.trim();
    const grav   = selGrav.value;
    const status = selStatus.value;
    const queixa = txtQueixa.value.trim();
    const obs    = txtObs.value.trim();

    if (!atleta || !equipe || !dataDx || !lesao || !grav || !status) {
      alert("Preencha Atleta, Equipe, Data, Tipo de Les√£o, Gravidade e Status.");
      return;
    }

    const payload = {
      atleta, equipe,
      data_diagnostico: dataDx, // "YYYY-MM-DD"
      tipo_lesao: lesao,
      gravidade: grav,
      status,
      queixa,
      observacoes: obs,
      criado_em: serverTimestamp()
    };

    // Se j√° salvar como Liberado, j√° registra liberado_em = hoje
    if (status === "Liberado") {
      const hojeISO = new Date().toISOString().split("T")[0];
      payload.liberado_em = hojeISO; // congela contagem
    }

    await addDoc(colCasos, payload);

    // Limpa formul√°rio b√°sico (mant√©m equipe/atleta se quiser)
    inpData.value = "";
    inpLesao.value = "";
    selGrav.value = "";
    selStatus.value = "";
    txtQueixa.value = "";
    txtObs.value = "";

    alert("Caso m√©dico salvo com sucesso!");
  });

  // --- Observa e renderiza lista em tempo real
  onSnapshot(query(colCasos, orderBy("data_diagnostico", "desc")), (qsnap) => {
    const casos = qsnap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderResumoStatus(casos);
    preencherFiltrosSemanaEquipe(casos); // s√≥ equipes aqui; (semana n√£o √© usado)
    aplicarFiltrosERender(casos);
  });

  // --- Resumo dos cards por status
  function renderResumoStatus(casos) {
    const cont = { "Em tratamento": 0, "Liberado": 0, "Observa√ß√£o": 0, "Transi√ß√£o": 0 };
    casos.forEach(c => {
      if (cont[c.status] !== undefined) cont[c.status]++;
    });
    cardEmTratamento.textContent = cont["Em tratamento"];
    cardLiberado.textContent     = cont["Liberado"];
    cardObservacao.textContent   = cont["Observa√ß√£o"];
    cardTransicao.textContent    = cont["Transi√ß√£o"];
  }

  // --- Preenche filtro Equipe (j√° √© feito em preencherAtletasEquipes; aqui garante novas equipes que venham s√≥ de casos)
  function preencherFiltrosSemanaEquipe(casos) {
    const equipes = Array.from(new Set(casos.map(c => c.equipe).filter(Boolean))).sort();
    const atual = filtroEquipeMed.value || "todas";
    filtroEquipeMed.innerHTML = `<option value="todas">Todas</option>${equipes.map(e => `<option ${atual===e?"selected":""}>${e}</option>`).join("")}`;
  }

  // --- Filtros
  filtroEquipeMed.onchange = () => recarregarTabela();
  filtroStatusMed.onchange = () => recarregarTabela();

  let cacheCasos = []; // mant√©m a √∫ltima fornada para re-render r√°pido
  function aplicarFiltrosERender(casos) {
    cacheCasos = casos;
    recarregarTabela();
  }

  function recarregarTabela() {
    let lista = cacheCasos.slice();

    const eq = filtroEquipeMed.value;
    const st = filtroStatusMed.value;

    if (eq && eq !== "todas")  lista = lista.filter(c => c.equipe === eq);
    if (st && st !== "todos")  lista = lista.filter(c => c.status === st);

    renderTabela(lista);
  }

  // --- Renderiza tabela principal
  function renderTabela(casos) {
    if (!casos.length) {
      tblBody.innerHTML = `<tr><td colspan="8" class="p-3 text-gray-400">Nenhum caso cadastrado</td></tr>`;
      return;
    }

    // Ordena por data_diagnostico desc (j√° vem ordenado; s√≥ garante)
    casos.sort((a,b) => (b.data_diagnostico || "").localeCompare(a.data_diagnostico || ""));

    tblBody.innerHTML = casos.map(c => {
      // Dias afastado
      const dataDx = c.data_diagnostico ? new Date(c.data_diagnostico) : null;
      let dias = "-";
      if (dataDx) {
        if (c.status === "Liberado" && c.liberado_em) {
          dias = diffDias(dataDx, new Date(c.liberado_em));
        } else if (c.status !== "Liberado") {
          dias = diffDias(dataDx, new Date());
        }
      }

      const st = c.status || "";
      const sty = statusColor[st] || { bg:"#e5e7eb", text:"#111827" };

      const grav = c.gravidade || "-";
      const lesao = c.tipo_lesao || "-";
      const dataPt = c.data_diagnostico ? new Date(c.data_diagnostico+"T00:00:00").toLocaleDateString("pt-BR") : "-";
      const obs = c.observacoes || "-";

      // Dropdown para mudar status
      const statusSelect = `
        <select data-id="${c.id}" class="status-editor border p-1 rounded w-full"
                style="background:${sty.bg}; color:${sty.text}; font-weight:600">
          ${["Em tratamento","Liberado","Observa√ß√£o","Transi√ß√£o"].map(s =>
            `<option value="${s}" ${s===st?"selected":""}>${s}</option>`
          ).join("")}
        </select>`;

      return `
        <tr class="border-b hover:bg-gray-50">
          <td class="p-2">${c.atleta || "-"}</td>
          <td class="p-2">${c.equipe || "-"}</td>
          <td class="p-2">${dataPt}</td>
          <td class="p-2">${lesao}</td>
          <td class="p-2">${grav}</td>
          <td class="p-2">${statusSelect}</td>
          <td class="p-2">${dias}</td>
          <td class="p-2">${obs}</td>
        </tr>`;
    }).join("");

    // Liga os editores de status
    tblBody.querySelectorAll(".status-editor").forEach(sel => {
      sel.addEventListener("change", async (e) => {
        const id = e.target.getAttribute("data-id");
        const novoStatus = e.target.value;
        const ref = doc(db, "departamento_medico", id);

        const updates = { status: novoStatus };

        // Se virou Liberado agora ‚Üí congela contagem
        if (novoStatus === "Liberado") {
          updates.liberado_em = new Date().toISOString().split("T")[0];
        } else {
          // Se saiu de Liberado para outro ‚Üí remove congelamento para voltar a contar
          updates.liberado_em = null;
        }

        await updateDoc(ref, updates);
      });
    });
  }

  // --- Inicializa
  (async function init() {
    // Data padr√£o hoje
    inpData.value = new Date().toISOString().split("T")[0];
    await preencherAtletasEquipes();
  })();
</script>
<!-- ================================================= -->
<!-- üé® ESTILO FINAL ‚Äì DEPARTAMENTO M√âDICO -->
<!-- ================================================= -->
<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-8px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .animate-fadeIn { animation: fadeIn 0.4s ease-in-out; }

  /* ===== FORM GERAL ===== */
  #formMedico select,
  #formMedico input,
  #formMedico textarea {
    font-size: 0.95rem;
    transition: border 0.2s, box-shadow 0.2s;
  }
  #formMedico select:focus,
  #formMedico input:focus,
  #formMedico textarea:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 2px rgba(37,99,235,0.2);
  }

  /* ===== BOT√ÉO FIXO ===== */
  #btnToggleMedico {
    transition: all 0.25s ease;
  }
  #btnToggleMedico:hover {
    transform: scale(1.03);
  }

  /* ===== CARDS DE STATUS ===== */
  #abaMedico .grid div {
    transition: transform 0.25s ease, box-shadow 0.25s ease;
  }
  #abaMedico .grid div:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
  }
  #cardEmTratamento   { background: #FACC15; color: #1f2937; }
  #cardLiberado       { background: #22C55E; color: #fff; }
  #cardObservacao     { background: #3B82F6; color: #fff; }
  #cardTransicao      { background: #FB923C; color: #1f2937; }

  /* ===== TABELA ===== */
  #abaMedico table {
    border-collapse: collapse;
    width: 100%;
    font-size: 0.9rem;
  }
  #abaMedico th, #abaMedico td {
    border: 1px solid #e5e7eb;
    padding: 0.5rem;
    text-align: center;
  }
  #abaMedico th {
    background-color: #f9fafb;
    font-weight: 600;
  }
  #abaMedico tr:hover {
    background-color: #f3f4f6;
  }

  /* ===== DROPDOWN DE STATUS NA TABELA ===== */
  .status-editor {
    font-weight: 600;
    text-align: center;
    border-radius: 0.4rem;
  }

  /* ===== RESPONSIVIDADE ===== */
  @media (max-width: 768px) {
    #formMedico {
      padding: 1rem;
    }
    #abaMedico table {
      font-size: 0.8rem;
    }
    #btnToggleMedico {
      width: 90%;
    }
  }
</style>

</section>

<!-- ================================================= -->
<!-- üìä ABA DASHBOARD ‚Äì CIENTE IE (vers√£o final sem VFC) -->
<!-- ================================================= -->
<section id="abaDashboard" class="aba">

  <div class="max-w-6xl mx-auto space-y-10">

    <!-- ================================================= -->
    <!-- üè• DEPARTAMENTO M√âDICO -->
    <!-- ================================================= -->
    <div>
      <h2 class="text-2xl font-bold text-blue-800 text-center mb-4">üè• Departamento M√©dico</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Afastados -->
        <div class="bg-red-50 border-l-8 border-red-600 rounded-xl shadow p-5">
          <h3 class="text-lg font-semibold text-red-700 mb-3">ü©∏ Afastados (Em Tratamento)</h3>
          <ul id="listaAfastados" class="text-gray-700 space-y-2 text-sm">
            <li class="text-gray-400 italic">Carregando...</li>
          </ul>
        </div>

        <!-- Transi√ß√£o -->
        <div class="bg-orange-50 border-l-8 border-orange-500 rounded-xl shadow p-5">
          <h3 class="text-lg font-semibold text-orange-700 mb-3">üîÑ Em Transi√ß√£o</h3>
          <ul id="listaTransicao" class="text-gray-700 space-y-2 text-sm">
            <li class="text-gray-400 italic">Carregando...</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- ================================================= -->
    <!-- üß† PRONTID√ÉO -->
    <!-- ================================================= -->
    <div>
      <h2 class="text-2xl font-bold text-blue-800 text-center mb-6">üß† Prontid√£o ‚Äì Estado Atual</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Cr√≠tico -->
        <div class="bg-red-50 border-l-8 border-red-600 rounded-xl shadow p-5">
          <h3 class="text-xl font-semibold text-red-700 mb-3">üö´ Cr√≠tico ‚Äì Considerar n√£o treinar</h3>
          <ul id="listaCritico" class="text-gray-700 space-y-2 text-sm">
            <li class="text-gray-400 italic">Carregando...</li>
          </ul>
        </div>

        <!-- Aten√ß√£o -->
        <div class="bg-yellow-50 border-l-8 border-yellow-500 rounded-xl shadow p-5">
          <h3 class="text-xl font-semibold text-yellow-700 mb-3">‚ö†Ô∏è Aten√ß√£o ‚Äì Monitorar poss√≠vel fadiga</h3>
          <ul id="listaAtencao" class="text-gray-700 space-y-2 text-sm">
            <li class="text-gray-400 italic">Carregando...</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- ================================================= -->
    <!-- üèãÔ∏è CARGA -->
    <!-- ================================================= -->
    <div>
      <h2 class="text-2xl font-bold text-blue-800 text-center mb-4">üèãÔ∏è Carga ‚Äì Distribui√ß√£o</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded-2xl shadow p-5 flex flex-col items-center">
          <h3 class="text-lg font-semibold text-gray-700 text-center mb-3">üìä M√©dia da Carga por Dia</h3>
          <div class="w-full max-w-md h-48">
            <canvas id="graficoMediaPorDia"></canvas>
          </div>
        </div>
        <div class="bg-white rounded-2xl shadow p-5 flex flex-col items-center">
          <h3 class="text-lg font-semibold text-gray-700 text-center mb-3">üìà Total da Carga por Semana</h3>
          <div class="w-full max-w-md h-48">
            <canvas id="graficoTotalPorSemana"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================= -->
    <!-- ü¶∂ RODAP√â -->
    <!-- ================================================= -->
    <p class="text-center text-xs text-gray-500 mt-10 mb-5">
      Powered by <strong>Ciente Intelig√™ncia Esportiva</strong>
    </p>

  </div>

  <!-- ================================================= -->
  <!-- ‚öôÔ∏è SCRIPT DASHBOARD -->
  <!-- ================================================= -->
  <script type="module">
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    const db = getFirestore();

    document.addEventListener("DOMContentLoaded", async () => {
      const hoje = new Date();

      // =====================================================
      // üè• DEPARTAMENTO M√âDICO
      // =====================================================
      const snapMedico = await getDocs(collection(db, "departamento_medico"));
      const medico = snapMedico.docs.map(d => d.data());

      const diasDecorridos = (obj) => {
        const camposData = ["data", "data_diagnostico", "inicio_tratamento", "data_inicio"];
        for (let campo of camposData) {
          if (obj[campo]) {
            const dt = new Date(obj[campo] + "T00:00:00");
            const diff = Math.floor((hoje - dt) / (1000 * 60 * 60 * 24));
            return diff > 0 ? diff : 0;
          }
        }
        return 0;
      };

      const afastados = medico.filter(d => d.status === "Em tratamento");
      const transicao = medico.filter(d => d.status === "Transi√ß√£o");

      const renderLista = (dados, id) => {
        const ul = document.getElementById(id);
        ul.innerHTML = dados.length
          ? dados.map(a => `
              <li class="border-b border-gray-200 pb-1">
                <strong>${a.atleta || "Sem nome"}</strong> ‚Äì ${a.equipe_id || "-"}<br>
                <span class="text-xs text-gray-500">Dias no status: ${diasDecorridos(a)}</span>
              </li>
            `).join("")
          : "<li class='text-gray-400 italic'>Nenhum atleta</li>";
      };

      renderLista(afastados, "listaAfastados");
      renderLista(transicao, "listaTransicao");

      // =====================================================
      // üß† PRONTID√ÉO
      // =====================================================
      const atualizarProntidao = () => {
        const dados = window.__dadosResumo || [];
        if (!dados.length) return;

        const critico = dados.filter(d => d.igpPct < -10 || d.hooper > 17);
        const atencao = dados.filter(d =>
          (d.igpPct >= -10 && d.igpPct < -5) || (d.hooper >= 12 && d.hooper <= 17)
        );

        const gerar = lista => lista.length
          ? lista.map(d => `
              <li class="border-b border-gray-200 pb-1">
                <strong>${d.atleta}</strong> ‚Äì ${d.equipe}<br>
                <span class="text-xs text-gray-500">
                  IGP: ${d.igpPct?.toFixed(1) || "-"}% | Hooper: ${d.hooper?.toFixed(0) || "-"}
                </span>
              </li>
            `).join("")
          : "<li class='text-gray-400 italic'>Nenhum atleta</li>";

        listaCritico.innerHTML = gerar(critico);
        listaAtencao.innerHTML = gerar(atencao);
      };

      const checar = setInterval(() => {
        if (window.__dadosResumo) {
          clearInterval(checar);
          atualizarProntidao();
        }
      }, 1000);

      // =====================================================
      // üèãÔ∏è CARGA ‚Äì GR√ÅFICOS
      // =====================================================
      const snapCarga = await getDocs(collection(db, "carga"));
      const carga = snapCarga.docs.map(d => d.data());

      const dias = ["Seg", "Ter", "Qua", "Qui", "Sex", "S√°b", "Dom"];
      const somaPorDia = Array(7).fill(0);
      const contPorDia = Array(7).fill(0);

      carga.forEach(c => {
        if (!c.data) return;
        const dia = new Date(c.data + "T00:00:00").getDay();
        const idx = (dia + 6) % 7;
        const pse = Number(c.pse_sessao || c.pse || 0);
        const tempo = Number(c.duracao_sessao_min || c.tempo || 0);
        const valor = pse * tempo;
        somaPorDia[idx] += valor;
        contPorDia[idx]++;
      });

      const mediaPorDia = somaPorDia.map((s, i) => contPorDia[i] ? s / contPorDia[i] : 0);
      const totalSemanal = mediaPorDia.reduce((a, b) => a + b, 0);

      new Chart(document.getElementById("graficoMediaPorDia"), {
        type: "bar",
        data: {
          labels: dias,
          datasets: [{
            data: mediaPorDia,
            backgroundColor: "#3b82f6",
            borderRadius: 5,
            barPercentage: 0.5,
            categoryPercentage: 0.6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: "Carga M√©dia" } },
            x: { title: { display: true, text: "Dia da Semana" } }
          }
        }
      });

      new Chart(document.getElementById("graficoTotalPorSemana"), {
        type: "bar",
        data: {
          labels: ["Semana Atual"],
          datasets: [{
            data: [totalSemanal],
            backgroundColor: "#10b981",
            borderRadius: 5,
            barPercentage: 0.4,
            categoryPercentage: 0.6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: "Carga Total" } },
            x: { title: { display: true, text: "Semana" } }
          }
        }
      });
    });
  </script>
</section>


</body>
</html>
