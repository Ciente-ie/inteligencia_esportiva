<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ciente IE - Plataforma Integrada</title>

  <!-- ‚úÖ Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ‚úÖ Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // --- Configura√ß√£o Firebase ---
    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "appintegrado-ciente.firebaseapp.com",
      projectId: "appintegrado-ciente",
      storageBucket: "appintegrado-ciente.appspot.com",
      messagingSenderId: "XXX",
      appId: "XXX"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // =====================================================
    // üß≠ TROCA DE ABAS
    // =====================================================
    function mostrarAba(aba) {
      document.querySelectorAll(".aba").forEach(div => div.classList.add("hidden"));
      document.querySelector(`#${aba}`).classList.remove("hidden");

      document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("bg-blue-600", "text-white", "shadow"));
      document.querySelector(`[data-aba='${aba}']`).classList.add("bg-blue-600", "text-white", "shadow");
    }

    // =====================================================
// üß© CARREGAR DADOS PRONTID√ÉO (com processamento completo)
// =====================================================
async function carregarProntidao() {
  try {
    const snap = await getDocs(collection(db, "prontidao"));
    const dados = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    // üîπ Normaliza os campos (garante nomes e formatos padronizados)
    dados.forEach(d => {
      d.atleta = d.nome_atleta || d.atleta_id || "Sem nome";
      d.equipe = d.equipe_id || d.equipe || "Sem equipe";
      d.posicao = d.posicao_grupo || "N√£o definida";
      d.data = d.data || "2025-01-01";
      d.sono = parseInt(d.sono || d.qualidade_sono || 0);
      d.estresse = parseInt(d.estresse || d.niveis_stress || 0);
      d.fadiga = parseInt(d.fadiga || d.fadiga_geral || 0);
      d.dor = parseInt(d.dor || d.dor_muscular || 0);
      d.salto = parseFloat(d.salto || 0);
      d.vfc = parseFloat(d.vfc || d.rmssd || 0);
      d.hooper = d.sono + d.estresse + d.fadiga + d.dor;
    });

    // üîπ Agrupa os registros por atleta
    const atletas = {};
    dados.forEach(d => {
      if (!atletas[d.atleta]) atletas[d.atleta] = [];
      atletas[d.atleta].push(d);
    });

    // üîπ Para cada atleta, seleciona o √∫ltimo registro (data mais recente)
    const resumo = [];
    for (const atleta in atletas) {
      const registros = atletas[atleta].sort(
        (a, b) => new Date(b.data) - new Date(a.data)
      );
      const ultimo = registros[0]; // √∫ltimo registro (mais recente)
      const medias = calcularMedias(registros);
      const variacoes = calcularVariacoes(ultimo, medias);
      resumo.push({
        atleta,
        equipe: ultimo.equipe,
        posicao: ultimo.posicao,
        data: ultimo.data,
        hooper: ultimo.hooper,
        ...variacoes
      });
    }

    // üîπ Salva globalmente para o Dashboard
    window.__dadosProntidao = dados;
    window.__dadosResumo = resumo;

    console.log("‚úÖ Prontid√£o carregada (√∫ltimo registro por atleta):", resumo.length);
  } catch (e) {
    console.error("Erro ao carregar Prontid√£o:", e);
  }
}


function calcularMedias(registros) {
  const n = registros.length;
  const media = (arr, key) => arr.reduce((a, b) => a + (b[key] || 0), 0) / n;
  return {
    vfc: media(registros, "vfc"),
    salto: media(registros, "salto"),
    hooper: media(registros, "hooper")
  };
}

function calcularVariacoes(ultimo, medias) {
  const vfcPct = ((ultimo.vfc - medias.vfc) / medias.vfc) * 100 || 0;
  const saltoPct = ((ultimo.salto - medias.salto) / medias.salto) * 100 || 0;
  const hooperPct = ((ultimo.hooper - medias.hooper) / medias.hooper) * 100 || 0;

  // üîÑ Inverte o sinal do Hooper (maior Hooper = pior prontid√£o)
  const hooperInvertido = hooperPct * -1;

  // üßÆ C√°lculo final do IGP equilibrado
  const igpPct = (vfcPct + saltoPct + hooperInvertido) / 3;

  return { vfcPct, saltoPct, igpPct };
}


    // =================================================
// üèãÔ∏è CARREGAR DADOS CARGA
// =================================================
async function carregarCarga() {
  const snap = await getDocs(collection(db, "carga"));
  const dados = snap.docs.map(doc => doc.data());

  const normalizados = dados.map(d => ({
    atleta: d.atleta_id,
    equipe: d.equipe_id,
    posicao: d.posicao_grupo,
    data: d.data,
    pse: Number(d.pse_sessao) || 0,
    tempo: Number(d.duracao_sessao_min) || 0,
    micro: d.microciclo_id || ""
  }));

  renderTabelaCarga(normalizados);
  
  // üîπ Torna os dados acess√≠veis globalmente para o dashboard
  window.__dadosCarga = normalizados;
}

    // =====================================================
    // üî¢ C√ÅLCULOS CARGA
    // =====================================================
    function renderCardsCarga(dados) {
      const semanas = agruparPorSemana(dados);
      const ult = semanas[semanas.length - 1];
      const prev = semanas.slice(-4);

      const cargaSemana = ult.reduce((s, x) => s + x.pse * x.tempo, 0);
      const media4 = prev.length ? prev.reduce((t, sem) => t + sem.reduce((s, x) => s + x.pse * x.tempo, 0), 0) / prev.length : cargaSemana;
      const acwr = media4 ? (cargaSemana / media4).toFixed(2) : 1;

      document.getElementById("cardCargaSemana").innerHTML = cargaSemana.toFixed(0);
      document.getElementById("cardMedia4").innerHTML = media4.toFixed(0);
      document.getElementById("cardACWR").innerHTML = acwr;

      const corACWR =
        acwr < 0.8 ? "text-blue-600" :
        acwr <= 1.3 ? "text-green-600" :
        acwr <= 1.5 ? "text-yellow-500" :
        "text-red-600";

      document.getElementById("cardACWR").className = "text-3xl font-bold mt-2 " + corACWR;
    }

    function agruparPorSemana(dados) {
      const porSemana = {};
      dados.forEach(d => {
        const dt = new Date(d.data + "T00:00:00");
        const diaSemana = (dt.getDay() + 6) % 7; // segunda=0
        const segunda = new Date(dt);
        segunda.setDate(dt.getDate() - diaSemana);
        const key = segunda.toISOString().split("T")[0];
        porSemana[key] = porSemana[key] || [];
        porSemana[key].push(d);
      });
      return Object.values(porSemana);
    }

    // =====================================================
    // üìã TABELA DE CARGA
    // =====================================================
    function renderTabelaCarga(dados) {
      const corpo = document.getElementById("tabelaCarga");
      corpo.innerHTML = dados.map(d => {
        const carga = d.pse * d.tempo;
        return `
          <tr class="border-b hover:bg-gray-50">
            <td class="p-2 font-semibold text-blue-700">${d.atleta}</td>
            <td class="p-2 text-center">${d.equipe}</td>
            <td class="p-2 text-center">${d.posicao}</td>
            <td class="p-2 text-center">${d.data}</td>
            <td class="p-2 text-center">${d.pse}</td>
            <td class="p-2 text-center">${d.tempo}</td>
            <td class="p-2 text-center font-bold text-gray-700">${carga}</td>
          </tr>`;
      }).join("");
    }

    // =====================================================
    // üöÄ INICIALIZA√á√ÉO
    // =====================================================
    document.addEventListener("DOMContentLoaded", async () => {
      document.querySelectorAll(".tab-btn").forEach(btn =>
        btn.addEventListener("click", () => mostrarAba(btn.dataset.aba))
      );

      // Aba padr√£o (no futuro ser√° Dashboard)
      mostrarAba("abaDashboard");

      await carregarProntidao();
      await carregarCarga();
    });
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; background: #f9fafb; color: #111827; }
    .hidden { display: none; }
    .tab-btn { transition: all 0.2s ease; }
    .tab-btn:hover { background-color: #2563eb; color: white; }
    .card-indicador { transition: transform 0.2s ease; }
    .card-indicador:hover { transform: scale(1.03); }
  </style>
</head>

<body class="p-6">
  <header class="max-w-7xl mx-auto mb-6 flex items-center justify-center space-x-3">
    <img src="https://cdn-icons-png.flaticon.com/512/3616/3616796.png" class="w-8 h-8" alt="logo">
    <h1 class="text-2xl font-bold text-blue-800">Plataforma Integrada - Ciente IE</h1>
  </header>

  <!-- üß≠ Navega√ß√£o de Abas -->
  <nav class="flex justify-center space-x-4 mb-8">
  <button data-aba="abaDashboard" class="tab-btn px-5 py-2 rounded-lg bg-gray-200 text-gray-800">Dashboard</button>
  <button data-aba="abaProntidao" class="tab-btn px-5 py-2 rounded-lg bg-gray-200 text-gray-800">Prontid√£o</button>
  <button data-aba="abaCarga" class="tab-btn px-5 py-2 rounded-lg bg-gray-200 text-gray-800">Carga</button>
  <button data-aba="abaPlanejamento" class="tab-btn px-5 py-2 rounded-lg bg-gray-200 text-gray-800">Planejamento</button>
  <button data-aba="abaMedico" class="tab-btn px-5 py-2 rounded-lg bg-gray-200 text-gray-800">Departamento M√©dico</button>
</nav>


    

  <!-- ================================================= -->
<!-- üß† ABA PRONTID√ÉO ‚Äì CIENTE IE -->
<!-- ================================================= -->
<section id="abaProntidao" class="aba">

  <!-- üîπ FILTROS -->
  <div class="max-w-6xl mx-auto mt-6 px-4 flex flex-col md:flex-row gap-4 justify-center">
    <div>
      <label class="block font-medium mb-1">Equipe</label>
      <select id="filtroEquipe" class="border p-2 rounded w-56 bg-white shadow-sm"></select>
    </div>
    <div>
      <label class="block font-medium mb-1">Posi√ß√£o</label>
      <select id="filtroPosicao" class="border p-2 rounded w-56 bg-white shadow-sm">
        <option value="todos">Todas</option>
      </select>
    </div>
    <div>
      <label class="block font-medium mb-1">Atleta</label>
      <select id="filtroAtleta" class="border p-2 rounded w-56 bg-white shadow-sm">
        <option value="todos">Todos</option>
      </select>
    </div>
    <!--
<div>
  <label class="block font-medium mb-1">Semana</label>
  <select id="filtroSemana" class="border p-2 rounded w-56 bg-white shadow-sm">
    <option value="todas">Todas</option>
  </select>
</div>
-->
  </div>

  <!-- üîπ CARDS PRINCIPAIS -->
  <div class="max-w-6xl mx-auto mt-8 px-4 grid grid-cols-1 md:grid-cols-3 gap-6">
    <div id="cardIGP" class="bg-white rounded-2xl shadow p-5 border-t-4 border-purple-500 text-center">
      <h2 class="text-lg font-semibold text-gray-700">√çndice Geral de Prontid√£o (IGP%)</h2>
      <p id="valorIGP" class="text-3xl mt-2 font-bold">--%</p>
      <p class="text-sm text-gray-500 mt-1">√öltima semana</p>
    </div>
    <div id="cardVFC" class="bg-white rounded-2xl shadow p-5 border-t-4 border-blue-500 text-center">
      <h2 class="text-lg font-semibold text-gray-700">Prontid√£o Fisiol√≥gica (VFC%)</h2>
      <p id="valorVFC" class="text-3xl mt-2 font-bold">--%</p>
      <p class="text-sm text-gray-500 mt-1">√öltima semana</p>
    </div>
    <div id="cardSalto" class="bg-white rounded-2xl shadow p-5 border-t-4 border-green-500 text-center">
      <h2 class="text-lg font-semibold text-gray-700">Prontid√£o Muscular (Salto%)</h2>
      <p id="valorSalto" class="text-3xl mt-2 font-bold">--%</p>
      <p class="text-sm text-gray-500 mt-1">√öltima semana</p>
    </div>    
  </div>

  <!-- üîπ LEGENDA -->
  <div class="text-center text-sm text-gray-600 mt-2">
    <span class="inline-block mx-3">üü¢ <strong>Acima da M√©dia</strong> (&gt; +5%)</span>
    <span class="inline-block mx-3">üîµ <strong>Est√°vel</strong> (entre -5% e +5%)</span>
    <span class="inline-block mx-3">üü° <strong>Aten√ß√£o</strong> (entre -10% e -5%)</span>
    <span class="inline-block mx-3">üî¥ <strong>Abaixo da M√©dia</strong> (&lt; -10%)</span>
  </div>

  <!-- üîπ TABELA PRINCIPAL -->
  <div class="max-w-6xl mx-auto mt-8 px-4">
    <div class="bg-white rounded-lg shadow-md overflow-x-auto border">
      <table id="tabelaAtletas" class="min-w-full text-sm text-gray-700">
        <thead class="bg-blue-100">
          <tr>
            <th class="p-2 text-left">Atleta</th>
            <th class="p-2 text-center">Equipe</th>
            <th class="p-2 text-center">Posi√ß√£o</th>
            <th class="p-2 text-center">Data</th>
            <th class="p-2 text-center">Hooper (Soma)</th>
            <th class="p-2 text-center">VFC%</th>
            <th class="p-2 text-center">Salto%</th>
            <th class="p-2 text-center">IGP%</th>
          </tr>
        </thead>
        <tbody id="corpoTabela"></tbody>
      </table>
    </div>
  </div>

  <!-- üîπ DETALHES DO ATLETA -->
  <div id="detalhesContainer" class="max-w-6xl mx-auto mt-8 px-4 space-y-8"></div>

  <!-- üîπ SCRIPT PRINCIPAL -->
    <script type="module">
    import { getFirestore, collection, getDocs, query, orderBy } 
    from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // üîπ Reaproveita o app j√° inicializado globalmente
    import { getApps, getApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    const app = getApps().length ? getApp() : null;
    if (!app) {
      console.error("‚ö†Ô∏è Firebase App n√£o encontrado. Verifique se a inicializa√ß√£o principal est√° antes desta aba.");
    }

    const db = getFirestore(app);

    async function carregarDados() {
      const q = query(collection(db, "prontidao"), orderBy("data", "desc"));
      const snapshot = await getDocs(q);
      const dados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      processarDados(dados);
    }

    function processarDados(dados) {
      dados.forEach(d => {
        d.atleta = d.nome_atleta || d.atleta_id || "Sem nome";
        d.equipe = d.equipe_id || d.equipe || "Sem equipe";
        d.posicao = d.posicao_grupo || "N√£o definida";
        d.data = d.data || "2025-01-01";
        d.sono = parseInt(d.sono || d.qualidade_sono || 0);
        d.estresse = parseInt(d.estresse || d.niveis_stress || 0);
        d.fadiga = parseInt(d.fadiga || d.fadiga_geral || 0);
        d.dor = parseInt(d.dor || d.dor_muscular || 0);
        d.salto = parseFloat(d.salto || 0);
        d.vfc = parseFloat(d.vfc || 0);
        d.hooper = d.sono + d.estresse + d.fadiga + d.dor;
      });

      const atletas = {};
      dados.forEach(d => {
        if (!atletas[d.atleta]) atletas[d.atleta] = [];
        atletas[d.atleta].push(d);
      });

      const resumo = [];
      for (const atleta in atletas) {
        const registros = atletas[atleta];
        const medias = calcularMedias(registros);
        const ultimo = registros[0];
        const variacoes = calcularVariacoes(ultimo, medias);
        resumo.push({
          atleta,
          equipe: ultimo.equipe,
          posicao: ultimo.posicao,
          data: ultimo.data,
          hooper: ultimo.hooper,
          ...variacoes
        });
      }

      preencherFiltros(dados);
      renderTabela(resumo);
      renderCards(resumo);
      window.__dadosResumo = resumo;
      window.__dadosBrutos = dados;
    }

    function calcularMedias(registros) {
      const n = registros.length;
      const media = (arr, key) => arr.reduce((a, b) => a + (b[key] || 0), 0) / n;
      return {
        vfc: media(registros, "vfc"),
        salto: media(registros, "salto"),
        hooper: media(registros, "hooper")
      };
    }

    function calcularVariacoes(ultimo, medias) {
      const vfcPct = ((ultimo.vfc - medias.vfc) / medias.vfc) * 100 || 0;
      const saltoPct = ((ultimo.salto - medias.salto) / medias.salto) * 100 || 0;
      const hooperPct = ((ultimo.hooper - medias.hooper) / medias.hooper) * 100 || 0;
      const hooperInvertido = hooperPct * -1;
// üìä C√°lculo IGP ‚Äì Modelo Est√°vel (ponderado)
const pesos = { vfc: 0.4, salto: 0.4, hooper: 0.2 };

const igpPct =
  (pesos.vfc * vfcPct) +
  (pesos.salto * saltoPct) -
  (pesos.hooper * hooperPct);

      return { vfcPct, saltoPct, igpPct };
    }

    function classeCor(valor) {
      if (valor > 5) return "text-green-600 font-bold";
      if (valor >= -5 && valor <= 5) return "text-blue-600 font-bold";
      if (valor >= -10 && valor < -5) return "text-yellow-500 font-bold";
      if (valor < -10) return "text-red-600 font-bold";
      return "text-gray-600";
    }

    function preencherFiltros(dados) {
      const equipes = [...new Set(dados.map(d => d.equipe))];
      const posicoes = [...new Set(dados.map(d => d.posicao))];
      const atletas = [...new Set(dados.map(d => d.atleta))];
      document.getElementById("filtroEquipe").innerHTML =
        "<option value='todos'>Todas</option>" + equipes.map(e => `<option>${e}</option>`).join("");
      document.getElementById("filtroPosicao").innerHTML =
        "<option value='todos'>Todas</option>" + posicoes.map(p => `<option>${p}</option>`).join("");
      document.getElementById("filtroAtleta").innerHTML =
        "<option value='todos'>Todos</option>" + atletas.map(a => `<option>${a}</option>`).join("");
      ["filtroEquipe", "filtroPosicao", "filtroAtleta"].forEach(id =>
        document.getElementById(id).addEventListener("change", aplicarFiltros)
      );
    }

    function aplicarFiltros() {
      const eq = document.getElementById("filtroEquipe").value;
      const po = document.getElementById("filtroPosicao").value;
      const at = document.getElementById("filtroAtleta").value;
      let filtrados = window.__dadosResumo;
      if (eq !== "todos") filtrados = filtrados.filter(d => d.equipe === eq);
      if (po !== "todos") filtrados = filtrados.filter(d => d.posicao === po);
      if (at !== "todos") filtrados = filtrados.filter(d => d.atleta === at);
      renderTabela(filtrados);
      renderCards(filtrados);
    }

    function renderTabela(resumo) {
      resumo.sort((a, b) => b.igpPct - a.igpPct);
      const corpo = document.getElementById("corpoTabela");
      corpo.innerHTML = resumo.map(d => {
        const f = v => (v >= 0 ? "+" : "") + v.toFixed(1) + "%";
        let corHooper = "bg-green-500";
        if (d.hooper >= 11 && d.hooper <= 17) corHooper = "bg-yellow-400";
        if (d.hooper > 17) corHooper = "bg-red-500";
        return `
          <tr class="border-b hover:bg-gray-50 cursor-pointer" data-atleta="${d.atleta}">
            <td class="p-2 font-semibold text-blue-700">${d.atleta}</td>
            <td class="p-2 text-center text-gray-600">${d.equipe}</td>
            <td class="p-2 text-center text-gray-600">${d.posicao}</td>
            <td class="p-2 text-center text-gray-600">${d.data}</td>
            <td class="p-2 text-center">
              <span class="${corHooper} text-white font-bold rounded-full px-3 py-1 inline-block w-10 h-10 flex items-center justify-center mx-auto">
                ${d.hooper.toFixed(0)}
              </span>
            </td>
            <td class="p-2 text-center ${classeCor(d.vfcPct)}">${f(d.vfcPct)}</td>
            <td class="p-2 text-center ${classeCor(d.saltoPct)}">${f(d.saltoPct)}</td>
            <td class="p-2 text-center ${classeCor(d.igpPct)}">${f(d.igpPct)}</td>
          </tr>`;
      }).join("");
      corpo.querySelectorAll("tr").forEach(tr =>
        tr.addEventListener("click", () => abrirDetalhes(tr.dataset.atleta))
      );
    }

    function renderCards(resumo) {
      const avg = (arr, k) => arr.reduce((a, b) => a + (b[k] || 0), 0) / arr.length;
      const set = (id, v) => {
        const el = document.getElementById("valor" + id.replace("card", ""));
        const s = v >= 0 ? "+" : "";
        el.textContent = `${s}${v.toFixed(1)}%`;
        el.className = v > 10 ? "text-green-600 text-3xl mt-2 font-bold"
          : v < -10 ? "text-red-600 text-3xl mt-2 font-bold"
          : "text-blue-600 text-3xl mt-2 font-bold";
      };
      set("cardVFC", avg(resumo, "vfcPct"));
      set("cardSalto", avg(resumo, "saltoPct"));
      set("cardIGP", avg(resumo, "igpPct"));
    }

    function abrirDetalhes(nome) {
      const c = document.getElementById("detalhesContainer");
      c.innerHTML = "";
      const r = window.__dadosBrutos.filter(d => d.nome_atleta === nome || d.atleta_id === nome)
        .sort((a, b) => new Date(a.data) - new Date(b.data));
      if (!r.length) return;
      const u = r[r.length - 1];
      c.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <h3 class="text-xl font-semibold text-blue-700">${nome} ‚Äì ${u.equipe} (${u.posicao})</h3>
          <button onclick="fecharDetalhes()" class="bg-red-600 text-white px-3 py-1 rounded shadow hover:bg-red-700">Fechar</button>
        </div>
        <div class="bg-white p-4 rounded-lg shadow border">
          <p><strong>√öltima Data:</strong> ${u.data}</p>
          <p><strong>Sono:</strong> ${u.sono} | <strong>Estresse:</strong> ${u.estresse} | <strong>Fadiga:</strong> ${u.fadiga} | <strong>Dor:</strong> ${u.dor}</p>
          <p><strong>VFC:</strong> ${u.vfc.toFixed(1)} | <strong>Salto:</strong> ${u.salto.toFixed(1)} | <strong>Hooper:</strong> ${u.hooper.toFixed(1)}</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <div class="h-60"><canvas id="graficoVFC"></canvas></div>
          <div class="h-60"><canvas id="graficoSalto"></canvas></div>
          <div class="h-60"><canvas id="graficoIGP"></canvas></div>
        </div>`;
      gerarGraficos(nome);
      c.scrollIntoView({ behavior: "smooth" });
    }

    window.fecharDetalhes = () => {
      document.getElementById("detalhesContainer").innerHTML = "";
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    carregarDados();
  </script>

  <script>
  // ‚úÖ Fun√ß√£o auxiliar para m√©dias (reutilizada do processamento principal)
  function calcularMedias(registros) {
    const n = registros.length || 1;
    const media = (arr, key) => arr.reduce((a, b) => a + (b[key] || 0), 0) / n;
    return {
      vfc: media(registros, "vfc"),
      salto: media(registros, "salto"),
      hooper: media(registros, "hooper")
    };
  }

  // ‚úÖ Gera√ß√£o dos gr√°ficos
  function gerarGraficos(nome) {
    const registros = window.__dadosBrutos
      .filter(d => d.nome_atleta === nome || d.atleta_id === nome)
      .sort((a, b) => new Date(a.data) - new Date(b.data));
    if (!registros.length) return;

    const l = registros.map(x => x.data);
    const v = registros.map(x => x.vfc);     // VFC bruto (ms)
    const s = registros.map(x => x.salto);   // Salto bruto (cm)

    // üîπ Calcula varia√ß√µes para o IGP com a mesma f√≥rmula da tabela
    const medias = calcularMedias(registros);
    const i = registros.map(x => {
      const vfcPct = ((x.vfc - medias.vfc) / medias.vfc) * 100 || 0;
      const saltoPct = ((x.salto - medias.salto) / medias.salto) * 100 || 0;
      const hooperPct = ((x.hooper - medias.hooper) / medias.hooper) * 100 || 0;
      const hooperInvertido = hooperPct * -1;
      return (vfcPct + saltoPct + hooperInvertido) / 3;
    });

    // üîπ Renderiza gr√°ficos
    criarMiniGraficoBruto("graficoVFC", l, v, "VFC (ms)", "#3b82f6");
    criarMiniGraficoBruto("graficoSalto", l, s, "Altura do Salto (cm)", "#10b981");
    criarMiniGraficoPercentual("graficoIGP", l, i, "IGP (%)", "#8b5cf6");
  }

  // ===============================
  // üìà Gr√°ficos de valores brutos
  // ===============================
  function criarMiniGraficoBruto(id, l, d, t, cor) {
    const canvas = document.getElementById(id);
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: l,
        datasets: [{
          label: t,
          data: d,
          borderColor: cor,
          backgroundColor: cor + "33",
          borderWidth: 2,
          tension: 0.3,
          fill: true,
          pointRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
  min: 0,
  max: 100,
  title: { display: true, text: t, color: "#374151", font: { size: 12 } },
  ticks: { color: "#4b5563", font: { size: 11 }, stepSize: 10 },
  grid: { color: "#e5e7eb" }
},
          x: {
            ticks: { color: "#4b5563", font: { size: 11 } },
            grid: { display: false }
          }
        },
        plugins: {
          legend: { display: false },
          title: { display: true, text: t, color: "#374151", font: { size: 13, weight: "bold" } },
          tooltip: { callbacks: { label: c => `${c.parsed.y.toFixed(1)}` } }
        }
      }
    });
  }

  // ===============================
  // üìä Gr√°fico percentual do IGP (-30% a +30%)
  // ===============================
  function criarMiniGraficoPercentual(id, l, d, t, cor) {
    const canvas = document.getElementById(id);
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const cores = d.map(v => v > 10 ? "#16a34a" : v < -10 ? "#dc2626" : "#3b82f6");
    new Chart(ctx, {
      type: "bar",
      data: { labels: l, datasets: [{ data: d, backgroundColor: cores, borderRadius: 5 }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            min: -30, max: 30,
            title: { display: true, text: "% vs m√©dia pessoal" },
            ticks: {
              color: "#4b5563", font: { size: 11 },
              callback: v => (v > 0 ? "+" + v : v)
            },
            grid: { color: "#e5e7eb" }
          },
          x: { ticks: { color: "#4b5563", font: { size: 11 } }, grid: { display: false } }
        },
        plugins: {
          legend: { display: false },
          title: { display: true, text: t, color: "#374151", font: { size: 13, weight: "bold" } },
          tooltip: { callbacks: { label: c => (c.parsed.y >= 0 ? "+" : "") + c.parsed.y.toFixed(1) + "%" } }
        }
      }
    });
  }
</script>
</section>

<!-- ================================================= -->
<!-- üèãÔ∏è ABA CARGA ‚Äì CIENTE IE -->
<!-- ================================================= -->
<section id="abaCarga" class="aba hidden">

  <!-- üîπ FILTROS -->
  <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div>
      <label class="block text-sm font-medium mb-1">Equipe</label>
      <select id="filtroEquipeCarga" class="border p-2 rounded w-full bg-white shadow-sm"></select>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Posi√ß√£o</label>
      <select id="filtroPosicaoCarga" class="border p-2 rounded w-full bg-white shadow-sm"></select>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Atleta</label>
      <select id="filtroAtletaCarga" class="border p-2 rounded w-full bg-white shadow-sm"></select>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Semana</label>
      <select id="filtroSemanaCarga" class="border p-2 rounded w-full bg-white shadow-sm">
        <option value="todas">Todas</option>
      </select>
    </div>
  </div>

  <!-- üîπ CARDS -->
  <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-2xl shadow p-5 border-t-4 border-blue-500 text-center">
      <h2 class="text-lg font-semibold text-gray-700">Carga Total da Semana</h2>
      <p id="cardCargaTotal" class="text-3xl font-bold mt-2">--</p>
    </div>
    <div class="bg-white rounded-2xl shadow p-5 border-t-4 border-indigo-500 text-center">
      <h2 class="text-lg font-semibold text-gray-700">M√©dia Individual da Equipe</h2>
      <p id="cardCargaMedia" class="text-3xl font-bold mt-2">--</p>
    </div>
    <div class="bg-white rounded-2xl shadow p-5 border-t-4 border-green-500 text-center">
      <h2 class="text-lg font-semibold text-gray-700">ACWR M√©dio da Equipe</h2>
      <p id="cardACWRMedia" class="text-3xl font-bold mt-2">--</p>
    </div>
  </div>

  <!-- üîπ TABELA -->
  <div class="max-w-6xl mx-auto bg-white shadow rounded-xl overflow-x-auto">
    <table class="w-full text-sm text-center">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="p-2">Atleta</th>
          <th class="p-2">Equipe</th>
          <th class="p-2">Posi√ß√£o</th>
          <th class="p-2">√öltima Data</th>
          <th class="p-2">Carga Semanal</th>
          <th class="p-2">ACWR</th>
        </tr>
      </thead>
      <tbody id="tabelaCarga" class="text-gray-700"></tbody>
    </table>
  </div>

  <!-- üîπ LEGENDA -->
  <div class="text-center text-sm text-gray-600 mt-4">
    <div class="mb-1 font-semibold text-gray-700">
      Rela√ß√£o Agudo/Cr√¥nica da Carga (ACWR)
    </div>
    <span class="inline-block mx-3">üîµ Subcarga (&lt; 0.8)</span>
    <span class="inline-block mx-3">üü¢ Ideal (0.8‚Äì1.3)</span>
    <span class="inline-block mx-3">üü° Aten√ß√£o (1.3‚Äì1.5)</span>
    <span class="inline-block mx-3">üî¥ Sobrecarga (&gt; 1.5)</span>
  </div>

  <!-- üîπ MODAL DETALHES -->
  <div id="modalDetalhesCarga" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-xl w-11/12 md:w-3/4 lg:w-1/2 p-6 relative">
      <button id="fecharModalCarga" class="absolute top-2 right-3 text-gray-500 hover:text-black text-xl font-bold">&times;</button>
      <h2 id="tituloAtletaCarga" class="text-xl font-semibold text-center mb-4"></h2>

      <!-- üîπ Lista de dados brutos -->
      <div id="dadosBrutosCarga" class="text-sm text-gray-700 mb-6 flex flex-wrap justify-center gap-2"></div>

      <!-- üîπ Gr√°fico -->
      <div class="w-full mb-4">
        <canvas id="graficoCargaDiaria"></canvas>
      </div>

      <!-- üîπ Resumo -->
      <div id="resumoCarga" class="text-center text-gray-700 font-medium"></div>
    </div>
  </div>

  <!-- ================================================= -->
  <!-- ‚öôÔ∏è SCRIPT -->
  <!-- ================================================= -->
  <script type="module">
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    const db = getFirestore();

    async function carregarCargaPainel() {
      const snap = await getDocs(collection(db, "carga"));
      const dados = snap.docs.map(doc => {
        const d = doc.data();
        return {
          nome_atleta: d.nome_atleta?.trim() || "Sem nome",
          equipe_id: d.equipe_id?.trim() || "-",
          posicao_grupo: d.posicao_grupo?.trim() || "-",
          data: d.data?.trim() || "",
          pse: Number(d.pse) || 0,
          tempo: Number(d.tempo) || 0
        };
      });
      preencherFiltrosCarga(dados);
  // ===============================
  // üéØ Filtro de Semana (Sxx)
  // ===============================
  const filtroSemanaCarga = document.getElementById("filtroSemanaCarga");

  // Gera lista de semanas √∫nicas (ex: S40, S41)
  const semanasUnicas = [...new Set(dados.map(d => {
    if (!d.data) return null;
    const dt = new Date(d.data + "T00:00:00");
    const target = new Date(dt.valueOf());
    const dayNr = (dt.getDay() + 6) % 7;
    target.setDate(target.getDate() - dayNr + 3);
    const firstThursday = new Date(target.getFullYear(), 0, 4);
    const diff = target - firstThursday;
    return "S" + (1 + Math.round(diff / (7 * 24 * 60 * 60 * 1000)));
  }).filter(Boolean))];

  // Preenche o select
  filtroSemanaCarga.innerHTML = `<option value="todas">Todas</option>` +
    semanasUnicas.map(s => `<option value="${s}">${s}</option>`).join("");

  // Evento: atualiza cards ao mudar semana
  filtroSemanaCarga.addEventListener("change", () => {
    const sel = filtroSemanaCarga.value;
    let filtrados = dados;

    if (sel !== "todas") {
      filtrados = dados.filter(d => {
        if (!d.data) return false;
        const dt = new Date(d.data + "T00:00:00");
        const target = new Date(dt.valueOf());
        const dayNr = (dt.getDay() + 6) % 7;
        target.setDate(target.getDate() - dayNr + 3);
        const firstThursday = new Date(target.getFullYear(), 0, 4);
        const diff = target - firstThursday;
        const semana = "S" + (1 + Math.round(diff / (7 * 24 * 60 * 60 * 1000)));
        return semana === sel;
      });
    }

    // Atualiza apenas os cards
    const resumo = [...new Set(filtrados.map(d => d.nome_atleta))]
      .map(a => calcularCargaAtleta(a, filtrados));
    renderCardsCarga(resumo);
  });
      setTimeout(() => atualizarPainelCarga(dados), 300);
    }

    function preencherFiltrosCarga(dados) {
      const equipes = [...new Set(dados.map(d => d.equipe_id))];
      const posicoes = [...new Set(dados.map(d => d.posicao_grupo))];
      const atletas = [...new Set(dados.map(d => d.nome_atleta))];
      document.getElementById("filtroEquipeCarga").innerHTML = "<option value='todos'>Todas</option>" + equipes.map(e => `<option>${e}</option>`).join("");
      document.getElementById("filtroPosicaoCarga").innerHTML = "<option value='todos'>Todas</option>" + posicoes.map(p => `<option>${p}</option>`).join("");
      document.getElementById("filtroAtletaCarga").innerHTML = "<option value='todos'>Todos</option>" + atletas.map(a => `<option>${a}</option>`).join("");
      ["filtroEquipeCarga","filtroPosicaoCarga","filtroAtletaCarga"].forEach(id =>
        document.getElementById(id).addEventListener("change", () => atualizarPainelCarga(dados))
      );
    }

    function atualizarPainelCarga(dados) {
      const eq = filtroEquipeCarga.value, po = filtroPosicaoCarga.value, at = filtroAtletaCarga.value;
      let filtrados = dados;
      if (eq !== "todos") filtrados = filtrados.filter(d => d.equipe_id === eq);
      if (po !== "todos") filtrados = filtrados.filter(d => d.posicao_grupo === po);
      if (at !== "todos") filtrados = filtrados.filter(d => d.nome_atleta === at);
      const atletas = [...new Set(filtrados.map(d => d.nome_atleta))];
      const resumo = atletas.map(a => calcularCargaAtleta(a, filtrados));
      renderCardsCarga(resumo);
      renderTabelaCarga(resumo, dados);
    }

    function calcularCargaAtleta(nome, dados) {
      const doAtleta = dados.filter(d => d.nome_atleta === nome).sort((a,b)=>a.data.localeCompare(b.data));
      if (!doAtleta.length) return { atleta: nome, equipe: "-", posicao: "-", data: "-", carga: 0, acwr: 0 };
      const ult = doAtleta[doAtleta.length - 1];
      const semanas = agruparPorSemana(doAtleta);
      const atual = semanas[semanas.length - 1];
      const ultimos4 = semanas.slice(-4);
      const cargaSemanal = atual.reduce((s, x) => s + (x.pse * x.tempo), 0);
      const media4 = ultimos4.reduce((t, sem) => t + sem.reduce((s, x) => s + (x.pse * x.tempo), 0), 0) / ultimos4.length || cargaSemanal;
      const acwr = media4 ? cargaSemanal / media4 : 1;
      return { atleta: nome, equipe: ult.equipe_id, posicao: ult.posicao_grupo, data: ult.data, carga: cargaSemanal, acwr: acwr };
    }

    function agruparPorSemana(dados) {
      const porSemana = {};
      dados.forEach(d => {
        const dt = new Date(d.data + "T00:00:00");
        const diaSemana = (dt.getDay() + 6) % 7;
        const segunda = new Date(dt);
        segunda.setDate(dt.getDate() - diaSemana);
        const key = segunda.toISOString().split("T")[0];
        porSemana[key] = porSemana[key] || [];
        porSemana[key].push(d);
      });
      return Object.values(porSemana);
    }

    function renderCardsCarga(resumo) {
      if (!resumo.length) return;
      const cargaTotal = resumo.reduce((s, x) => s + x.carga, 0);
      const cargaMedia = cargaTotal / resumo.length;
      const acwrMedio = resumo.reduce((s, x) => s + x.acwr, 0) / resumo.length;
      cardCargaTotal.innerText = cargaTotal.toFixed(0);
      cardCargaMedia.innerText = cargaMedia.toFixed(0);
      cardACWRMedia.innerText = acwrMedio.toFixed(2);
    }

    function renderTabelaCarga(resumo, dados) {
  resumo.sort((a, b) => b.carga - a.carga);
  const corpo = document.getElementById("tabelaCarga");

  corpo.innerHTML = resumo.map(d => {
    const cor =
      d.acwr < 0.8 ? "text-blue-600 font-semibold" :
      d.acwr <= 1.3 ? "text-green-600 font-semibold" :
      d.acwr <= 1.5 ? "text-yellow-500 font-semibold" :
      "text-red-600 font-semibold";
    const bolinha =
      d.acwr < 0.8 ? "bg-blue-500" :
      d.acwr <= 1.3 ? "bg-green-500" :
      d.acwr <= 1.5 ? "bg-yellow-400" :
      "bg-red-500";
    return `
      <tr class="border-b hover:bg-gray-50 cursor-pointer" data-atleta="${d.atleta}">
        <td class="p-2 font-semibold text-blue-700 flex items-center justify-center gap-2">
          <span class="inline-block w-3 h-3 rounded-full ${bolinha}"></span>${d.atleta}
        </td>
        <td class="p-2">${d.equipe}</td>
        <td class="p-2">${d.posicao}</td>
        <td class="p-2">${d.data}</td>
        <td class="p-2">${d.carga.toFixed(0)}</td>
        <td class="p-2 ${cor}">${d.acwr.toFixed(2)}</td>
      </tr>
      <tr id="linha-${d.atleta.replace(/\s+/g, '_')}" class="hidden bg-gray-50">
        <td colspan="6" id="conteudo-${d.atleta.replace(/\s+/g, '_')}" class="p-4"></td>
      </tr>
    `;
  }).join("");

  // üîπ Evento de clique por atleta
  corpo.querySelectorAll("tr[data-atleta]").forEach(tr => {
    tr.addEventListener("click", () => {
      const nome = tr.dataset.atleta;
      window.mostrarDetalhesAtletaLinha(nome, dados);
    });
  });
}

// ===============================
// üîπ Detalhes expandidos (inline)
// ===============================
let chartCarga = null;
window.mostrarDetalhesAtletaLinha = function (nome, dados) {
  const idLinha = `linha-${nome.replace(/\s+/g, '_')}`;
  const idConteudo = `conteudo-${nome.replace(/\s+/g, '_')}`;
  const linha = document.getElementById(idLinha);
  const conteudo = document.getElementById(idConteudo);

  // Se j√° est√° aberto ‚Üí recolhe
  if (!linha.classList.contains("hidden")) {
    linha.classList.add("hidden");
    conteudo.innerHTML = "";
    return;
  }

  // Fecha outros detalhes abertos
  document.querySelectorAll("[id^='linha-']").forEach(l => {
    l.classList.add("hidden");
    const c = l.querySelector("td");
    if (c) c.innerHTML = "";
  });

  const atletaDados = dados
    .filter(d => d.nome_atleta === nome)
    .sort((a, b) => a.data.localeCompare(b.data));
  if (!atletaDados.length) return;

  const ultimo = atletaDados[atletaDados.length - 1];
  const cargaUltima = (ultimo.pse * ultimo.tempo).toFixed(0);

  conteudo.innerHTML = `
    <div class="bg-white rounded-lg shadow p-3 mb-3">
      <p class="text-sm text-gray-700">
        <strong>Data:</strong> ${ultimo.data} &nbsp;|&nbsp;
        <strong>PSE:</strong> ${ultimo.pse} &nbsp;|&nbsp;
        <strong>Tempo:</strong> ${ultimo.tempo} min &nbsp;|&nbsp;
        <strong>Carga:</strong> ${cargaUltima}
      </p>
    </div>
    <div class="w-full h-60 mb-3">
      <canvas id="grafico-${nome.replace(/\s+/g, '_')}"></canvas>
    </div>
    <div id="resumo-${nome.replace(/\s+/g, '_')}" class="text-center text-sm text-gray-700"></div>
  `;

  linha.classList.remove("hidden");

  // Dados do gr√°fico
  const labels = atletaDados.map(d => d.data);
  const cargas = atletaDados.map(d => d.pse * d.tempo);
  const pse = atletaDados.map(d => d.pse);

  const ctx = document.getElementById(`grafico-${nome.replace(/\s+/g, '_')}`).getContext("2d");
  if (chartCarga) chartCarga.destroy();

  chartCarga = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label: "Carga (PSE√óTempo)",
          data: cargas,
          backgroundColor: "#10b98188",
          borderColor: "#10b981",
          borderWidth: 1.5,
          yAxisID: "y1"
        },
        {
          label: "PSE",
          data: pse,
          type: "line",
          borderColor: "#f59e0b",
          backgroundColor: "#f59e0b55",
          borderWidth: 2,
          tension: 0.3,
          yAxisID: "y2"
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { position: "top" },
        title: {
          display: true,
          text: "Hist√≥rico Di√°rio de Carga",
          font: { size: 13, weight: "bold" }
        }
      },
      scales: {
        x: {
          title: { display: true, text: "Data" },
          ticks: { autoSkip: true, maxTicksLimit: 10 }
        },
        y1: {
          beginAtZero: true,
          title: { display: true, text: "Carga (PSE√óTempo)" },
          grid: { color: "#e5e7eb" }
        },
        y2: {
          beginAtZero: true,
          min: 0,
          max: 10,
          title: { display: true, text: "PSE (0‚Äì10)" },
          position: "right",
          grid: { drawOnChartArea: false }
        }
      }
    }
  });

  // üìà Resumo
  const total = cargas.reduce((s, x) => s + x, 0);
  const media = total / cargas.length;
  document.getElementById(`resumo-${nome.replace(/\s+/g, '_')}`).innerHTML = `
    <p><strong>Carga Total:</strong> ${total.toFixed(0)} &nbsp;|&nbsp;
       <strong>M√©dia Di√°ria:</strong> ${media.toFixed(0)}</p>
  `;
};

document.getElementById("fecharModalCarga").addEventListener("click", () =>
  modalDetalhesCarga.classList.add("hidden")
);
document.addEventListener("DOMContentLoaded", carregarCargaPainel);

  </script>

  <!-- Importa Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</section>

<!-- ================================================= -->
<!-- üóìÔ∏è ABA PLANEJAMENTO ‚Äì CIENTE IE (Parte 1/3: Estrutura HTML) -->
<!-- ================================================= -->
<section id="abaPlanejamento" class="aba hidden relative">

  <!-- üîπ BOT√ÉO FIXO DE CADASTRO -->
  <div class="sticky top-0 bg-white z-50 py-3 text-center shadow-md border-b mb-6">
    <button id="btnToggleCadastro" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg shadow">
      + Cadastrar Planejamento Semana
    </button>
  </div>

  <!-- üîπ FORMUL√ÅRIO SEMANAL (OCULTO POR PADR√ÉO) -->
  <div id="formPlanejamento" class="hidden animate-fadeIn max-w-6xl mx-auto bg-white rounded-2xl shadow p-6 mb-8">
    <h2 class="text-lg font-semibold mb-4 text-gray-700 text-center">Cadastrar Planejamento Semanal</h2>

    <!-- Campos principais -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div>
        <label class="block text-sm font-medium mb-1">Data Base (Segunda)</label>
        <input type="date" id="dataBaseSemana" class="border p-2 rounded w-full bg-gray-50 shadow-sm">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Equipe</label>
        <select id="equipePlanejamento" class="border p-2 rounded w-full bg-gray-50 shadow-sm">
          <option value="">Selecione</option>
          <option>Sub-15</option>
          <option>Sub-17</option>
          <option>Profissional</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Tipo de Treino</label>
        <select id="tipoPlanejamento" class="border p-2 rounded w-full bg-gray-50 shadow-sm">
          <option value="">Selecione</option>
          <option value="Campo">Campo</option>
          <option value="F√≠sico">F√≠sico</option>
        </select>
      </div>
    </div>

    <!-- Cabe√ßalho Semana -->
    <div class="text-center mb-4">
      <p id="infoSemana" class="text-lg font-semibold text-blue-700 bg-gray-100 rounded p-2 inline-block shadow-inner">--</p>
    </div>

    <!-- Tabela semanal -->
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-center border rounded-lg">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="p-2">Dia</th>
            <th class="p-2">Carga Planejada</th>
            <th class="p-2">Objetivos Principais</th>
            <th class="p-2">Objetivo Secund√°rio / Atividades</th>
            <th class="p-2">Observa√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaSemanaPlanejamento" class="text-gray-700"></tbody>
      </table>
    </div>

    <div class="text-center mt-6">
      <button id="btnSalvarSemana" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg shadow">
        üíæ Salvar Semana
      </button>
    </div>
  </div>

  <!-- üîπ FILTROS GLOBAIS -->
  <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div>
      <label class="block text-sm font-medium mb-1">Equipe</label>
      <select id="filtroEquipeGlobal" class="border p-2 rounded w-full bg-white shadow-sm"></select>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Semana</label>
      <select id="filtroSemanaGlobal" class="border p-2 rounded w-full bg-white shadow-sm"></select>
    </div>
  </div>

  <!-- üîπ EXIBI√á√ÉO LADO A LADO -->
  <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- üü¶ PLANEJAMENTO DE CAMPO -->
    <div class="bg-white rounded-2xl shadow p-6 overflow-auto">
      <h2 class="text-lg font-semibold text-blue-700 mb-3 text-center">‚öΩ Planejamento de Campo</h2>
      <table class="w-full text-sm text-center">
        <thead class="bg-blue-50 text-blue-800 font-semibold">
          <tr>
            <th class="p-2">Dia</th>
            <th class="p-2">Equipe</th>
            <th class="p-2">Objetivos</th>
            <th class="p-2">Carga</th>
            <th class="p-2">Atividades</th>
          </tr>
        </thead>
        <tbody id="tabelaCampo"></tbody>
      </table>
    </div>

    <!-- üü© PLANEJAMENTO F√çSICO -->
    <div class="bg-white rounded-2xl shadow p-6 overflow-auto">
      <h2 class="text-lg font-semibold text-green-700 mb-3 text-center">üèãÔ∏è Planejamento F√≠sico</h2>
      <table class="w-full text-sm text-center">
        <thead class="bg-green-50 text-green-800 font-semibold">
          <tr>
            <th class="p-2">Dia</th>
            <th class="p-2">Equipe</th>
            <th class="p-2">Objetivos</th>
            <th class="p-2">Carga</th>
            <th class="p-2">Atividades</th>
          </tr>
        </thead>
        <tbody id="tabelaFisico"></tbody>
      </table>
    </div>
  </div>

  <!-- üîπ GR√ÅFICO DE CARGAS -->
  <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6 mb-12">
    <h2 class="text-lg font-semibold text-gray-700 mb-4 text-center">üìä Cargas Semanais (Campo x F√≠sico)</h2>
    <canvas id="graficoCargas" height="120"></canvas>
  </div>
<!-- ================================================= -->
<!-- ‚öôÔ∏è SCRIPT ‚Äì Firebase + Chart.js -->
<!-- ================================================= -->
<script type="module">
  import { getFirestore, collection, addDoc, getDocs, serverTimestamp } 
  from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
  const db = getFirestore();
  const colRef = collection(db, "planejamento");

  // Importa Chart.js
  const chartScript = document.createElement("script");
  chartScript.src = "https://cdn.jsdelivr.net/npm/chart.js";
  document.head.appendChild(chartScript);

  // ---------- DADOS BASE ----------
  const diasSemana = ["Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado","Domingo"];
  const objetivosFisico = [
    "For√ßa Geral","For√ßa Explosiva","For√ßa M√°xima","For√ßa Especial","Velocidade","Agilidade",
    "Resist√™ncia Aer√≥bia","Resist√™ncia Anaer√≥bia","Mobilidade","Flexibilidade",
    "F√≠sico-T√©cnico","Recreativo","Regenerativo","Jogo Treino","Descanso","Sem Atividade"
  ];
  const objetivosCampo = [
    "T√©cnico","T√°tico","Jogadas Ensaiadas","Jogo Treino","Jogo Oficial","Descanso","Sem Atividade"
  ];

  const corpoTabela = document.getElementById("tabelaSemanaPlanejamento");
  let chart; // inst√¢ncia do gr√°fico

  // ---------- FUN√á√ïES AUXILIARES ----------
  function getNumeroSemana(dataStr) {
    const date = new Date(dataStr + "T00:00:00");
    const target = new Date(date.valueOf());
    const dayNr = (date.getDay() + 6) % 7;
    target.setDate(target.getDate() - dayNr + 3);
    const firstThursday = new Date(target.getFullYear(), 0, 4);
    const diff = target - firstThursday;
    return 1 + Math.round(diff / (7 * 24 * 60 * 60 * 1000));
  }

  const mapaCargas = {
    "Descanso": 1, "Sem Atividade": 1,
    "Leve": 2, "Moderada": 3, "Alta": 4, "M√°xima": 5
  };
  const corCarga = {1:"#3B82F6",2:"#22C55E",3:"#FACC15",4:"#FB923C",5:"#EF4444"};

  // ---------- MONTAR TABELA DE CADASTRO ----------
  function montarTabela() {
    const tipo = document.getElementById("tipoPlanejamento").value;
    const lista = tipo === "F√≠sico" ? objetivosFisico : tipo === "Campo" ? objetivosCampo : [];
    corpoTabela.innerHTML = diasSemana.map(dia => `
      <tr>
        <td class="p-2 font-semibold text-blue-700">${dia}</td>
        <td class="p-2">
          <select class="carga-planejada border p-1 rounded w-full bg-gray-50">
            <option value="">Selecione</option>
            <option>Descanso</option>
            <option>Sem Atividade</option>
            <option>Leve</option>
            <option>Moderada</option>
            <option>Alta</option>
            <option>M√°xima</option>
          </select>
        </td>
        <td class="p-2">
          <select multiple class="objetivo-principal border p-1 rounded w-full bg-gray-50 h-24">
            ${lista.map(o => `<option>${o}</option>`).join("")}
          </select>
        </td>
        <td class="p-2"><input type="text" class="objetivo-secundario border p-1 rounded w-full bg-gray-50" placeholder="Atividades / Objetivos secund√°rios"></td>
        <td class="p-2"><input type="text" class="observacoes border p-1 rounded w-full bg-gray-50" placeholder="Observa√ß√µes"></td>
      </tr>
    `).join("");
  }
  document.getElementById("tipoPlanejamento").addEventListener("change", montarTabela);

  // ---------- TOGGLE FORMUL√ÅRIO ----------
  const btnToggle = document.getElementById("btnToggleCadastro");
  const form = document.getElementById("formPlanejamento");
  btnToggle.addEventListener("click", () => {
    form.classList.toggle("hidden");
    btnToggle.textContent = form.classList.contains("hidden") ? "+ Cadastrar Planejamento Semana" : "‚úñ Fechar Cadastro Semanal";
  });

  // ---------- CABE√áALHO DA SEMANA ----------
  document.getElementById("dataBaseSemana").addEventListener("change", () => {
    const data = document.getElementById("dataBaseSemana").value;
    if (!data) return;
    const dt = new Date(data + "T00:00:00");
    const segunda = new Date(dt);
    const domingo = new Date(segunda); domingo.setDate(segunda.getDate() + 6);
    const semanaTxt = `${segunda.toLocaleDateString('pt-BR')} a ${domingo.toLocaleDateString('pt-BR')} (S${getNumeroSemana(data)})`;
    document.getElementById("infoSemana").textContent = semanaTxt;
  });

  // ---------- SALVAR SEMANA ----------
  document.getElementById("btnSalvarSemana").addEventListener("click", async () => {
    const dataBase = document.getElementById("dataBaseSemana").value;
    const equipe = document.getElementById("equipePlanejamento").value;
    const tipo = document.getElementById("tipoPlanejamento").value;
    if (!dataBase || !equipe || !tipo) {
      alert("Preencha todos os campos principais antes de salvar!");
      return;
    }

    const segunda = new Date(dataBase + "T00:00:00");
    const domingo = new Date(segunda); domingo.setDate(segunda.getDate() + 6);
    const semana = `${segunda.toLocaleDateString('pt-BR')} a ${domingo.toLocaleDateString('pt-BR')}`;
    const numSemana = getNumeroSemana(dataBase);

    const linhas = corpoTabela.querySelectorAll("tr");
    for (let i = 0; i < linhas.length; i++) {
      const carga = linhas[i].querySelector(".carga-planejada").value;
      const obj = Array.from(linhas[i].querySelector(".objetivo-principal").selectedOptions).map(o => o.value);
      const objSec = linhas[i].querySelector(".objetivo-secundario").value;
      const obs = linhas[i].querySelector(".observacoes").value;
      const dataDia = new Date(segunda); dataDia.setDate(segunda.getDate() + i);

      await addDoc(colRef, {
        data: dataDia.toISOString().split("T")[0],
        dia_nome: diasSemana[i],
        semana,
        semana_numero: numSemana,
        equipe_id: equipe,
        tipo,
        carga_planejada: carga,
        carga_valor: mapaCargas[carga] || 0,
        objetivo_principal: obj,
        objetivo_secundario: objSec,
        observacoes: obs,
        criado_em: serverTimestamp()
      });
    }

    alert("Planejamento semanal salvo com sucesso!");
    carregarPlanejamentos();
  });

  // ---------- CARREGAR PLANEJAMENTOS ----------
  async function carregarPlanejamentos() {
    const snap = await getDocs(colRef);
    const dados = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    const equipes = [...new Set(dados.map(d => d.equipe_id))];
    filtroEquipeGlobal.innerHTML = "<option value='todas'>Todas</option>" + equipes.map(e => `<option>${e}</option>`).join("");

    const semanas = [...new Set(dados.map(d => `${d.semana} (S${d.semana_numero})`))];
    filtroSemanaGlobal.innerHTML = "<option value='atual'>Semana Atual</option>" + semanas.map(s => `<option>${s}</option>`).join("");

    aplicarFiltros(dados);
    filtroEquipeGlobal.onchange = () => aplicarFiltros(dados);
    filtroSemanaGlobal.onchange = () => aplicarFiltros(dados);
  }

  // ---------- APLICAR FILTROS + ATUALIZAR TABELAS E GR√ÅFICO ----------
  function aplicarFiltros(dados) {
    const eq = filtroEquipeGlobal.value;
    const sem = filtroSemanaGlobal.value;
    const hoje = new Date();
    const semanaAtual = getNumeroSemana(hoje.toISOString().split("T")[0]);

    let filtrados = dados;
    if (eq !== "todas") filtrados = filtrados.filter(d => d.equipe_id === eq);
    filtrados = sem === "atual"
      ? filtrados.filter(d => d.semana_numero === semanaAtual)
      : filtrados.filter(d => `S${d.semana_numero}` && sem.includes(`S${d.semana_numero}`));

    const campo = filtrados.filter(d => d.tipo === "Campo");
    const fisico = filtrados.filter(d => d.tipo === "F√≠sico");

    const tabelaCampo = document.getElementById("tabelaCampo");
    const tabelaFisico = document.getElementById("tabelaFisico");

    tabelaCampo.innerHTML = gerarTabelaHTML(campo, "blue");
    tabelaFisico.innerHTML = gerarTabelaHTML(fisico, "green");

    atualizarGrafico(campo, fisico);
  }

  function gerarTabelaHTML(lista, corBase) {
    if (!lista.length) return `<tr><td colspan='5' class='p-2 text-gray-400'>Nenhum treino cadastrado</td></tr>`;
    lista.sort((a,b)=>a.data.localeCompare(b.data));
    return lista.map(d => {
      const cargaVal = mapaCargas[d.carga_planejada] || 0;
      const cor = corCarga[cargaVal] || "#e5e7eb";
      const textoCor = cargaVal >= 4 ? "text-white" : "text-black";
      return `
        <tr class="border-b hover:bg-${corBase}-50">
          <td class="p-2">${d.dia_nome}</td>
          <td class="p-2">${d.equipe_id}</td>
          <td class="p-2">${Array.isArray(d.objetivo_principal)?d.objetivo_principal.join(", "):d.objetivo_principal||"-"}</td>
          <td class="p-2 ${textoCor}" style="background:${cor}">${d.carga_planejada || "-"}</td>
          <td class="p-2">${d.objetivo_secundario || "-"}</td>
        </tr>`;
    }).join("");
  }

  // ---------- GR√ÅFICO DE CARGAS ----------
function atualizarGrafico(campo, fisico) {
  if (!window.Chart) return;

  const dadosCampo = new Array(7).fill(0);
  const dadosFisico = new Array(7).fill(0);

  campo.forEach(d => {
    const i = diasSemana.indexOf(d.dia_nome);
    if (i >= 0) dadosCampo[i] = mapaCargas[d.carga_planejada] || 0;
  });
  fisico.forEach(d => {
    const i = diasSemana.indexOf(d.dia_nome);
    if (i >= 0) dadosFisico[i] = mapaCargas[d.carga_planejada] || 0;
  });

  const ctx = document.getElementById("graficoCargas").getContext("2d");

  // üîπ Atualiza t√≠tulo do gr√°fico
  document.querySelector("#graficoCargas").previousElementSibling.textContent = "üìä Carga Estimada da Semana";

  // üîπ Destroi gr√°fico anterior antes de recriar
  if (chart) chart.destroy();

  // üîπ Cria novo gr√°fico
  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: diasSemana,
      datasets: [
        {
          label: "Campo",
          data: dadosCampo,
          backgroundColor: "#3B82F6",
          borderRadius: 4,
          barPercentage: 0.45
        },
        {
          label: "F√≠sico",
          data: dadosFisico,
          backgroundColor: "#22C55E",
          borderRadius: 4,
          barPercentage: 0.45
        }
      ]
    },
    options: {
      responsive: true,
      aspectRatio: 2.5,
      plugins: {
        legend: { display: true, position: "bottom" },
        title: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function (ctx) {
              const valor = ctx.parsed.y;
              let descricao = "";
              switch (valor) {
                case 1: descricao = "Descanso / Sem Atividade"; break;
                case 2: descricao = "Leve"; break;
                case 3: descricao = "Moderada"; break;
                case 4: descricao = "Alta"; break;
                case 5: descricao = "M√°xima"; break;
                default: descricao = "Sem carga";
              }
              return `${ctx.dataset.label}: ${descricao} (${valor})`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 5,
          ticks: {
            stepSize: 1,
            font: { size: 12 }
          },
          title: {
            display: true,
            text: "N√≠vel da Carga (1‚Äì5)",
            font: { size: 13, weight: "bold" }
          },
          grid: { color: "#e5e7eb" }
        },
        x: {
          ticks: { font: { size: 12 } },
          grid: { display: false }
        }
      }
    }
  });
}


  document.addEventListener("DOMContentLoaded", carregarPlanejamentos);
</script>
<!-- ================================================= -->
<!-- üé® ESTILOS FINAIS ‚Äì CIENTE IE -->
<!-- ================================================= -->
<style>
  /* ===== ANIMA√á√ïES ===== */
  @keyframes fadeIn { from {opacity: 0; transform: translateY(-10px);} to {opacity: 1; transform: translateY(0);} }
  .animate-fadeIn { animation: fadeIn 0.4s ease-in-out; }

  /* ===== FORMATA√á√ÉO GERAL ===== */
  #abaPlanejamento {
    scroll-behavior: smooth;
  }

  select[multiple] {
    height: 6rem;
    background-color: #f9fafb;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    padding: 0.25rem;
  }
  select[multiple] option {
    padding: 0.25rem;
    border-radius: 0.25rem;
  }
  select[multiple] option:checked {
    background-color: #2563eb;
    color: white;
  }

  /* ===== BOT√ÉO FIXO ===== */
  #btnToggleCadastro {
    transition: all 0.25s ease;
  }
  #btnToggleCadastro:hover {
    transform: scale(1.03);
  }

  /* ===== TABELAS ===== */
  table {
    border-collapse: collapse;
    width: 100%;
  }
  th, td {
    border: 1px solid #e5e7eb;
  }
  th {
    font-weight: 600;
  }
  tbody tr:hover {
    background-color: #f9fafb;
  }

  /* ===== CORES DE CARGA (refer√™ncia) ===== */
  .carga-1 { background-color: #3B82F6; color: white; }
  .carga-2 { background-color: #22C55E; color: white; }
  .carga-3 { background-color: #FACC15; color: black; }
  .carga-4 { background-color: #FB923C; color: white; }
  .carga-5 { background-color: #EF4444; color: white; }

  /* ===== GR√ÅFICO ===== */
  #graficoCargas {
    width: 100%;
    height: 300px;
  }

  /* ===== RESPONSIVIDADE ===== */
  @media (max-width: 768px) {
    #formPlanejamento table {
      font-size: 0.85rem;
    }
    #btnToggleCadastro {
      width: 90%;
      font-size: 0.95rem;
    }
  }
</style>

</section>


<!-- ================================================= -->
<!-- üè• ABA DEPARTAMENTO M√âDICO ‚Äì CIENTE IE (Parte 1/3) -->
<!-- ================================================= -->
<section id="abaMedico" class="aba hidden relative">

  <!-- üîπ BOT√ÉO FIXO -->
  <div class="sticky top-0 bg-white z-50 py-3 text-center shadow-md border-b mb-6">
    <button id="btnToggleMedico" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg shadow">
      + Cadastrar Caso M√©dico
    </button>
  </div>

  <!-- üîπ FORMUL√ÅRIO (OCULTO POR PADR√ÉO) -->
  <div id="formMedico" class="hidden animate-fadeIn max-w-5xl mx-auto bg-white rounded-2xl shadow p-6 mb-8">
    <h2 class="text-lg font-semibold mb-4 text-gray-700 text-center">Cadastrar Novo Caso M√©dico</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium mb-1">Atleta</label>
        <select id="medicoAtleta" class="border p-2 rounded w-full bg-gray-50 shadow-sm"></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Equipe</label>
        <select id="medicoEquipe" class="border p-2 rounded w-full bg-gray-50 shadow-sm"></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Data do Diagn√≥stico</label>
        <input type="date" id="medicoData" class="border p-2 rounded w-full bg-gray-50 shadow-sm">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Tipo de Les√£o</label>
        <input type="text" id="medicoLesao" placeholder="Ex: Distens√£o, Tor√ß√£o, Contus√£o..." class="border p-2 rounded w-full bg-gray-50 shadow-sm">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Gravidade</label>
        <select id="medicoGravidade" class="border p-2 rounded w-full bg-gray-50 shadow-sm">
          <option value="">Selecione</option>
          <option>Leve</option>
          <option>Moderada</option>
          <option>Grave</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Status</label>
        <select id="medicoStatus" class="border p-2 rounded w-full bg-gray-50 shadow-sm">
          <option value="">Selecione</option>
          <option>Em tratamento</option>
          <option>Liberado</option>
          <option>Observa√ß√£o</option>
          <option>Transi√ß√£o</option>
        </select>
      </div>
    </div>

    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Queixa do Atleta</label>
      <textarea id="medicoQueixa" rows="2" placeholder="Descri√ß√£o da queixa relatada pelo atleta..." class="border p-2 rounded w-full bg-gray-50 shadow-sm"></textarea>
    </div>

    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Observa√ß√µes Gerais</label>
      <textarea id="medicoObs" rows="2" placeholder="Observa√ß√µes complementares, procedimentos, evolu√ß√£o..." class="border p-2 rounded w-full bg-gray-50 shadow-sm"></textarea>
    </div>

    <div class="text-center mt-6">
      <button id="btnSalvarMedico" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg shadow">
        üíæ Salvar Caso
      </button>
    </div>
  </div>

  <!-- üîπ CARDS DE STATUS -->
  <div class="max-w-6xl mx-auto grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-center">
    <div id="cardEmTratamento" class="bg-yellow-400 text-white rounded-xl shadow p-4">
      <p class="text-sm font-medium">Em tratamento</p>
      <p class="text-2xl font-bold" id="contEmTratamento">0</p>
    </div>
    <div id="cardLiberado" class="bg-green-500 text-white rounded-xl shadow p-4">
      <p class="text-sm font-medium">Liberado</p>
      <p class="text-2xl font-bold" id="contLiberado">0</p>
    </div>
    <div id="cardObservacao" class="bg-blue-500 text-white rounded-xl shadow p-4">
      <p class="text-sm font-medium">Observa√ß√£o</p>
      <p class="text-2xl font-bold" id="contObservacao">0</p>
    </div>
    <div id="cardTransicao" class="bg-orange-400 text-white rounded-xl shadow p-4">
      <p class="text-sm font-medium">Transi√ß√£o</p>
      <p class="text-2xl font-bold" id="contTransicao">0</p>
    </div>
  </div>

  <!-- üîπ FILTROS -->
  <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div>
      <label class="block text-sm font-medium mb-1">Equipe</label>
      <select id="filtroEquipeMedico" class="border p-2 rounded w-full bg-white shadow-sm"></select>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Status</label>
      <select id="filtroStatusMedico" class="border p-2 rounded w-full bg-white shadow-sm">
        <option value="todos">Todos</option>
        <option>Em tratamento</option>
        <option>Liberado</option>
        <option>Observa√ß√£o</option>
        <option>Transi√ß√£o</option>
      </select>
    </div>
  </div>

  <!-- üîπ TABELA DE CASOS -->
  <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6 mb-12 overflow-x-auto">
    <h2 class="text-lg font-semibold text-gray-700 mb-3 text-center">Casos M√©dicos Registrados</h2>
    <table class="w-full text-sm text-center border rounded-lg">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="p-2">Atleta</th>
          <th class="p-2">Equipe</th>
          <th class="p-2">Data</th>
          <th class="p-2">Tipo de Les√£o</th>
          <th class="p-2">Gravidade</th>
          <th class="p-2">Status</th>
          <th class="p-2">Dias Afastado</th>
          <th class="p-2">Observa√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaMedico" class="text-gray-700"></tbody>
    </table>
  </div>
<!-- ================================================= -->
<!-- ‚öôÔ∏è SCRIPT ‚Äì Departamento M√©dico (Parte 2/3) -->
<!-- ================================================= -->
<script type="module">
  import {
    getFirestore, collection, addDoc, getDocs, onSnapshot,
    updateDoc, doc, serverTimestamp, query, orderBy
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  const db = getFirestore();

  // --- Refer√™ncias de UI
  const btnToggleMedico = document.getElementById("btnToggleMedico");
  const formMedico = document.getElementById("formMedico");

  const selAtleta = document.getElementById("medicoAtleta");
  const selEquipe  = document.getElementById("medicoEquipe");
  const inpData    = document.getElementById("medicoData");
  const inpLesao   = document.getElementById("medicoLesao");
  const selGrav    = document.getElementById("medicoGravidade");
  const selStatus  = document.getElementById("medicoStatus");
  const txtQueixa  = document.getElementById("medicoQueixa");
  const txtObs     = document.getElementById("medicoObs");
  const btnSalvar  = document.getElementById("btnSalvarMedico");

  const tblBody    = document.getElementById("tabelaMedico");

  const cardEmTratamento = document.getElementById("contEmTratamento");
  const cardLiberado     = document.getElementById("contLiberado");
  const cardObservacao   = document.getElementById("contObservacao");
  const cardTransicao    = document.getElementById("contTransicao");

  const filtroEquipeMed  = document.getElementById("filtroEquipeMedico");
  const filtroStatusMed  = document.getElementById("filtroStatusMedico");

  // --- Cole√ß√µes
  const colCasos = collection(db, "departamento_medico");
  const colProntidao = collection(db, "prontidao");

  // --- Toggle do formul√°rio
  btnToggleMedico.addEventListener("click", () => {
    formMedico.classList.toggle("hidden");
    btnToggleMedico.textContent = formMedico.classList.contains("hidden")
      ? "+ Cadastrar Caso M√©dico"
      : "‚úñ Fechar Cadastro";
  });

  // --- Util: diferen√ßa de dias (arredonda para baixo)
  function diffDias(d1, d2) {
    const MS = 24 * 60 * 60 * 1000;
    const a = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate()).getTime();
    const b = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate()).getTime();
    return Math.max(0, Math.floor((b - a) / MS));
  }

  // --- Paleta de status (cores)
  const statusColor = {
    "Em tratamento":  { bg: "#FACC15", text: "#1f2937" }, // amarelo
    "Liberado":       { bg: "#22C55E", text: "#FFFFFF" }, // verde
    "Observa√ß√£o":     { bg: "#3B82F6", text: "#FFFFFF" }, // azul
    "Transi√ß√£o":      { bg: "#FB923C", text: "#1f2937" }  // laranja
  };

  // --- Preenche selects de Atleta e Equipe automaticamente
  async function preencherAtletasEquipes() {
    // Busca de prontidao (mais est√°vel no seu fluxo)
    const snapPr = await getDocs(colProntidao);
    const dadosPr = snapPr.docs.map(d => d.data());

    // Busca dos pr√≥prios casos (para complementar listas)
    const snapDm = await getDocs(colCasos);
    const dadosDm = snapDm.docs.map(d => d.data());

    const atletas = new Set();
    const equipes = new Set();

    [...dadosPr, ...dadosDm].forEach(d => {
      const atleta = d.nome_atleta || d.atleta || d.atleta_id;
      const equipe = d.equipe_id || d.equipe;
      if (atleta && String(atleta).trim()) atletas.add(String(atleta).trim());
      if (equipe && String(equipe).trim()) equipes.add(String(equipe).trim());
    });

    const opt = (v) => `<option>${v}</option>`;
    selAtleta.innerHTML = `<option value="">Selecione</option>${[...atletas].sort().map(opt).join("")}`;
    selEquipe.innerHTML = `<option value="">Selecione</option>${[...equipes].sort().map(opt).join("")}`;

    // Filtros de listagem (equipes)
    filtroEquipeMed.innerHTML = `<option value="todas">Todas</option>${[...equipes].sort().map(opt).join("")}`;
  }

  // --- Salvar novo caso
  btnSalvar.addEventListener("click", async () => {
    const atleta = selAtleta.value.trim();
    const equipe = selEquipe.value.trim();
    const dataDx = inpData.value;
    const lesao  = inpLesao.value.trim();
    const grav   = selGrav.value;
    const status = selStatus.value;
    const queixa = txtQueixa.value.trim();
    const obs    = txtObs.value.trim();

    if (!atleta || !equipe || !dataDx || !lesao || !grav || !status) {
      alert("Preencha Atleta, Equipe, Data, Tipo de Les√£o, Gravidade e Status.");
      return;
    }

    const payload = {
      atleta, equipe,
      data_diagnostico: dataDx, // "YYYY-MM-DD"
      tipo_lesao: lesao,
      gravidade: grav,
      status,
      queixa,
      observacoes: obs,
      criado_em: serverTimestamp()
    };

    // Se j√° salvar como Liberado, j√° registra liberado_em = hoje
    if (status === "Liberado") {
      const hojeISO = new Date().toISOString().split("T")[0];
      payload.liberado_em = hojeISO; // congela contagem
    }

    await addDoc(colCasos, payload);

    // Limpa formul√°rio b√°sico (mant√©m equipe/atleta se quiser)
    inpData.value = "";
    inpLesao.value = "";
    selGrav.value = "";
    selStatus.value = "";
    txtQueixa.value = "";
    txtObs.value = "";

    alert("Caso m√©dico salvo com sucesso!");
  });

  // --- Observa e renderiza lista em tempo real
  onSnapshot(query(colCasos, orderBy("data_diagnostico", "desc")), (qsnap) => {
  const casos = qsnap.docs.map(d => ({ id: d.id, ...d.data() }));

  // üîπ Torna os dados do DM acess√≠veis globalmente para o Dashboard
  window.__dadosMedico = casos;

  renderResumoStatus(casos);
  preencherFiltrosSemanaEquipe(casos); // s√≥ equipes aqui; (semana n√£o √© usado)
  aplicarFiltrosERender(casos);
});

  // --- Resumo dos cards por status
  function renderResumoStatus(casos) {
    const cont = { "Em tratamento": 0, "Liberado": 0, "Observa√ß√£o": 0, "Transi√ß√£o": 0 };
    casos.forEach(c => {
      if (cont[c.status] !== undefined) cont[c.status]++;
    });
    cardEmTratamento.textContent = cont["Em tratamento"];
    cardLiberado.textContent     = cont["Liberado"];
    cardObservacao.textContent   = cont["Observa√ß√£o"];
    cardTransicao.textContent    = cont["Transi√ß√£o"];
  }

  // --- Preenche filtro Equipe (j√° √© feito em preencherAtletasEquipes; aqui garante novas equipes que venham s√≥ de casos)
  function preencherFiltrosSemanaEquipe(casos) {
    const equipes = Array.from(new Set(casos.map(c => c.equipe).filter(Boolean))).sort();
    const atual = filtroEquipeMed.value || "todas";
    filtroEquipeMed.innerHTML = `<option value="todas">Todas</option>${equipes.map(e => `<option ${atual===e?"selected":""}>${e}</option>`).join("")}`;
  }

  // --- Filtros
  filtroEquipeMed.onchange = () => recarregarTabela();
  filtroStatusMed.onchange = () => recarregarTabela();

  let cacheCasos = []; // mant√©m a √∫ltima fornada para re-render r√°pido
  function aplicarFiltrosERender(casos) {
    cacheCasos = casos;
    recarregarTabela();
  }

  function recarregarTabela() {
    let lista = cacheCasos.slice();

    const eq = filtroEquipeMed.value;
    const st = filtroStatusMed.value;

    if (eq && eq !== "todas")  lista = lista.filter(c => c.equipe === eq);
    if (st && st !== "todos")  lista = lista.filter(c => c.status === st);

    renderTabela(lista);
  }

  // --- Renderiza tabela principal
  function renderTabela(casos) {
    if (!casos.length) {
      tblBody.innerHTML = `<tr><td colspan="8" class="p-3 text-gray-400">Nenhum caso cadastrado</td></tr>`;
      return;
    }

    // Ordena por data_diagnostico desc (j√° vem ordenado; s√≥ garante)
    casos.sort((a,b) => (b.data_diagnostico || "").localeCompare(a.data_diagnostico || ""));

    tblBody.innerHTML = casos.map(c => {
      // Dias afastado
      const dataDx = c.data_diagnostico ? new Date(c.data_diagnostico) : null;
      let dias = "-";
      if (dataDx) {
        if (c.status === "Liberado" && c.liberado_em) {
          dias = diffDias(dataDx, new Date(c.liberado_em));
        } else if (c.status !== "Liberado") {
          dias = diffDias(dataDx, new Date());
        }
      }

      const st = c.status || "";
      const sty = statusColor[st] || { bg:"#e5e7eb", text:"#111827" };

      const grav = c.gravidade || "-";
      const lesao = c.tipo_lesao || "-";
      const dataPt = c.data_diagnostico ? new Date(c.data_diagnostico+"T00:00:00").toLocaleDateString("pt-BR") : "-";
      const obs = c.observacoes || "-";

      // Dropdown para mudar status
      const statusSelect = `
        <select data-id="${c.id}" class="status-editor border p-1 rounded w-full"
                style="background:${sty.bg}; color:${sty.text}; font-weight:600">
          ${["Em tratamento","Liberado","Observa√ß√£o","Transi√ß√£o"].map(s =>
            `<option value="${s}" ${s===st?"selected":""}>${s}</option>`
          ).join("")}
        </select>`;

      return `
        <tr class="border-b hover:bg-gray-50">
          <td class="p-2">${c.atleta || "-"}</td>
          <td class="p-2">${c.equipe || "-"}</td>
          <td class="p-2">${dataPt}</td>
          <td class="p-2">${lesao}</td>
          <td class="p-2">${grav}</td>
          <td class="p-2">${statusSelect}</td>
          <td class="p-2">${dias}</td>
          <td class="p-2">${obs}</td>
        </tr>`;
    }).join("");

    // Liga os editores de status
    tblBody.querySelectorAll(".status-editor").forEach(sel => {
      sel.addEventListener("change", async (e) => {
        const id = e.target.getAttribute("data-id");
        const novoStatus = e.target.value;
        const ref = doc(db, "departamento_medico", id);

        const updates = { status: novoStatus };

        // Se virou Liberado agora ‚Üí congela contagem
        if (novoStatus === "Liberado") {
          updates.liberado_em = new Date().toISOString().split("T")[0];
        } else {
          // Se saiu de Liberado para outro ‚Üí remove congelamento para voltar a contar
          updates.liberado_em = null;
        }

        await updateDoc(ref, updates);
      });
    });
  }

  // --- Inicializa
  (async function init() {
    // Data padr√£o hoje
    inpData.value = new Date().toISOString().split("T")[0];
    await preencherAtletasEquipes();
  })();
</script>
<!-- ================================================= -->
<!-- üé® ESTILO FINAL ‚Äì DEPARTAMENTO M√âDICO -->
<!-- ================================================= -->
<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-8px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .animate-fadeIn { animation: fadeIn 0.4s ease-in-out; }

  /* ===== FORM GERAL ===== */
  #formMedico select,
  #formMedico input,
  #formMedico textarea {
    font-size: 0.95rem;
    transition: border 0.2s, box-shadow 0.2s;
  }
  #formMedico select:focus,
  #formMedico input:focus,
  #formMedico textarea:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 2px rgba(37,99,235,0.2);
  }

  /* ===== BOT√ÉO FIXO ===== */
  #btnToggleMedico {
    transition: all 0.25s ease;
  }
  #btnToggleMedico:hover {
    transform: scale(1.03);
  }

  /* ===== CARDS DE STATUS ===== */
  #abaMedico .grid div {
    transition: transform 0.25s ease, box-shadow 0.25s ease;
  }
  #abaMedico .grid div:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
  }
  #cardEmTratamento   { background: #FACC15; color: #1f2937; }
  #cardLiberado       { background: #22C55E; color: #fff; }
  #cardObservacao     { background: #3B82F6; color: #fff; }
  #cardTransicao      { background: #FB923C; color: #1f2937; }

  /* ===== TABELA ===== */
  #abaMedico table {
    border-collapse: collapse;
    width: 100%;
    font-size: 0.9rem;
  }
  #abaMedico th, #abaMedico td {
    border: 1px solid #e5e7eb;
    padding: 0.5rem;
    text-align: center;
  }
  #abaMedico th {
    background-color: #f9fafb;
    font-weight: 600;
  }
  #abaMedico tr:hover {
    background-color: #f3f4f6;
  }

  /* ===== DROPDOWN DE STATUS NA TABELA ===== */
  .status-editor {
    font-weight: 600;
    text-align: center;
    border-radius: 0.4rem;
  }

  /* ===== RESPONSIVIDADE ===== */
  @media (max-width: 768px) {
    #formMedico {
      padding: 1rem;
    }
    #abaMedico table {
      font-size: 0.8rem;
    }
    #btnToggleMedico {
      width: 90%;
    }
  }
</style>

</section>

<!-- ================================================= -->
<!-- üìä DASHBOARD - CIENTE IE (Vers√£o Final Integrada) -->
<!-- ================================================= -->
<section id="abaDashboard" class="aba">

  <div class="max-w-6xl mx-auto mb-8 text-center">
    <h2 class="text-2xl font-bold text-blue-800">üìä Dashboard - Ciente IE</h2>
    <p class="text-sm text-gray-500">Vis√£o integrada do Departamento M√©dico, Prontid√£o e Carga</p>
  </div>

  <!-- üè• DEPARTAMENTO M√âDICO -->
  <div class="max-w-6xl mx-auto mb-10">
    <h3 class="text-lg font-semibold text-gray-700 mb-3">üè• Departamento M√©dico</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-red-50 border-l-4 border-red-600 rounded-xl p-4 shadow">
        <h4 class="text-red-700 font-semibold mb-2">ü©π Em tratamento</h4>
        <ul id="listaTratamento" class="text-sm text-gray-800 space-y-1"></ul>
      </div>
      <div class="bg-yellow-50 border-l-4 border-yellow-400 rounded-xl p-4 shadow">
        <h4 class="text-yellow-700 font-semibold mb-2">üîÑ Em transi√ß√£o</h4>
        <ul id="listaTransicao" class="text-sm text-gray-800 space-y-1"></ul>
      </div>
    </div>
  </div>

  <!-- üß† PRONTID√ÉO - ESTADO ATUAL -->
  <div class="max-w-6xl mx-auto mb-10">
    <h3 class="text-lg font-semibold text-gray-700 mb-3">üß† Prontid√£o - Estado Atual (Hoje)</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-red-50 border-l-4 border-red-600 rounded-xl p-4 shadow">
        <h4 class="text-red-700 font-semibold mb-2">üî¥ Estado Cr√≠tico</h4>
        <ul id="listaCritico" class="text-sm text-gray-800 space-y-1"></ul>
      </div>
      <div class="bg-yellow-50 border-l-4 border-yellow-500 rounded-xl p-4 shadow">
        <h4 class="text-yellow-700 font-semibold mb-2">üü° Aten√ß√£o</h4>
        <ul id="listaAtencao" class="text-sm text-gray-800 space-y-1"></ul>
      </div>
    </div>
  </div>

<!-- ============================= -->
<!-- üìä GR√ÅFICO CARGA SEMANAL -->
<!-- ============================= -->
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6 mb-8">
  <h2 class="text-lg font-semibold text-gray-700 mb-4 text-center">üìà M√©dia de Carga por Dia (PSE x Tempo de Treino)</h2>
  <div class="h-64">
    <canvas id="graficoCargaSemanal"></canvas>
  </div>
</div>

<!-- ============================= -->
<!-- üìÖ INDICADOR DE PLANEJAMENTO -->
<!-- ============================= -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">

    <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-green-500">
        <p class="text-sm font-medium text-gray-500">Sess√µes Campo (Total)</p>
        <p class="text-3xl font-bold text-gray-900" id="cardCampo">0</p>
    </div>

    <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-yellow-500">
        <p class="text-sm font-medium text-gray-500">Sess√µes F√≠sico (Total)</p>
        <p class="text-3xl font-bold text-gray-900" id="cardFisico">0</p>
    </div>

    <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-red-500">
        <p class="text-sm font-medium text-gray-500">Jogos (Total)</p>
        <p class="text-3xl font-bold text-gray-900" id="cardJogos">0</p>
    </div>

</div>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
      const delay = setInterval(() => {
        if (window.__dadosResumo && window.__dadosCarga && window.__dadosMedico) {
          clearInterval(delay);
          carregarDashboard();
        }
      }, 1000);
    });

    // =====================================================
    // üîπ Fun√ß√£o principal
    // =====================================================
    function carregarDashboard() {
      renderDM();
      renderProntidao();
      renderGraficosCarga();
    }

    // =====================================================
    // üè• DEPARTAMENTO M√âDICO
    // =====================================================
    function renderDM() {
      const dados = window.__dadosMedico || [];
      if (!dados.length) {
        document.getElementById("listaTratamento").innerHTML = `<li class='text-gray-500 italic'>Nenhum atleta em tratamento</li>`;
        document.getElementById("listaTransicao").innerHTML = `<li class='text-gray-500 italic'>Nenhum atleta em transi√ß√£o</li>`;
        return;
      }

      function diasAfastado(c) {
        const d1 = c.data_diagnostico ? new Date(c.data_diagnostico) : null;
        const d2 = c.liberado_em ? new Date(c.liberado_em) : new Date();
        if (!d1) return "-";
        const diff = Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));
        return diff > 0 ? `${diff} dias` : "0";
      }

      const trat = dados.filter(d => (d.status || "").toLowerCase().includes("tratamento"));
      const trans = dados.filter(d => (d.status || "").toLowerCase().includes("transi"));

      document.getElementById("listaTratamento").innerHTML = trat.length
        ? trat.map(a => `<li class="text-red-600 font-medium">‚Ä¢ ${a.atleta} ‚Äî ${a.equipe} (${diasAfastado(a)})</li>`).join("")
        : `<li class='text-gray-500 italic'>Nenhum atleta em tratamento</li>`;

      document.getElementById("listaTransicao").innerHTML = trans.length
        ? trans.map(a => `<li class="text-yellow-600 font-medium">‚Ä¢ ${a.atleta} ‚Äî ${a.equipe} (${diasAfastado(a)})</li>`).join("")
        : `<li class='text-gray-500 italic'>Nenhum atleta em transi√ß√£o</li>`;
    }

    // =====================================================
// üß† PRONTID√ÉO - ESTADO ATUAL (vers√£o revisada e validada)
// =====================================================
function renderProntidao() {
  const hojeISO = new Date().toISOString().split("T")[0];

  // Filtra apenas atletas com data de hoje (robusto)
  const dados = (window.__dadosResumo || []).filter(d => {
    if (!d.data) return false;
    const dataStr = String(d.data).slice(0, 10);
    return dataStr === hojeISO;
  });

  if (!dados.length) {
    document.getElementById("listaCritico").innerHTML = `<li class='text-gray-500 italic'>Nenhum atleta cr√≠tico</li>`;
    document.getElementById("listaAtencao").innerHTML = `<li class='text-gray-500 italic'>Nenhum atleta em aten√ß√£o</li>`;
    return;
  }

  // Convers√£o segura de n√∫mero
  const toNum = v => parseFloat(String(v).replace("%", "").replace(",", ".").trim()) || 0;

  const critico = [];
  const atencao = [];

  dados.forEach(d => {
    // Captura o campo de IGP real (aceita v√°rias varia√ß√µes)
    const igp = toNum(d.igpPct || d.igp_pct || d.IGP || 0);
    const hooper = toNum(d.hooper || d.hooper_score || 0);

    // üî¥ Cr√≠tico = IGP < -10
    if (igp < -10) {
      critico.push(d);
    }
    // üü° Aten√ß√£o = IGP entre -10 e -5 ou Hooper 12‚Äì17
    else if ((igp >= -10 && igp < -5) || (hooper >= 12 && hooper <= 17)) {
      atencao.push(d);
    }
  });

  // Renderiza√ß√£o final
  document.getElementById("listaCritico").innerHTML = critico.length
    ? critico.map(d => `
      <li>‚Ä¢ ${d.atleta || d.nome || "-"} ‚Äî ${d.equipe || "-"} (${String(d.data).slice(0,10)})</li>
    `).join("")
    : `<li class='text-gray-500 italic'>Nenhum atleta cr√≠tico</li>`;

  document.getElementById("listaAtencao").innerHTML = atencao.length
    ? atencao.map(d => `
      <li>‚Ä¢ ${d.atleta || d.nome || "-"} ‚Äî ${d.equipe || "-"} (${String(d.data).slice(0,10)})</li>
    `).join("")
    : `<li class='text-gray-500 italic'>Nenhum atleta em aten√ß√£o</li>`;
}

    // =====================================================
    // üèãÔ∏è‚Äç‚ôÇÔ∏è CARGA - CAMPOS AJUSTADOS
    // =====================================================
    function renderGraficosCarga() {
      const dados = window.__dadosCarga || [];
      if (!dados.length) return;

      const dias = ["Seg", "Ter", "Qua", "Qui", "Sex", "S√°b", "Dom"];
      const semanaAtual = {};
      dias.forEach(d => semanaAtual[d] = []);

      const hoje = new Date();
      const diaSemana = (hoje.getDay() + 6) % 7;
      const segunda = new Date(hoje);
      segunda.setDate(hoje.getDate() - diaSemana);
      const domingo = new Date(segunda);
      domingo.setDate(segunda.getDate() + 6);
      const inicio = segunda.toISOString().split("T")[0];
      const fim = domingo.toISOString().split("T")[0];

      const daSemana = dados.filter(d => d.data >= inicio && d.data <= fim);
      daSemana.forEach(d => {
        const data = new Date(d.data + "T00:00:00");
        const nomeDia = dias[(data.getDay() + 6) % 7];
        const carga = (
          parseFloat(d.pse || d.pse_sessao || 0) *
          parseFloat(d.tempo || d.duracao_sessao_min || 0)
        ) || 0;
        if (semanaAtual[nomeDia]) semanaAtual[nomeDia].push(carga);
      });

      const mediasDia = dias.map(d => {
        const arr = semanaAtual[d];
        return arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
      });

      new Chart(document.getElementById("graficoCargaDiaria"), {
        type: "bar",
        data: {
          labels: dias,
          datasets: [{
            label: "Carga m√©dia di√°ria",
            data: mediasDia,
            backgroundColor: "#3b82f6",
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { display: false } }
        }
      });

      const semanas = {};
      dados.forEach(d => {
        const data = new Date(d.data + "T00:00:00");
        const semana = getNumeroSemana(data);
        const carga = (
          parseFloat(d.pse || d.pse_sessao || 0) *
          parseFloat(d.tempo || d.duracao_sessao_min || 0)
        ) || 0;
        if (!semanas[semana]) semanas[semana] = [];
        semanas[semana].push(carga);
      });

      const labels = Object.keys(semanas).slice(-6).map(s => "S" + s);
      const mediasSem = Object.values(semanas).slice(-6).map(arr => arr.reduce((a,b)=>a+b,0)/arr.length);

      new Chart(document.getElementById("graficoCargaSemanas"), {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Carga m√©dia semanal",
            data: mediasSem,
            borderColor: "#10b981",
            backgroundColor: "#10b98133",
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { display: false } }
        }
      });
    }

    function getNumeroSemana(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
  </script>
<script type="module">
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
const db = getFirestore();

// ===============================
// üìà Gr√°fico de M√©dia de Carga por DIA (Cor Condicional e S√≥lida)
// ===============================
async function gerarGraficoCargaSemanal() {
  try {
    const snap = await getDocs(collection(db, "carga"));
    const dados = snap.docs.map(d => d.data());

    if (!dados.length) {
      console.log("Nenhum dado de carga encontrado.");
      return; 
    }

    // 1. L√ìGICA DE AGRUPAMENTO: Por DIA
    const dias = {};
    dados.forEach(d => {
      if (d.data) {
        const key = d.data;
        if (!dias[key]) dias[key] = [];
        dias[key].push(d);
      }
    });

    // 2. C√ÅLCULO: M√©dia DI√ÅRIA de carga
    const labels = Object.keys(dias).sort((a, b) => new Date(a) - new Date(b)); 
    
    const medias = labels.map(s => {
      const dia = dias[s];
      
      const total = dia.reduce((sum, x) => {
        const pse = Number(x.pse) || 0;
        const tempo = Number(x.tempo) || 0;
        return sum + (pse * tempo);
      }, 0);
      
      return dia.length > 0 ? total / dia.length : 0; 
    });

    // 3. L√ìGICA DE COR CONDICIONAL
    const backgroundColors = medias.map(media => {
      if (media < 600) {
        return "#3B82F6"; // Azul: Tailwind blue-500
      } else if (media >= 600 && media <= 799) {
        return "#F59E0B"; // Laranja: Tailwind amber-500
      } else { // media >= 800
        return "#EF4444"; // Vermelho: Tailwind red-500
      }
    });


    // 4. RENDERIZA√á√ÉO DO GR√ÅFICO (Tipo BARRA)
    const ctx = document.getElementById("graficoCargaSemanal").getContext("2d");
    
    if (window.cargaChart) {
      window.cargaChart.destroy();
    }
    
    window.cargaChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "Carga M√©dia por Sess√£o no Dia",
          data: medias,
          // *** NOVO: Aplica o array de cores ***
          backgroundColor: backgroundColors, 
          // *** NOVO: Garante cor s√≥lida e borda correspondente ***
          borderColor: backgroundColors, 
          borderWidth: 1,
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: "Carga M√©dia Di√°ria (u.a.)" }
          },
          x: {
              type: 'category', 
              title: { display: true, text: "Data" },
              ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                  autoSkip: true,
              },
              grid: { display: false }
          }
        },
        plugins: {
          legend: { display: false },
          title: { display: false }
        }
      }
    });
  } catch (error) {
    console.error("Erro ao gerar gr√°fico de carga:", error);
  }
}

// ===============================
// üóìÔ∏è Indicadores de Planejamento (Contadores Individuais e Totais)
// ===============================
async function gerarIndicadoresPlanejamento() {
  const snap = await getDocs(collection(db, "planejamento"));
  const dados = snap.docs.map(d => d.data());
  
  if (!dados.length) return;

  // Usa TODOS os dados para a contagem total acumulada.
  const dadosTotais = dados; 

  // 1. Contagem das Sess√µes
  const sessoesCampo = dadosTotais.filter(d => d.tipo === "Campo").length;
  const sessoesFisico = dadosTotais.filter(d => d.tipo === "F√≠sico").length;
  
  // 2. Contagem de Jogos
  const jogos = dadosTotais.filter(d => 
    Array.isArray(d.objetivo_principal) && 
    d.objetivo_principal.some(o => o.includes("Jogo"))
  ).length;

  // 3. ATUALIZA√á√ÉO DOS NOVOS CARDS (com checagem de exist√™ncia)
  
  // Contador 1: SESS√ïES CAMPO
  const cardCampoElement = document.getElementById("cardCampo");
  if (cardCampoElement) {
    cardCampoElement.textContent = sessoesCampo;
  }
  
  // Contador 2: SESS√ïES F√çSICO
  const cardFisicoElement = document.getElementById("cardFisico");
  if (cardFisicoElement) {
    cardFisicoElement.textContent = sessoesFisico;
  }

  // Contador 3: JOGOS
  const cardJogosElement = document.getElementById("cardJogos");
  if (cardJogosElement) {
    cardJogosElement.textContent = jogos;
  }
}

// ===============================
// üöÄ Inicializa√ß√£o no Dashboard
// ===============================
document.addEventListener("DOMContentLoaded", async () => {
  await gerarGraficoCargaSemanal();
  await gerarIndicadoresPlanejamento();
});
</script>


</section>

</body>
</html>
