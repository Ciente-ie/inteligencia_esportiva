<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento Integrado de Atletas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .details-section { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .details-section.open { max-height: 1000px; }
        .tab-btn.active { border-color: #3b82f6; color: #3b82f6; background-color: #eff6ff; }
        .carga-leve { border-color: #3b82f6; } .carga-moderada { border-color: #f59e0b; } .carga-alta { border-color: #f97316; } .carga-maxima { border-color: #ef4444; }
        select[multiple] { height: 100px; padding: 8px; }
        select[multiple] option:checked { background-color: #3b82f6; color: white; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen">

    <div id="globalLoader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm">
        <div class="loader" style="width: 50px; height: 50px;"></div>
        <p id="loaderText" class="mt-4 text-gray-600 font-semibold">Conectando...</p>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl flex-grow hidden" id="mainContent">
         <header class="text-center mb-8">
             <div class="flex justify-center items-center gap-4 mb-4">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Monitoramento Integrado de Atletas</h1>
                 <div class="flex items-center gap-x-4">
                     <div id="authStatusContainer" class="bg-gray-100 p-2 rounded-lg text-sm">
                        <span id="authStatus"></span>
                    </div>
                </div>
            </div>
             <div class="flex justify-center items-center gap-x-4 bg-gray-100 p-2 rounded-lg max-w-md mx-auto border">
                <label for="teamSelector" class="font-semibold text-gray-700">Equipe:</label>
                <select id="teamSelector" class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Carregando equipes...</option>
                </select>
            </div>
           <p class="text-gray-600 mt-4 text-lg">Analise a prontidão, controle a carga, planeje os treinos e monitore lesões da sua equipe.</p>
       </header>

        <div class="mb-8">
            <div class="flex border-b border-gray-200 flex-wrap">
                <button id="tabDashboardBtn" class="tab-btn active text-lg font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                    Dashboard Geral
                </button>
                <button id="tabProntidaoBtn" class="tab-btn text-lg font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                    Análise de Prontidão
                </button>
                <button id="tabCargaBtn" class="tab-btn text-lg font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                    Controle de Carga
                </button>
                <button id="tabPlanejamentoBtn" class="tab-btn text-lg font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                    Planejamento
                </button>
                <button id="tabLesoesBtn" class="tab-btn text-lg font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                    Lesões
                </button>
            </div>
        </div>

        <div id="dashboardContent">
            <div class="space-y-10" id="pdf-content-dashboard">
                <div id="dashboardLesoes" class="bg-white p-6 rounded-2xl shadow-md border border-gray-200"></div>
                <div id="dashboardProntidao" class="bg-white p-6 rounded-2xl shadow-md border border-gray-200"></div>
                <div id="dashboardCarga" class="bg-white p-6 rounded-2xl shadow-md border border-gray-200"></div>
                <div id="dashboardPlanejamento" class="bg-white p-6 rounded-2xl shadow-md border border-gray-200"></div>
            </div>
             <div class="text-center mt-8">
                <button id="exportPdfBtnDashboard" class="btn bg-red-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-red-700 transition flex items-center mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path></svg>
                    Exportar Dashboard como PDF
                </button>
            </div>
        </div>

        <div id="prontidaoContent" class="hidden">
             <div class="bg-white p-6 md:p-8 rounded-2xl shadow-md border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-3">1. Prepare seu arquivo de Prontidão</h2>
                        <p class="text-gray-600 mb-4">O arquivo CSV deve ter a coluna `equipe_id` no início.</p>
                        <div class="bg-gray-100 p-4 rounded-lg text-sm text-gray-700 font-mono border">
                            <p><strong class="text-blue-600">equipe_id</strong>,atleta_id,data,semana_id,...</p>
                        </div>
                    </div>
                    <div class="mt-6 md:mt-0">
                        <h2 class="text-xl font-semibold text-gray-800 mb-3">2. Importe o arquivo</h2>
                        <div class="flex flex-col items-center justify-center w-full">
                             <label for="csvFileInput" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-10 h-10 mb-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                    <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Clique para carregar</span> ou arraste</p>
                                    <p class="text-xs text-gray-500">Arquivo de Prontidão (.CSV)</p>
                                </div>
                                <input id="csvFileInput" type="file" class="hidden" accept=".csv" />
                            </label>
                            <p id="fileName" class="mt-2 text-sm text-gray-500"></p>
                        </div>
                        <button id="processBtn" class="btn mt-4 w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center justify-center text-lg" disabled>
                            <span id="btnText">Processar e Salvar Prontidão</span>
                            <div id="btnLoader" class="loader hidden ml-3"></div>
                        </button>
                    </div>
                </div>
            </div>
            <div id="resultsSection" class="mt-10 hidden">
                <div id="pdf-content-prontidao">
                    <div id="filterContainerProntidao" class="mb-6"></div>
                    <div id="teamDashboard" class="mb-8"></div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Resultados Individuais de Prontidão</h2>
                         <div class="flex gap-x-2">
                             <button id="clearProntidaoDataBtn" class="btn bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 transition flex items-center text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                Limpar Dados de Prontidão
                            </button>
                            <button id="exportPdfBtnProntidao" class="btn bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                                Exportar PDF
                            </button>
                         </div>
                    </div>
                    <div id="resultsContainer" class="bg-white rounded-lg shadow-md border overflow-hidden"></div>
                    <div id="legendsProntidao" class="mt-6 text-xs text-gray-500 grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                </div>
            </div>
            <div id="placeholderSectionProntidao" class="mt-10 text-center py-16 px-6 bg-white rounded-lg shadow-md border">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <h3 class="mt-4 text-xl font-semibold text-gray-800">Aguardando dados de Prontidão</h3>
                <p class="mt-1 text-gray-500">Os dados salvos serão carregados automaticamente ou importe um novo arquivo.</p>
            </div>
        </div>

        <div id="cargaContent" class="hidden">
           <div class="bg-white p-6 md:p-8 rounded-2xl shadow-md border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-3">1. Prepare seu arquivo de Carga</h2>
                        <p class="text-gray-600 mb-4">O arquivo CSV deve ter a coluna `equipe_id` no início.</p>
                        <div class="bg-gray-100 p-4 rounded-lg text-sm text-gray-700 font-mono border">
                            <p><strong class="text-blue-600">equipe_id</strong>,atleta_id,data,microciclo_id,...</p>
                        </div>
                    </div>
                    <div class="mt-6 md:mt-0">
                        <h2 class="text-xl font-semibold text-gray-800 mb-3">2. Importe o arquivo e analise</h2>
                         <div class="flex flex-col items-center justify-center w-full">
                             <label for="csvFileInputCarga" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-10 h-10 mb-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                    <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Clique para carregar</span> ou arraste</p>
                                    <p class="text-xs text-gray-500">Arquivo de Carga (.CSV)</p>
                                </div>
                                <input id="csvFileInputCarga" type="file" class="hidden" accept=".csv" />
                            </label>
                            <p id="fileNameCarga" class="mt-2 text-sm text-gray-500"></p>
                        </div>
                        <button id="processBtnCarga" class="btn mt-4 w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center justify-center text-lg" disabled>
                            <span id="btnTextCarga">Processar e Salvar Carga</span>
                            <div id="btnLoaderCarga" class="loader hidden ml-3"></div>
                        </button>
                    </div>
                </div>
            </div>
            <div id="resultsSectionCarga" class="mt-10 hidden">
                 <div id="pdf-content-carga">
                    <div id="filterContainer" class="mb-6"></div>
                    <div id="teamDashboardCarga" class="mb-8"></div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Resultados Individuais de Carga</h2>
                         <div class="flex gap-x-2">
                            <button id="clearCargaDataBtn" class="btn bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 transition flex items-center text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                Limpar Dados de Carga
                            </button>
                            <button id="exportPdfBtnCarga" class="btn bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                                Exportar PDF
                            </button>
                         </div>
                    </div>
                    <div id="resultsContainerCarga" class="bg-white rounded-lg shadow-md border overflow-hidden"></div>
                    <div id="legendsCarga" class="mt-6 text-xs text-gray-500 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                </div>
            </div>
             <div id="placeholderSectionCarga" class="mt-10 text-center py-16 px-6 bg-white rounded-lg shadow-md border">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <h3 class="mt-4 text-xl font-semibold text-gray-800">Aguardando dados de Carga</h3>
                <p class="mt-1 text-gray-500">Os dados salvos serão carregados automaticamente ou importe um novo arquivo.</p>
            </div>
        </div>

        <div id="planejamentoContent" class="hidden">
           </div>
        
        <div id="lesoesContent" class="hidden">
            </div>
    </div>

    <footer class="text-center py-4 text-xs text-gray-400">
        Powered by Ciente - Inteligência Esportiva
    </footer>

    <div id="toast" class="fixed bottom-5 right-5 bg-red-500 text-white py-3 px-6 rounded-lg shadow-xl opacity-0 transition-all duration-300 transform translate-y-10"></div>
    
    <div id="confirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
      </div>

    <script type="module">
        // --- Firebase v9+ modular imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp, writeBatch, getDocs, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCSxaH-QFQbhrCttS-J8KmVN1MXmjXqY1s",
            authDomain: "meu-scout-pro.firebaseapp.com",
            projectId: "meu-scout-pro",
            storageBucket: "meu-scout-pro.appspot.com",
            messagingSenderId: "303977649743",
            appId: "1:303977649743:web:4e81e55c7180390ec97c3a"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Coleções Globais ---
        const prontidaoCollection = collection(db, 'prontidaoData');
        const cargaCollection = collection(db, 'cargaData');
        const treinosFisicosCollection = collection(db, 'treinosFisicos');
        const treinosCampoCollection = collection(db, 'treinosCampo');
        const lesoesCollection = collection(db, 'lesoes');

        // --- Variáveis de Estado Globais ---
        let currentTeamId = null;
        let unsubscribeListeners = [];
        
        let fullProntidaoData = [], fullCargaData = [], lesoesData = [], treinosFisicos = [], treinosCampo = [];
        let athleteMicrocycleData = {}, latestProntidaoData = null, latestCargaData = null;
        let selectedPlanningWeeks = [getWeekId(new Date())];
        let activeCharts = {}, currentUser = null, isInitialLoadComplete = false, toastTimeout = null;

        const METRIC_NAMES = {
            qualidade_sono: 'Qualidade do Sono', niveis_stress: 'Níveis de Stress', fadiga_geral: 'Fadiga Geral',
            dor_muscular: 'Dor Muscular', hooper_score: 'Pontuação Hooper', salto_horizontal_cm: 'Salto Horizontal', vfc_rmssd: 'VFC (RMSSD)'
        };

        // --- Referências de DOM ---
        const globalLoader = document.getElementById('globalLoader');
        const loaderText = document.getElementById('loaderText');
        const mainContent = document.getElementById('mainContent');
        const teamSelector = document.getElementById('teamSelector');
        // Adicione outras referências de DOM aqui conforme necessário
        
        // --- Inicialização ---
        signInAnonymously(auth).catch(error => {
            console.error("Falha no login anônimo", error);
            loaderText.textContent = "Erro de autenticação. Verifique as configurações do Firebase.";
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authStatus').textContent = 'Conectado';
                if (!isInitialLoadComplete) {
                    isInitialLoadComplete = true;
                    initializeTeamSelectorAndLoadData();
                }
            }
        });

        teamSelector.addEventListener('change', (e) => {
            const newTeamId = e.target.value;
            if (newTeamId && newTeamId !== currentTeamId) {
                currentTeamId = newTeamId;
                localStorage.setItem('selectedTeamId', currentTeamId);
                loadDataForTeam(currentTeamId);
            }
        });

        async function initializeTeamSelectorAndLoadData() {
            loaderText.textContent = 'Verificando equipes...';
            try {
                const prontidaoRef = collection(db, "prontidaoData");
                const snapshot = await getDocs(prontidaoRef);
                const teamIds = new Set();
                snapshot.docs.forEach(doc => {
                    if (doc.data().equipe_id) {
                        teamIds.add(doc.data().equipe_id);
                    }
                });

                const teams = Array.from(teamIds).sort();
                teamSelector.innerHTML = '';

                if (teams.length === 0) {
                    teamSelector.innerHTML = '<option value="">Importe um CSV com equipe_id para começar</option>';
                    clearAllUI();
                } else {
                    teams.forEach(teamId => {
                        const option = document.createElement('option');
                        option.value = teamId;
                        option.textContent = teamId;
                        teamSelector.appendChild(option);
                    });
                    
                    const lastSelected = localStorage.getItem('selectedTeamId');
                    currentTeamId = (lastSelected && teams.includes(lastSelected)) ? lastSelected : teams[0];
                    teamSelector.value = currentTeamId;
                    
                    await loadDataForTeam(currentTeamId);
                }
            } catch (error) {
                console.error("Erro ao descobrir equipes:", error);
                loaderText.textContent = "Erro ao ler dados. Verifique as regras do Firestore.";
            } finally {
                globalLoader.classList.add('hidden');
                mainContent.classList.remove('hidden');
            }
        }
        
        function setupLiveListenersForTeam(teamId) {
            clearAllData();
            
            const queries = {
                prontidao: query(prontidaoCollection, where("equipe_id", "==", teamId)),
                carga: query(cargaCollection, where("equipe_id", "==", teamId)),
                treinosFisicos: query(treinosFisicosCollection, where("equipe_id", "==", teamId)),
                treinosCampo: query(treinosCampoCollection, where("equipe_id", "==", teamId)),
                lesoes: query(lesoesCollection, where("equipe_id", "==", teamId)),
            };

            const unsubProntidao = onSnapshot(queries.prontidao, snapshot => {
                fullProntidaoData = snapshot.docs.map(d => ({...d.data(), id: d.id}));
                renderProntidaoTab();
                updateDashboardView();
            });
            // ... adicione listeners para as outras coleções da mesma forma ...
            unsubscribeListeners.push(unsubProntidao);
        }

        async function loadDataForTeam(teamId) {
            if (!teamId) {
                clearAllUI();
                return;
            }
            loaderText.textContent = `Carregando dados para ${teamId}...`;
            globalLoader.classList.remove('hidden');
            mainContent.classList.add('hidden');
            
            setupLiveListenersForTeam(teamId);

            // A chamada a renderAllTabs() será acionada pelos listeners
            // Apenas para garantir a primeira renderização
            setTimeout(() => {
                globalLoader.classList.add('hidden');
                mainContent.classList.remove('hidden');
            }, 1500); // Um pequeno delay para os listeners carregarem
        }

        function clearAllData() {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            fullProntidaoData = []; fullCargaData = []; lesoesData = []; treinosFisicos = []; treinosCampo = [];
        }

        function clearAllUI() {
            clearAllData();
            // Limpa todos os containers de resultados e dashboards
            document.getElementById('resultsContainer').innerHTML = '';
            // ... limpe outros containers ...
        }

        function parseCSV(text, requiredHeaders) {
            const lines = text.trim().replace(/\r/g, '').split('\n');
            if (lines.length < 2) throw new Error("O arquivo CSV está vazio ou contém apenas o cabeçalho.");

            const firstLine = lines[0];
            const separator = firstLine.includes(';') ? ';' : ',';
            const headers = firstLine.split(separator).map(h => h.trim().toLowerCase()).filter(h => h);
            
            if (!headers.includes('equipe_id')) {
                throw new Error("CSV inválido. A coluna 'equipe_id' é obrigatória.");
            }
            const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
            if (missingHeaders.length > 0) {
                throw new Error(`Cabeçalho inválido. Colunas ausentes: ${missingHeaders.join(', ')}.`);
            }

            return lines.slice(1).map((line, i) => {
                if (line.trim() === '') return null;
                const values = line.split(separator);
                const entry = {};
                headers.forEach((header, index) => {
                    const value = values[index] ? values[index].trim() : null;
                    if (['equipe_id', 'atleta_id', 'data', 'microciclo_id', 'semana_id'].includes(header)) {
                         if (header === 'data' && value && /^\d{2}\/\d{2}\/\d{4}$/.test(value)) {
                            const parts = value.split('/');
                            entry[header] = `${parts[2]}-${parts[1]}-${parts[0]}`; 
                        } else {
                            entry[header] = value;
                        }
                    } else {
                        const sanitizedValue = value ? value.replace(',', '.') : null;
                        entry[header] = sanitizedValue && !isNaN(parseFloat(sanitizedValue)) ? parseFloat(sanitizedValue) : null;
                    }
                });
                if (!entry.equipe_id || !entry.atleta_id || !entry.data) {
                    console.warn(`Linha ${i + 2} ignorada por falta de equipe_id, atleta_id ou data.`);
                    return null;
                };
                return entry;
            }).filter(Boolean);
        }

        // Adicione aqui TODAS as outras funções da ferramenta (handleFileProcessing, renderProntidaoTab, etc.)
        // A lógica delas não precisa mudar, pois elas operarão nos arrays globais que já estarão filtrados pelos listeners.

    </script>
</body>
</html>
