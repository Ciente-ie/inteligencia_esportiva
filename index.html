<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ciente IE – Plataforma Integrada</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            cienteazul: '#2563eb',
            cienteverde: '#16a34a',
            cienteamarelo: '#facc15',
            cinza: '#f3f4f6'
          }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase (v11 compatível com módulo) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, getDocs, doc, deleteDoc, 
      orderBy, query, enableNetwork 
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

    /* =============================
       🔹 CONFIGURAÇÃO FIREBASE
    ============================== */
    const firebaseConfig = {
      apiKey: "AIzaSyDsoutLk5gmxq5zlu548HWFrox37u1zrxk",
      authDomain: "appintegrado-ciente.firebaseapp.com",
      projectId: "appintegrado-ciente",
      storageBucket: "appintegrado-ciente.appspot.com",
      messagingSenderId: "487559108410",
      appId: "1:487559108410:web:08868011454e609ee52203"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // 🔒 Autenticação anônima (permite leitura e gravação)
    signInAnonymously(auth)
      .then(() => console.log("✅ Autenticado anonimamente"))
      .catch(err => console.error("Erro de autenticação:", err));

    // 🌐 Corrige bloqueio no GitHub Pages (HTTPS)
    try {
      await enableNetwork(db);
      console.log("🌍 Conexão Firestore ativada com sucesso!");
    } catch (e) {
      console.error("⚠️ Erro ao ativar rede do Firestore:", e);
    }

    /* =============================
       🔹 ESTRUTURA VISUAL
    ============================== */
    document.addEventListener("DOMContentLoaded", () => {
      document.body.innerHTML = `
      <header class="bg-cienteazul text-white py-4 shadow-lg">
        <div class="max-w-6xl mx-auto flex justify-between items-center px-4">
          <h1 class="text-lg font-semibold">Ciente IE – Plataforma Integrada</h1>
          <nav class="flex gap-2">
            <button data-tab="dashboard" class="nav-btn active">Dashboard</button>
            <button data-tab="prontidao" class="nav-btn">Prontidão</button>
            <button data-tab="carga" class="nav-btn">Carga</button>
            <button data-tab="planejamento" class="nav-btn">Planejamento</button>
            <button data-tab="lesoes" class="nav-btn">Lesões</button>
          </nav>
        </div>
      </header>

      <main class="max-w-6xl mx-auto p-6">
        <section id="dashboard" class="tab active">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Resumo Geral</h2>
          <div id="dashboard-content"></div>
        </section>

        <section id="prontidao" class="tab hidden">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Monitoramento de Prontidão</h2>
          <div id="prontidao-content"></div>
        </section>

        <section id="carga" class="tab hidden">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Carga de Treinamento</h2>
          <div id="carga-content"></div>
        </section>

        <section id="planejamento" class="tab hidden">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Planejamento Semanal</h2>
          <div id="planejamento-content"></div>
        </section>

        <section id="lesoes" class="tab hidden">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Controle de Lesões</h2>
          <div id="lesoes-content"></div>
        </section>
      </main>

      <footer class="text-center text-gray-500 py-4 text-sm">
        Powered by <strong>Ciente Inteligência Esportiva</strong>
      </footer>
      `;
    });
    /* =============================
       🔹 NAVEGAÇÃO ENTRE ABAS
    ============================== */
    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("nav-btn")) {
        document.querySelectorAll(".nav-btn").forEach(btn => btn.classList.remove("active"));
        document.querySelectorAll(".tab").forEach(tab => tab.classList.add("hidden"));
        e.target.classList.add("active");
        const targetTab = e.target.getAttribute("data-tab");
        document.getElementById(targetTab).classList.remove("hidden");
        if (targetTab === "dashboard") carregarDashboard();
        if (targetTab === "prontidao") carregarProntidao();
        if (targetTab === "carga") carregarCarga();
        if (targetTab === "planejamento") carregarPlanejamento();
        if (targetTab === "lesoes") carregarLesoes();
      }
    });

    /* =============================
       🔹 DASHBOARD INICIAL
    ============================== */
    async function carregarDashboard() {
      const dash = document.getElementById("dashboard-content");
      dash.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-white p-4 rounded-xl shadow text-center">
            <h3 class="text-sm text-gray-500">Hooper Médio</h3>
            <p id="cardHooper" class="text-3xl font-bold text-blue-600">--</p>
          </div>
          <div class="bg-white p-4 rounded-xl shadow text-center">
            <h3 class="text-sm text-gray-500">HRV Médio</h3>
            <p id="cardHRV" class="text-3xl font-bold text-green-600">--</p>
          </div>
          <div class="bg-white p-4 rounded-xl shadow text-center">
            <h3 class="text-sm text-gray-500">Prontidão Muscular</h3>
            <p id="cardMuscular" class="text-3xl font-bold text-yellow-500">--</p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-4 rounded-xl shadow">
            <h3 class="font-semibold text-gray-700 mb-2">Tendência de Prontidão</h3>
            <canvas id="graficoProntidao"></canvas>
          </div>
          <div class="bg-white p-4 rounded-xl shadow">
            <h3 class="font-semibold text-gray-700 mb-2">Evolução da Carga Semanal</h3>
            <canvas id="graficoCarga"></canvas>
          </div>
        </div>
      `;

      const prontidaoSnap = await getDocs(query(collection(db, "prontidao"), orderBy("data", "asc")));
      const cargaSnap = await getDocs(query(collection(db, "carga"), orderBy("data", "asc")));
      const prontidao = prontidaoSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      const carga = cargaSnap.docs.map(d => ({ id: d.id, ...d.data() }));

      const datas = [];
      const hooperVals = [];
      const hrvVals = [];
      const muscVals = [];

      prontidao.forEach(d => {
        if (d.data && d.data.seconds) {
          datas.push(new Date(d.data.seconds * 1000).toLocaleDateString("pt-BR"));
        } else datas.push(d.data || "");
        hooperVals.push(parseFloat(d.hooper) || 0);
        hrvVals.push(parseFloat(d.hrv) || 0);
        muscVals.push(parseFloat(d.prontidao_muscular) || 0);
      });

      const media = arr => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : "--";
      document.getElementById("cardHooper").textContent = media(hooperVals);
      document.getElementById("cardHRV").textContent = media(hrvVals);
      document.getElementById("cardMuscular").textContent = media(muscVals);

      // Gráfico Prontidão
      const ctx = document.getElementById("graficoProntidao").getContext("2d");
      if (window.grafProntidao) window.grafProntidao.destroy();
      window.grafProntidao = new Chart(ctx, {
        type: "line",
        data: {
          labels: datas,
          datasets: [
            { label: "Hooper", data: hooperVals, borderColor: "#2563eb", fill: false },
            { label: "HRV", data: hrvVals, borderColor: "#22c55e", fill: false },
            { label: "Prontidão Muscular", data: muscVals, borderColor: "#facc15", fill: false }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } },
          scales: { y: { beginAtZero: true, max: 10 } }
        }
      });

      // Gráfico Carga
      const ctx2 = document.getElementById("graficoCarga").getContext("2d");
      if (window.grafCarga) window.grafCarga.destroy();

      const datasC = [];
      const pseVals = [];
      const acwrVals = [];
      carga.forEach(d => {
        if (d.data && d.data.seconds) {
          datasC.push(new Date(d.data.seconds * 1000).toLocaleDateString("pt-BR"));
        } else datasC.push(d.data || "");
        pseVals.push(parseFloat(d.pse) || 0);
        acwrVals.push(parseFloat(d.acwr) || 0);
      });

      window.grafCarga = new Chart(ctx2, {
        type: "bar",
        data: {
          labels: datasC,
          datasets: [
            { label: "PSE", data: pseVals, backgroundColor: "#3b82f6" },
            { label: "ACWR", data: acwrVals, backgroundColor: "#f59e0b" }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }
    /* =============================
       🔹 ABA PRONTIDÃO
    ============================== */
    async function carregarProntidao() {
      const container = document.getElementById("prontidao-content");
      container.innerHTML = `
        <button id="btnAtualizarPront" class="bg-cienteazul text-white px-4 py-2 rounded hover:bg-blue-700 mb-4">
          🔄 Atualizar Dados
        </button>
        <div id="tabelaProntidao" class="overflow-x-auto"></div>
      `;

      document.getElementById("btnAtualizarPront").addEventListener("click", carregarTabelaProntidao);
      await carregarTabelaProntidao();
    }

    async function carregarTabelaProntidao() {
      const tabela = document.getElementById("tabelaProntidao");
      tabela.innerHTML = `<p class="text-gray-500">Carregando dados...</p>`;

      try {
        const snap = await getDocs(query(collection(db, "prontidao"), orderBy("data", "desc")));
        const dados = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (!dados.length) {
          tabela.innerHTML = `<p class="text-gray-500 mt-3">Nenhum registro encontrado.</p>`;
          return;
        }

        let html = `
          <table class="min-w-full bg-white rounded-xl shadow text-sm">
            <thead class="bg-gray-100 text-gray-700">
              <tr>
                <th class="px-3 py-2 border">Equipe</th>
                <th class="px-3 py-2 border">Atleta</th>
                <th class="px-3 py-2 border">Data</th>
                <th class="px-3 py-2 border">Hooper</th>
                <th class="px-3 py-2 border">HRV</th>
                <th class="px-3 py-2 border">Prontidão Muscular</th>
              </tr>
            </thead>
            <tbody>
        `;

        dados.forEach(d => {
          const dataFormatada = d.data && d.data.seconds
            ? new Date(d.data.seconds * 1000).toLocaleDateString("pt-BR")
            : (d.data || "");

          html += `
            <tr class="hover:bg-gray-50">
              <td class="border px-3 py-2">${d.equipe ?? d.equipe_id ?? ""}</td>
              <td class="border px-3 py-2">${d.nome_atleta ?? d.atleta ?? ""}</td>
              <td class="border px-3 py-2">${dataFormatada}</td>
              <td class="border px-3 py-2 text-center">${d.hooper ?? ""}</td>
              <td class="border px-3 py-2 text-center">${d.hrv ?? ""}</td>
              <td class="border px-3 py-2 text-center">${d.prontidao_muscular ?? d.prontidao ?? ""}</td>
            </tr>
          `;
        });

        html += `</tbody></table>`;
        tabela.innerHTML = html;
      } catch (e) {
        console.error("Erro ao carregar prontidão:", e);
        tabela.innerHTML = `<p class="text-red-500">Erro ao carregar dados.</p>`;
      }
    }
    /* =============================
       🔹 ABA CARGA
    ============================== */
    async function carregarCarga() {
      const container = document.getElementById("carga-content");
      container.innerHTML = `
        <button id="btnAtualizarCarga" class="bg-cienteazul text-white px-4 py-2 rounded hover:bg-blue-700 mb-4">
          🔄 Atualizar Dados
        </button>
        <div id="tabelaCarga" class="overflow-x-auto"></div>
      `;

      document.getElementById("btnAtualizarCarga").addEventListener("click", carregarTabelaCarga);
      await carregarTabelaCarga();
    }

    async function carregarTabelaCarga() {
      const tabela = document.getElementById("tabelaCarga");
      tabela.innerHTML = `<p class="text-gray-500">Carregando dados...</p>`;

      try {
        const snap = await getDocs(query(collection(db, "carga"), orderBy("data", "desc")));
        const dados = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (!dados.length) {
          tabela.innerHTML = `<p class="text-gray-500 mt-3">Nenhum registro encontrado.</p>`;
          return;
        }

        let html = `
          <table class="min-w-full bg-white rounded-xl shadow text-sm">
            <thead class="bg-gray-100 text-gray-700">
              <tr>
                <th class="px-3 py-2 border">Equipe</th>
                <th class="px-3 py-2 border">Atleta</th>
                <th class="px-3 py-2 border">Data</th>
                <th class="px-3 py-2 border">PSE</th>
                <th class="px-3 py-2 border">Tempo (min)</th>
                <th class="px-3 py-2 border">ACWR</th>
              </tr>
            </thead>
            <tbody>
        `;

        dados.forEach(d => {
          const dataFormatada = d.data && d.data.seconds
            ? new Date(d.data.seconds * 1000).toLocaleDateString("pt-BR")
            : (d.data || "");

          html += `
            <tr class="hover:bg-gray-50">
              <td class="border px-3 py-2">${d.equipe ?? ""}</td>
              <td class="border px-3 py-2">${d.nome_atleta ?? d.atleta ?? ""}</td>
              <td class="border px-3 py-2">${dataFormatada}</td>
              <td class="border px-3 py-2 text-center">${d.pse ?? ""}</td>
              <td class="border px-3 py-2 text-center">${d.tempo ?? ""}</td>
              <td class="border px-3 py-2 text-center">${d.acwr ?? ""}</td>
            </tr>
          `;
        });

        html += `</tbody></table>`;
        tabela.innerHTML = html;
      } catch (e) {
        console.error("Erro ao carregar carga:", e);
        tabela.innerHTML = `<p class="text-red-500">Erro ao carregar dados.</p>`;
      }
    }
    /* =============================
       🔹 ABA PLANEJAMENTO
    ============================== */
    async function carregarPlanejamento() {
      const container = document.getElementById("planejamento-content");
      container.innerHTML = `
        <div class="flex justify-between mb-4">
          <button id="btnAtualizarPlanejamento" class="bg-cienteazul text-white px-4 py-2 rounded hover:bg-blue-700">
            🔄 Atualizar Planejamento
          </button>
          <button id="btnExcluirSemana" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
            🗑 Excluir Semana
          </button>
        </div>
        <div id="conteudoPlanejamento"></div>
        <div class="bg-white mt-6 rounded-xl shadow p-4">
          <h3 class="font-semibold text-blue-700 mb-2">Adicionar Novo Treino</h3>
          <div class="flex flex-wrap gap-2">
            <input id="tipoTreino" class="border p-2 rounded w-32" placeholder="Físico/Campo">
            <input id="semanaTreino" class="border p-2 rounded w-24" placeholder="Semana">
            <input id="dataTreino" type="date" class="border p-2 rounded w-40">
            <input id="descTreino" class="border p-2 rounded flex-1" placeholder="Descrição do treino">
            <button id="btnSalvarTreino" class="bg-cienteazul text-white px-4 py-2 rounded hover:bg-blue-700">Salvar</button>
          </div>
        </div>
      `;

      document.getElementById("btnAtualizarPlanejamento").addEventListener("click", carregarTabelasPlanejamento);
      document.getElementById("btnSalvarTreino").addEventListener("click", adicionarTreino);
      document.getElementById("btnExcluirSemana").addEventListener("click", excluirSemana);
      await carregarTabelasPlanejamento();
    }

    async function carregarTabelasPlanejamento() {
      const conteudo = document.getElementById("conteudoPlanejamento");
      conteudo.innerHTML = `<p class="text-gray-500">Carregando treinos...</p>`;

      try {
        const fisicoSnap = await getDocs(query(collection(db, "treinosFisicos"), orderBy("data", "desc")));
        const campoSnap = await getDocs(query(collection(db, "treinosCampo"), orderBy("data", "desc")));
        const fisicos = fisicoSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        const campos = campoSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        let html = `
          <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow p-4">
              <h3 class="font-semibold text-blue-700 mb-2">Treinos Físicos</h3>
              <table class="min-w-full text-sm">
                <thead><tr class="bg-gray-100">
                  <th class="p-2 border">Semana</th>
                  <th class="p-2 border">Data</th>
                  <th class="p-2 border">Descrição</th>
                  <th class="p-2 border text-center">🗑</th>
                </tr></thead><tbody>
        `;
        fisicos.forEach(t => {
          const dataFormatada = t.data && t.data.seconds ? new Date(t.data.seconds * 1000).toLocaleDateString("pt-BR") : (t.data || "");
          html += `
            <tr class="hover:bg-gray-50">
              <td class="border p-2">${t.semana || ""}</td>
              <td class="border p-2">${dataFormatada}</td>
              <td class="border p-2">${t.descricao || ""}</td>
              <td class="border p-2 text-center">
                <button class="text-red-600 font-bold" onclick="excluirTreino('treinosFisicos','${t.id}')">×</button>
              </td>
            </tr>
          `;
        });
        html += `</tbody></table></div>
          <div class="bg-white rounded-xl shadow p-4">
            <h3 class="font-semibold text-blue-700 mb-2">Treinos de Campo</h3>
            <table class="min-w-full text-sm">
              <thead><tr class="bg-gray-100">
                <th class="p-2 border">Semana</th>
                <th class="p-2 border">Data</th>
                <th class="p-2 border">Descrição</th>
                <th class="p-2 border text-center">🗑</th>
              </tr></thead><tbody>
        `;
        campos.forEach(t => {
          const dataFormatada = t.data && t.data.seconds ? new Date(t.data.seconds * 1000).toLocaleDateString("pt-BR") : (t.data || "");
          html += `
            <tr class="hover:bg-gray-50">
              <td class="border p-2">${t.semana || ""}</td>
              <td class="border p-2">${dataFormatada}</td>
              <td class="border p-2">${t.descricao || ""}</td>
              <td class="border p-2 text-center">
                <button class="text-red-600 font-bold" onclick="excluirTreino('treinosCampo','${t.id}')">×</button>
              </td>
            </tr>
          `;
        });
        html += `</tbody></table></div></div>`;
        conteudo.innerHTML = html;
      } catch (e) {
        console.error("Erro ao carregar planejamento:", e);
        conteudo.innerHTML = `<p class="text-red-500">Erro ao carregar dados.</p>`;
      }
    }

    async function adicionarTreino() {
      const tipo = document.getElementById("tipoTreino").value.trim().toLowerCase();
      const semana = document.getElementById("semanaTreino").value.trim();
      const data = document.getElementById("dataTreino").value.trim();
      const desc = document.getElementById("descTreino").value.trim();

      if (!tipo || !semana || !data || !desc) {
        alert("Preencha todos os campos!");
        return;
      }

      const treino = { semana, data, descricao: desc, criado_em: new Date() };
      const colecao = tipo.startsWith("f") ? "treinosFisicos" : "treinosCampo";

      try {
        await addDoc(collection(db, colecao), treino);
        alert("✅ Treino adicionado!");
        carregarTabelasPlanejamento();
      } catch (e) {
        console.error("Erro ao adicionar treino:", e);
        alert("❌ Erro ao adicionar treino.");
      }
    }

    async function excluirTreino(col, id) {
      if (!confirm("Excluir treino?")) return;
      try {
        await deleteDoc(doc(db, col, id));
        carregarTabelasPlanejamento();
      } catch (e) {
        console.error("Erro ao excluir treino:", e);
      }
    }

    async function excluirSemana() {
      const semana = prompt("Digite o número da semana para excluir:");
      if (!semana) return;

      for (const col of ["treinosFisicos", "treinosCampo"]) {
        const snap = await getDocs(collection(db, col));
        const deletar = snap.docs.filter(d => d.data().semana == semana);
        for (const d of deletar) await deleteDoc(doc(db, col, d.id));
      }
      alert("🗑 Semana excluída!");
      carregarTabelasPlanejamento();
    }
    /* =============================
       🔹 ABA LESÕES
    ============================== */
    async function carregarLesoes() {
      const container = document.getElementById("lesoes-content");
      container.innerHTML = `
        <div class="flex justify-between mb-4">
          <button id="btnAtualizarLesoes" class="bg-cienteazul text-white px-4 py-2 rounded hover:bg-blue-700">
            🔄 Atualizar Lesões
          </button>
        </div>
        <div id="conteudoLesoes" class="mb-6"></div>

        <div class="bg-white mt-4 rounded-xl shadow p-4">
          <h3 class="font-semibold text-blue-700 mb-2">Adicionar Lesão</h3>
          <div class="flex flex-wrap gap-2">
            <input id="nomeLesao" class="border p-2 rounded w-48" placeholder="Nome do atleta">
            <input id="equipeLesao" class="border p-2 rounded w-40" placeholder="Equipe">
            <input id="tipoLesao" class="border p-2 rounded w-36" placeholder="Tipo">
            <input id="dataLesao" type="date" class="border p-2 rounded w-36">
            <input id="descLesao" class="border p-2 rounded flex-1" placeholder="Descrição da lesão">
            <button id="btnSalvarLesao" class="bg-cienteazul text-white px-4 py-2 rounded hover:bg-blue-700">Salvar</button>
          </div>
        </div>
      `;

      document.getElementById("btnAtualizarLesoes").addEventListener("click", carregarTabelaLesoes);
      document.getElementById("btnSalvarLesao").addEventListener("click", adicionarLesao);
      await carregarTabelaLesoes();
    }

    async function carregarTabelaLesoes() {
      const tabela = document.getElementById("conteudoLesoes");
      tabela.innerHTML = `<p class="text-gray-500">Carregando dados...</p>`;

      try {
        const snap = await getDocs(query(collection(db, "lesoes"), orderBy("data", "desc")));
        const dados = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (!dados.length) {
          tabela.innerHTML = `<p class="text-gray-500 mt-3">Nenhuma lesão registrada.</p>`;
          return;
        }

        let html = `
          <table class="min-w-full bg-white rounded-xl shadow text-sm">
            <thead class="bg-gray-100 text-gray-700">
              <tr>
                <th class="px-3 py-2 border">Atleta</th>
                <th class="px-3 py-2 border">Equipe</th>
                <th class="px-3 py-2 border">Tipo</th>
                <th class="px-3 py-2 border">Data</th>
                <th class="px-3 py-2 border">Descrição</th>
                <th class="px-3 py-2 border text-center">🗑</th>
              </tr>
            </thead>
            <tbody>
        `;

        dados.forEach(l => {
          const dataFormatada = l.data && l.data.seconds
            ? new Date(l.data.seconds * 1000).toLocaleDateString("pt-BR")
            : (l.data || "");
          html += `
            <tr class="hover:bg-gray-50">
              <td class="border px-3 py-2">${l.atleta || ""}</td>
              <td class="border px-3 py-2">${l.equipe || ""}</td>
              <td class="border px-3 py-2">${l.tipo || ""}</td>
              <td class="border px-3 py-2">${dataFormatada}</td>
              <td class="border px-3 py-2">${l.descricao || ""}</td>
              <td class="border px-3 py-2 text-center">
                <button class="text-red-600 font-bold" onclick="excluirLesao('${l.id}')">×</button>
              </td>
            </tr>
          `;
        });

        html += `</tbody></table>`;
        tabela.innerHTML = html;
      } catch (e) {
        console.error("Erro ao carregar lesões:", e);
        tabela.innerHTML = `<p class="text-red-500">Erro ao carregar dados.</p>`;
      }
    }

    async function adicionarLesao() {
      const atleta = document.getElementById("nomeLesao").value.trim();
      const equipe = document.getElementById("equipeLesao").value.trim();
      const tipo = document.getElementById("tipoLesao").value.trim();
      const data = document.getElementById("dataLesao").value.trim();
      const descricao = document.getElementById("descLesao").value.trim();

      if (!atleta || !equipe || !tipo || !data || !descricao) {
        alert("Preencha todos os campos!");
        return;
      }

      const lesao = { atleta, equipe, tipo, data, descricao, criado_em: new Date() };

      try {
        await addDoc(collection(db, "lesoes"), lesao);
        alert("✅ Lesão registrada!");
        carregarTabelaLesoes();
      } catch (e) {
        console.error("Erro ao adicionar lesão:", e);
        alert("❌ Erro ao salvar lesão.");
      }
    }

    async function excluirLesao(id) {
      if (!confirm("Excluir lesão?")) return;
      try {
        await deleteDoc(doc(db, "lesoes", id));
        carregarTabelaLesoes();
      } catch (e) {
        console.error("Erro ao excluir lesão:", e);
      }
    }
    /* =============================
       🔹 INICIALIZAÇÃO AUTOMÁTICA
    ============================== */
    async function inicializarPlataforma() {
      console.log("🚀 Iniciando Ciente IE – Plataforma Integrada...");
      try {
        // Força ativação da rede (necessário no GitHub Pages)
        await enableNetwork(db);
        console.log("🌐 Conexão Firestore ativada");

        // Garante login anônimo
        await signInAnonymously(auth);

        // Carrega dashboard inicial
        await carregarDashboard();
        console.log("✅ Dashboard carregado");

        // Configura evento de abas (já registrado na Parte 2)
        document.querySelector('[data-tab="dashboard"]').classList.add("active");
        document.getElementById("dashboard").classList.remove("hidden");

      } catch (e) {
        console.error("❌ Erro na inicialização:", e);
        alert("Erro ao conectar ao Firebase. Verifique sua internet.");
      }
    }

    // Espera DOM carregar completamente
    document.addEventListener("DOMContentLoaded", async () => {
      await inicializarPlataforma();
    });

    /* =============================
       🔹 FUNÇÕES AUXILIARES GERAIS
    ============================== */
    function formatarDataFirestore(timestamp) {
      if (!timestamp) return "";
      if (timestamp.seconds) {
        return new Date(timestamp.seconds * 1000).toLocaleDateString("pt-BR");
      }
      return timestamp;
    }

    function mostrarMensagem(msg, tipo = "info") {
      const cor = tipo === "erro" ? "text-red-600" : tipo === "sucesso" ? "text-green-600" : "text-blue-600";
      const el = document.createElement("p");
      el.className = `${cor} text-sm font-medium mt-2`;
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 4000);
    }
    /* =============================
       🔹 FILTROS DE EQUIPE E ATLETA
    ============================== */
    async function carregarFiltrosDashboard() {
      const snap = await getDocs(collection(db, "prontidao"));
      const dados = snap.docs.map(d => ({ ...d.data() }));

      const equipes = [...new Set(dados.map(d => d.equipe || d.equipe_id || "").filter(Boolean))];
      const atletas = [...new Set(dados.map(d => d.nome_atleta || d.atleta || "").filter(Boolean))];

      const filtrosHTML = `
        <div class="bg-white rounded-xl shadow p-4 mb-6 flex flex-wrap gap-4 items-center">
          <div>
            <label class="text-sm text-gray-600 block mb-1">Equipe</label>
            <select id="filtroEquipe" class="border rounded p-2 w-44">
              <option value="">Todas</option>
              ${equipes.map(eq => `<option value="${eq}">${eq}</option>`).join("")}
            </select>
          </div>
          <div>
            <label class="text-sm text-gray-600 block mb-1">Atleta</label>
            <select id="filtroAtleta" class="border rounded p-2 w-52">
              <option value="">Todos</option>
              ${atletas.map(at => `<option value="${at}">${at}</option>`).join("")}
            </select>
          </div>
          <button id="btnFiltrar" class="bg-cienteazul text-white px-4 py-2 rounded hover:bg-blue-700 transition">
            🔍 Aplicar Filtro
          </button>
        </div>
      `;

      const dashboard = document.getElementById("dashboard-content");
      dashboard.insertAdjacentHTML("afterbegin", filtrosHTML);
      document.getElementById("btnFiltrar").addEventListener("click", aplicarFiltroDashboard);
    }

    /* =============================
       🔹 FUNÇÃO DE APLICAÇÃO DO FILTRO
    ============================== */
    async function aplicarFiltroDashboard() {
      const eq = document.getElementById("filtroEquipe").value;
      const at = document.getElementById("filtroAtleta").value;

      let queryP = collection(db, "prontidao");
      let queryC = collection(db, "carga");

      // 🔍 Filtros condicionais
      if (eq && at) {
        queryP = query(queryP, where("equipe", "==", eq), where("nome_atleta", "==", at));
        queryC = query(queryC, where("equipe", "==", eq), where("nome_atleta", "==", at));
      } else if (eq) {
        queryP = query(queryP, where("equipe", "==", eq));
        queryC = query(queryC, where("equipe", "==", eq));
      } else if (at) {
        queryP = query(queryP, where("nome_atleta", "==", at));
        queryC = query(queryC, where("nome_atleta", "==", at));
      } else {
        queryP = query(queryP, orderBy("data", "asc"));
        queryC = query(queryC, orderBy("data", "asc"));
      }

      const prontidaoSnap = await getDocs(queryP);
      const cargaSnap = await getDocs(queryC);

      const prontidao = prontidaoSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      const carga = cargaSnap.docs.map(d => ({ id: d.id, ...d.data() }));

      // 📊 Atualiza gráficos e médias
      atualizarDashboardComFiltro(prontidao, carga);
    }

    /* =============================
       🔹 ATUALIZAÇÃO DO DASHBOARD FILTRADO
    ============================== */
    function atualizarDashboardComFiltro(prontidao, carga) {
      const datas = [];
      const hooperVals = [];
      const hrvVals = [];
      const muscVals = [];

      prontidao.forEach(d => {
        if (d.data && d.data.seconds)
          datas.push(new Date(d.data.seconds * 1000).toLocaleDateString("pt-BR"));
        else datas.push(d.data || "");
        hooperVals.push(parseFloat(d.hooper) || 0);
        hrvVals.push(parseFloat(d.hrv) || 0);
        muscVals.push(parseFloat(d.prontidao_muscular) || 0);
      });

      const media = arr => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : "--";
      document.getElementById("cardHooper").textContent = media(hooperVals);
      document.getElementById("cardHRV").textContent = media(hrvVals);
      document.getElementById("cardMuscular").textContent = media(muscVals);

      // Atualiza gráfico de prontidão
      if (window.grafProntidao) {
        window.grafProntidao.data.labels = datas;
        window.grafProntidao.data.datasets[0].data = hooperVals;
        window.grafProntidao.data.datasets[1].data = hrvVals;
        window.grafProntidao.data.datasets[2].data = muscVals;
        window.grafProntidao.update();
      }

      // Atualiza gráfico de carga
      const datasC = [];
      const pseVals = [];
      const acwrVals = [];

      carga.forEach(d => {
        if (d.data && d.data.seconds)
          datasC.push(new Date(d.data.seconds * 1000).toLocaleDateString("pt-BR"));
        else datasC.push(d.data || "");
        pseVals.push(parseFloat(d.pse) || 0);
        acwrVals.push(parseFloat(d.acwr) || 0);
      });

      if (window.grafCarga) {
        window.grafCarga.data.labels = datasC;
        window.grafCarga.data.datasets[0].data = pseVals;
        window.grafCarga.data.datasets[1].data = acwrVals;
        window.grafCarga.update();
      }
    }
    /* =============================
       🔹 INTEGRAÇÃO FINAL DOS FILTROS
    ============================== */
    async function inicializarPlataforma() {
      console.log("🚀 Iniciando Ciente IE – Plataforma Integrada...");
      try {
        // Ativa rede Firestore (importante para HTTPS no GitHub Pages)
        await enableNetwork(db);
        console.log("🌐 Firestore conectado com sucesso");

        // Login anônimo para permitir acesso
        await signInAnonymously(auth);

        // Carrega Dashboard principal
        await carregarDashboard();

        // Carrega filtros (equipes e atletas)
        await carregarFiltrosDashboard();

        // Define aba inicial ativa
        document.querySelectorAll(".tab").forEach(tab => tab.classList.add("hidden"));
        document.getElementById("dashboard").classList.remove("hidden");
        document.querySelectorAll(".nav-btn").forEach(btn => btn.classList.remove("active"));
        document.querySelector('[data-tab="dashboard"]').classList.add("active");

        console.log("✅ Dashboard e filtros carregados com sucesso");
      } catch (e) {
        console.error("❌ Erro na inicialização da plataforma:", e);
        alert("Erro ao conectar ao Firebase. Verifique sua internet.");
      }
    }

    // Força inicialização após o DOM estar pronto
    document.addEventListener("DOMContentLoaded", async () => {
      await inicializarPlataforma();
    });

    /* =============================
       🔹 AJUSTES VISUAIS GERAIS
    ============================== */
    const style = document.createElement("style");
    style.textContent = `
      .nav-btn {
        @apply px-3 py-1 rounded text-sm font-medium hover:bg-blue-700 transition;
      }
      .nav-btn.active {
        background-color: #1e3a8a;
      }
      .tab.hidden { display: none; }
      table th, table td { text-align: left; }
    `;
    document.head.appendChild(style);
    /* =============================
       🔹 OTIMIZAÇÕES FINAIS
    ============================== */
    window.addEventListener("load", () => {
      console.log("🌟 Plataforma Ciente IE carregada com sucesso!");
      document.body.classList.add("bg-gray-50");
    });

    // Evita travamentos em redes lentas
    window.addEventListener("offline", () => {
      mostrarMensagem("Sem conexão. Os dados podem não atualizar.", "erro");
    });

    window.addEventListener("online", () => {
      mostrarMensagem("Conexão restaurada!", "sucesso");
      try { enableNetwork(db); } catch {}
    });

    // Fallback visual em caso de erro
    window.onerror = (msg, src, line, col, err) => {
      console.error("Erro global detectado:", msg);
      mostrarMensagem("Ocorreu um erro inesperado.", "erro");
    };

  </script>
</head>

<body class="bg-gray-100 min-h-screen">
</body>
</html>
